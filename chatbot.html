<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chatbot t∆∞ v·∫•n qu√°n ƒÉn Vi·ªát Nam (HN/HP/ƒêN/Hu·∫ø/CT/HCM)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --bg:#faf9f7; --text:#141518; --muted:#6e7380; --border:#e6e6e8; --surface:#fff; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.6 'Inter',system-ui}
.container{max-width:920px;margin:0 auto;padding:24px 16px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.header{padding:16px;text-align:center;font-weight:700;font-size:20px}
.chat{padding:14px;max-height:66vh;overflow:auto;scroll-behavior:smooth}
.row{display:flex;gap:10px;margin:10px 0}
.bot .bubble{background:#f1f5f9}
.user{justify-content:flex-end}
.user .bubble{background:#1a5cff;color:#fff}
.bubble{padding:10px 12px;border-radius:12px;max-width:80%}
.input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
input[type="text"]{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font:500 16px/1 'Inter'}
button{padding:12px 16px;border:0;border-radius:10px;font-weight:700;background:#2eb872;color:#fff;cursor:pointer}
button:active{transform:scale(.98)}
.hint{color:var(--muted);font-size:14px;margin:4px 0 0}
.typing{display:inline-block;min-width:28px}
.typing::after{content:"";display:inline-block;width:4px;height:4px;margin-left:6px;border-radius:50%;background:#888;box-shadow:8px 0 0 #888,16px 0 0 #888;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:.2}50%{opacity:1}}
.small{font-size:13px;color:#6e7380}
.badge{display:inline-block;background:#edf7f1;color:#1e7b4e;border:1px solid #cfe9d9;border-radius:999px;padding:4px 8px;font-size:12px;font-weight:700}
.mini-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px;margin-top:8px}
.mini{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
.mini h4{margin:0 0 6px;font-size:15px}
.mini p{margin:0;color:#6e7380;font-size:13px}
.mini .actions{display:flex;gap:8px;margin-top:10px}
.btn{display:inline-block;background:#1a5cff;color:#fff;border-radius:999px;padding:8px 10px;font-weight:700;font-size:13px;border:0;cursor:pointer}
.btn.secondary{background:#e9edf5;color:#1a2a5c}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">ü§ñ Chatbot t∆∞ v·∫•n qu√°n ƒÉn (Multi-city)</div>
    <div id="chat" class="chat" aria-live="polite"></div>
    <div class="input">
      <input id="q" type="text" placeholder="B·∫°n mu·ªën ƒÉn g√¨? V√≠ d·ª•: 'B√∫n c√° cay ·ªü H·∫£i Ph√≤ng, tr∆∞a nay, ~35k/b√°t'"/>
      <button id="send">G·ª≠i</button>
    </div>
  </div>
  <p class="hint">G·ª£i √Ω: ‚ÄúM√¨ Qu·∫£ng ·ªü ƒê√† N·∫µng, t·ªëi nay, ng√¢n s√°ch 30‚Äì50k.‚Äù</p>
</div>

<script>
const chat = document.getElementById('chat');
const q    = document.getElementById('q');
const btn  = document.getElementById('send');

// ==================== helpers ====================
function addBubble(html, who='bot'){
  const row = document.createElement('div');
  row.className = 'row ' + (who === 'user' ? 'user' : 'bot');
  row.innerHTML = `<div class="bubble">${html}</div>`;
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
  return row.querySelector('.bubble');
}
const esc = s => s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const rmAcc = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

// ==================== data ====================
// Schema: city, dish, name, area, address, price_min, price_max, hours (0..6 => [ [HH:MM, HH:MM], ... ]), why, href, tags
// D·ªØ li·ªáu tr√≠ch t·ª´ file chatbot.pdf do b·∫°n cung c·∫•p.
const PLACES = [
  // ===== H√Ä N·ªòI =====
  {city:'H√† N·ªôi', dish:'pho', name:'Ph·ªü 10 L√Ω Qu·ªëc S∆∞', area:'H√†ng Tr·ªëng, Ho√†n Ki·∫øm', address:'10 P. L√Ω Qu·ªëc S∆∞, H√†ng Tr·ªëng, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['06:00','22:00']],1:[['06:00','22:00']],2:[['06:00','22:00']],3:[['06:00','22:00']],4:[['06:00','22:00']],5:[['06:00','22:00']],6:[['06:00','22:00']]}, price_min:70000, price_max:100000, why:'N∆∞·ªõc d√πng trong, v·ªã b√≤ chu·∫©n ph·ªë c·ªï', href:'#', tags:['ph·ªü b√≤','ph·ªë c·ªï']},
  {city:'H√† N·ªôi', dish:'pho', name:'Ph·ªü g√† Nguy·ªát', area:'H√†ng Tr·ªëng, Ho√†n Ki·∫øm', address:'5B P. Ph·ªß Do√£n, H√†ng Tr·ªëng, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['06:30','13:00'],['16:30','00:30']],1:[['06:30','13:00'],['16:30','00:30']],2:[['06:30','13:00'],['16:30','00:30']],3:[['06:30','13:00'],['16:30','00:30']],4:[['06:30','13:00'],['16:30','00:30']],5:[['06:30','13:00'],['16:30','00:30']],6:[['06:30','13:00'],['16:30','00:30']]}, price_min:55000, price_max:120000, why:'Ph·ªü g√† ƒë·∫≠m ƒë√†, m·ªü t·ªëi khuya', href:'#', tags:['ph·ªü g√†']},
  {city:'H√† N·ªôi', dish:'pho', name:'Ph·ªü Kh√¥i H√≥i', area:'Ph·ªë c·ªï, Ho√†n Ki·∫øm', address:'50 P. H√†ng V·∫£i, Ph·ªë c·ªï, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['06:00','21:00']],1:[['06:00','21:00']],2:[['06:00','21:00']],3:[['06:00','21:00']],4:[['06:00','21:00']],5:[['06:00','21:00']],6:[['06:00','21:00']]}, price_min:45000, price_max:75000, why:'Qu√°n ƒë·ªãa ph∆∞∆°ng gi√° m·ªÅm', href:'#', tags:['ph·ªü b√≤']},

  {city:'H√† N·ªôi', dish:'buncha', name:'B√∫n ch·∫£ 74 H√†ng Qu·∫°t', area:'Ph·ªë c·ªï, Ho√†n Ki·∫øm', address:'74 P. H√†ng Qu·∫°t, Ph·ªë c·ªï, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['10:00','14:00']],1:[['10:00','14:00']],2:[['10:00','14:00']],3:[['10:00','14:00']],4:[['10:00','14:00']],5:[['10:00','14:00']],6:[['10:00','14:00']]}, price_min:40000, price_max:50000, why:'Th·ªãt n∆∞·ªõng th∆°m l·ª≠a than, rau t∆∞∆°i', href:'#', tags:['b√∫n ch·∫£']},
  {city:'H√† N·ªôi', dish:'buncha', name:'B√∫n Th·ªãt N∆∞·ªõng B√† H·∫±ng B√©o', area:'√î Ch·ª£ D·ª´a, ƒê·ªëng ƒêa', address:'60 P. √î Ch·ª£ D·ª´a, ƒê·ªëng ƒêa, H√† N·ªôi', hours:{0:[['10:00','17:00']],1:[['10:00','17:00']],2:[['10:00','17:00']],3:[['10:00','17:00']],4:[['10:00','17:00']],5:[['10:00','17:00']],6:[['10:00','17:00']]}, price_min:40000, price_max:50000, why:'Th·ªãt n∆∞·ªõng ƒë·∫ßy ƒë·∫∑n, v·ªã h√†i h√≤a', href:'#', tags:['b√∫n ch·∫£']},
  {city:'H√† N·ªôi', dish:'buncha', name:'B√∫n ch·∫£ H∆∞∆°ng Li√™n', area:'Phan Chu Trinh, Hai B√† Tr∆∞ng', address:'24 P. L√™ VƒÉn H∆∞u, Hai B√† Tr∆∞ng, H√† N·ªôi', hours:{0:[['08:00','20:00']],1:[['08:00','20:00']],2:[['08:00','20:00']],3:[['08:00','20:00']],4:[['08:00','20:00']],5:[['08:00','20:00']],6:[['08:00','20:00']]}, price_min:60000, price_max:60000, why:'N·ªïi ti·∫øng (Obama), nem cua b·ªÉ gi√≤n', href:'#', tags:['b√∫n ch·∫£','n·ªïi ti·∫øng']},

  {city:'H√† N·ªôi', dish:'chaca', name:'Ch·∫£ C√° H√†ng S∆°n', area:'Tr√†ng Ti·ªÅn, Ho√†n Ki·∫øm', address:'24 P. T√¥ng ƒê·∫£n, Tr√†ng Ti·ªÅn, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['10:30','14:00'],['17:30','22:00']],1:[['10:30','14:00'],['17:30','22:00']],2:[['10:30','14:00'],['17:30','22:00']],3:[['10:30','14:00'],['17:30','22:00']],4:[['10:30','14:00'],['17:30','22:00']],5:[['10:30','14:00'],['17:30','22:00']],6:[['10:30','14:00'],['17:30','22:00']]}, price_min:465000, price_max:2095000, why:'Combo 1‚Äì5 ƒëa d·∫°ng', href:'#', tags:['ch·∫£ c√°','combo']},
  {city:'H√† N·ªôi', dish:'chaca', name:'Ch·∫£ C√° Phan', area:'Nguy·ªÖn Du, Hai B√† Tr∆∞ng', address:'14 Ph·ªë Nguy·ªÖn B·ªânh Khi√™m, Nguy·ªÖn Du, Hai B√† Tr∆∞ng, H√† N·ªôi', hours:{0:[['11:00','21:30']],1:[['11:00','21:30']],2:[['11:00','21:30']],3:[['11:00','21:30']],4:[['11:00','21:30']],5:[['11:00','21:30']],6:[['11:00','21:30']]}, price_min:100000, price_max:200000, why:'M·∫Øm t√¥m pha kh√©o, gi√° h·ª£p l√Ω', href:'#', tags:['ch·∫£ c√°']},
  {city:'H√† N·ªôi', dish:'chaca', name:'Ch·∫£ c√° ThƒÉng Long', area:'C·ª≠a ƒê√¥ng, Ho√†n Ki·∫øm', address:'6B P. ƒê∆∞·ªùng Th√†nh, C·ª≠a ƒê√¥ng, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['09:00','23:00']],1:[['09:00','23:00']],2:[['09:00','23:00']],3:[['09:00','23:00']],4:[['09:00','23:00']],5:[['09:00','23:00']],6:[['09:00','23:00']]}, price_min:176000, price_max:176000, why:'C√° d√†y th·ªãt, ch·∫£o n√≥ng x√®o x√®o', href:'#', tags:['ch·∫£ c√°']},

  // ===== H·∫¢I PH√íNG =====
  {city:'H·∫£i Ph√≤ng', dish:'nemcuabe', name:'Nem Cua B·ªÉ Thu·∫≠n Y·∫øn', area:'Ng√¥ Quy·ªÅn', address:'179 C·∫ßu ƒê·∫•t, Ng√¥ Quy·ªÅn, H·∫£i Ph√≤ng', hours:{0:[['10:00','21:00']],1:[['10:00','21:00']],2:[['10:00','21:00']],3:[['10:00','21:00']],4:[['10:00','21:00']],5:[['10:00','21:00']],6:[['10:00','21:00']]}, price_min:35000, price_max:85000, why:'Nem cua b·ªÉ gi√≤n, set h·ª£p l√Ω', href:'#', tags:['nem cua b·ªÉ']},
  {city:'H·∫£i Ph√≤ng', dish:'nemcuabe', name:'B√∫n ch·∫£ Nem Cua Tuy·∫øt Loan', area:'Ng√¥ Quy·ªÅn', address:'124 L·∫°ch Tray, Ng√¥ Quy·ªÅn, H·∫£i Ph√≤ng', hours:{0:[['10:00','21:00']],1:[['10:00','21:00']],2:[['10:00','21:00']],3:[['10:00','21:00']],4:[['10:00','21:00']],5:[['10:00','21:00']],6:[['10:00','21:00']]}, price_min:30000, price_max:60000, why:'Nem cua b·ªÉ ƒÉn k√®m b√∫n ch·∫£', href:'#', tags:['nem cua b·ªÉ','b√∫n ch·∫£']},
  {city:'H·∫£i Ph√≤ng', dish:'nemcuabe', name:'Nem Cua B·ªÉ Qu√°n Nga', area:'Ng√¥ Quy·ªÅn', address:'195 Tr·∫ßn Ph√∫, Ng√¥ Quy·ªÅn, H·∫£i Ph√≤ng', hours:{0:[['10:00','21:00']],1:[['10:00','21:00']],2:[['10:00','21:00']],3:[['10:00','21:00']],4:[['10:00','21:00']],5:[['10:00','21:00']],6:[['10:00','21:00']]}, price_min:40000, price_max:80000, why:'Nem n√≥ng, cu·ªën ƒÉn li·ªÅn', href:'#', tags:['nem cua b·ªÉ']},

  {city:'H·∫£i Ph√≤ng', dish:'nemchua', name:'Nem chua An Th·ªç', area:'An L√£o', address:'An Th·ªç, An L√£o, H·∫£i Ph√≤ng (ship to√†n qu·ªëc)', hours:{0:[['08:00','21:00']],1:[['08:00','21:00']],2:[['08:00','21:00']],3:[['08:00','21:00']],4:[['08:00','21:00']],5:[['08:00','21:00']],6:[['08:00','21:00']]}, price_min:0, price_max:0, why:'ƒê·∫∑t theo set 10‚Äì50 c√°i', href:'#', tags:['nem chua']},
  {city:'H·∫£i Ph√≤ng', dish:'nemchua', name:'Nem Chua B√† C·ª•', area:'Ch·ª£ ƒë·ªãa ph∆∞∆°ng', address:'H·∫£i Ph√≤ng', hours:{0:[['08:00','20:00']],1:[['08:00','20:00']],2:[['08:00','20:00']],3:[['08:00','20:00']],4:[['08:00','20:00']],5:[['08:00','20:00']],6:[['08:00','20:00']]}, price_min:10000, price_max:20000, why:'Nem chua d√¢n d√£, d·ªÖ t√¨m', href:'#', tags:['nem chua']},

  {city:'H·∫£i Ph√≤ng', dish:'buncacay', name:'B√∫n c√° cay 153 L√™ Lai', area:'L√™ Lai', address:'153 L√™ Lai (ng√£ t∆∞ L√™ Lai √ó L√™ Th√°nh T√¥ng), H·∫£i Ph√≤ng', hours:{0:[['06:00','12:30']],1:[['06:00','12:30']],2:[['06:00','12:30']],3:[['06:00','12:30']],4:[['06:00','12:30']],5:[['06:00','12:30']],6:[['06:00','12:30']]}, price_min:20000, price_max:30000, why:'C√° r√¥ gi√≤n/m·ªÅm, ch·∫£ c√°', href:'#', tags:['b√∫n c√° cay']},
  {city:'H·∫£i Ph√≤ng', dish:'buncacay', name:'B√∫n c√° cay C·∫≠u ƒêo√†nh', area:'Nhi·ªÅu c∆° s·ªü', address:'H·∫£i Ph√≤ng (tham kh·∫£o fanpage)', hours:{0:[['06:30','13:30'],['17:30','21:00']],1:[['06:30','13:30'],['17:30','21:00']],2:[['06:30','13:30'],['17:30','21:00']],3:[['06:30','13:30'],['17:30','21:00']],4:[['06:30','13:30'],['17:30','21:00']],5:[['06:30','13:30'],['17:30','21:00']],6:[['06:30','13:30'],['17:30','21:00']]}, price_min:35000, price_max:35000, why:'Th·∫≠p c·∫©m phong ph√∫', href:'#', tags:['b√∫n c√° cay']},

  // ===== ƒê√Ä N·∫¥NG =====
  {city:'ƒê√† N·∫µng', dish:'miquang', name:'M√¨ Qu·∫£ng B·ªát', area:'‚Äî', address:'ƒê√† N·∫µng (tham kh·∫£o)', hours:{0:[['06:00','21:00']],1:[['06:00','21:00']],2:[['06:00','21:00']],3:[['06:00','21:00']],4:[['06:00','21:00']],5:[['06:00','21:00']],6:[['06:00','21:00']]}, price_min:40000, price_max:80000, why:'Topping ƒë·ªß v·ªã', href:'#', tags:['m√¨ qu·∫£ng']},
  {city:'ƒê√† N·∫µng', dish:'miquang', name:'M√¨ Qu·∫£ng B√† L·ªØ', area:'H·∫£i Ch√¢u', address:'24 Tr·∫ßn Cao V√¢n, H·∫£i Ch√¢u, ƒê√† N·∫µng', hours:{0:[['06:00','21:00']],1:[['06:00','21:00']],2:[['06:00','21:00']],3:[['06:00','21:00']],4:[['06:00','21:00']],5:[['06:00','21:00']],6:[['06:00','21:00']]}, price_min:30000, price_max:55000, why:'M√¨ qu·∫£ng truy·ªÅn th·ªëng', href:'#', tags:['m√¨ qu·∫£ng']},

  {city:'ƒê√† N·∫µng', dish:'banhtrangthitheo', name:'B√°nh tr√°ng cu·ªën th·ªãt heo B√† H∆∞·ªùng', area:'H·∫£i Ch√¢u', address:'460 ƒê. 2 Th√°ng 9, H·∫£i Ch√¢u, ƒê√† N·∫µng', hours:{0:[['06:00','22:00']],1:[['06:00','22:00']],2:[['06:00','22:00']],3:[['06:00','22:00']],4:[['06:00','22:00']],5:[['06:00','22:00']],6:[['06:00','22:00']]}, price_min:95000, price_max:95000, why:'Rau s·ªëng phong ph√∫, th·ªãt lu·ªôc m·ªÅm', href:'#', tags:['b√°nh tr√°ng th·ªãt heo']},
  {city:'ƒê√† N·∫µng', dish:'banhtrangthitheo', name:'B√°nh tr√°ng th·ªãt heo B√† Thu', area:'Ng≈© H√†nh S∆°n', address:'103 ƒê·ªó B√°, Ng≈© H√†nh S∆°n, ƒê√† N·∫µng', hours:{0:[['10:00','21:00']],1:[['10:00','21:00']],2:[['10:00','21:00']],3:[['10:00','21:00']],4:[['10:00','21:00']],5:[['10:00','21:00']],6:[['10:00','21:00']]}, price_min:0, price_max:0, why:'Th·ªãt th∆°m, m·∫Øm n√™m ƒë·∫≠m', href:'#', tags:['b√°nh tr√°ng th·ªãt heo']},

  {city:'ƒê√† N·∫µng', dish:'caolau', name:'Cao l·∫ßu Ph·ªë H·ªôi', area:'H·∫£i Ch√¢u', address:'63 Phan ƒêƒÉng L∆∞u, H·∫£i Ch√¢u, ƒê√† N·∫µng', hours:{0:[['06:00','21:00']],1:[['06:00','21:00']],2:[['06:00','21:00']],3:[['06:00','21:00']],4:[['06:00','21:00']],5:[['06:00','21:00']],6:[['06:00','21:00']]}, price_min:0, price_max:0, why:'S·ª£i cao l·∫ßu chu·∫©n v·ªã H·ªôi An', href:'#', tags:['cao l·∫ßu']},
  {city:'ƒê√† N·∫µng', dish:'caolau', name:'Cao l·∫ßu Ph∆∞·ªõc', area:'S∆°n Tr√†', address:'18/3 Nguy·ªÖn Duy Hi·ªáu, S∆°n Tr√†, ƒê√† N·∫µng', hours:{0:[['06:00','11:00']],1:[['06:00','11:00']],2:[['06:00','11:00']],3:[['06:00','11:00']],4:[['06:00','11:00']],5:[['06:00','11:00']],6:[['06:00','11:00']]}, price_min:0, price_max:0, why:'B√°n s√°ng, nhanh h·∫øt', href:'#', tags:['cao l·∫ßu']},
  {city:'ƒê√† N·∫µng', dish:'caolau', name:'Cao l·∫ßu Kh√¥ng Gian Xanh', area:'H·ªôi An (Qu·∫£ng Nam)', address:'687 Hai B√† Tr∆∞ng, Minh An, H·ªôi An', hours:{0:[['08:00','20:30']],1:[['08:00','20:30']],2:[['08:00','20:30']],3:[['08:00','20:30']],4:[['08:00','20:30']],5:[['08:00','20:30']],6:[['08:00','20:30']]}, price_min:0, price_max:0, why:'Kh√¥ng gian ƒë·∫πp, g·∫ßn ph·ªë c·ªï', href:'#', tags:['cao l·∫ßu']},

  // ===== HU·∫æ =====
  {city:'Hu·∫ø', dish:'bunbo', name:'B√∫n B√≤ B√† Nga', area:'Ph√∫ C√°t', address:'5 Nguy·ªÖn Du, Ph√∫ C√°t, TP Hu·∫ø', hours:{0:[['06:00','20:30']],1:[['06:00','20:30']],2:[['06:00','20:30']],3:[['06:00','20:30']],4:[['06:00','20:30']],5:[['06:00','20:30']],6:[['06:00','20:30']]}, price_min:25000, price_max:45000, why:'ƒê·∫≠m v·ªã Hu·∫ø, gi√° b√¨nh d√¢n', href:'#', tags:['b√∫n b√≤ Hu·∫ø']},
  {city:'Hu·∫ø', dish:'bunbo', name:'B√∫n b√≤ Hu·∫ø M·ªπ T√¢m', area:'Vƒ©nh Ninh', address:'3 Tr·∫ßn Cao V√¢n, Vƒ©nh Ninh, TP Hu·∫ø', hours:{0:[['07:00','22:00']],1:[['07:00','22:00']],2:[['07:00','22:00']],3:[['07:00','22:00']],4:[['07:00','22:00']],5:[['07:00','22:00']],6:[['07:00','22:00']]}, price_min:30000, price_max:80000, why:'Topping ƒëa d·∫°ng', href:'#', tags:['b√∫n b√≤ Hu·∫ø']},
  {city:'Hu·∫ø', dish:'bunbo', name:'B√∫n b√≤ O Li·ªÖu', area:'Ph√∫ C√°t', address:'146 Tr·ªãnh C√¥ng S∆°n, Ph√∫ C√°t, TP Hu·∫ø', hours:{0:[['06:00','20:30']],1:[['06:00','20:30']],2:[['06:00','20:30']],3:[['06:00','20:30']],4:[['06:00','20:30']],5:[['06:00','20:30']],6:[['06:00','20:30']]}, price_min:20000, price_max:30000, why:'V·ªã truy·ªÅn th·ªëng, r·∫ª', href:'#', tags:['b√∫n b√≤ Hu·∫ø']},

  {city:'Hu·∫ø', dish:'che', name:'Ch√® C·∫ßm', area:'V·ªπ D·∫°', address:'10 Nguy·ªÖn Sinh Cung, V·ªπ D·∫°, TP Hu·∫ø', hours:{0:[['16:00','19:30']]}, price_min:15000, price_max:30000, why:'ƒê·∫∑c s·∫£n cung ƒë√¨nh: b·ªôt l·ªçc heo quay, h·∫°t sen‚Ä¶', href:'#', tags:['ch√®']},
  {city:'Hu·∫ø', dish:'che', name:'Ch√® M·ª£ T√¥n ƒê√≠ch', area:'Ph√∫ H√≤a', address:'20 ƒêinh Ti√™n Ho√†ng, Ph√∫ H√≤a, TP Hu·∫ø', hours:{0:[['15:00','21:00']]}, price_min:15000, price_max:20000, why:'Ch√® khay 12 ch√©n', href:'#', tags:['ch√®']},
  {city:'Hu·∫ø', dish:'che', name:'Ch√® √îng L·∫°c', area:'V·ªπ D·∫°', address:'36 Thanh T·ªãnh, V·ªπ D·∫°, TP Hu·∫ø', hours:{0:[['15:00','21:00']]}, price_min:15000, price_max:15000, why:'ƒê·ªìng gi√°, nhi·ªÅu lo·∫°i', href:'#', tags:['ch√®']},

  {city:'Hu·∫ø', dish:'comhen', name:'C∆°m h·∫øn Hoa ƒê√¥ng', area:'‚Äî', address:'64 Ki·ªát 7 ∆Øng B√¨nh, TP Hu·∫ø', hours:{0:[['06:00','20:00']]}, price_min:20000, price_max:20000, why:'ƒê·∫∑c bi·ªát, gi√° r·∫ª', href:'#', tags:['c∆°m h·∫øn']},
  {city:'Hu·∫ø', dish:'comhen', name:'C∆°m h·∫øn B√† Cam', area:'V·ªπ D·∫°', address:'49 T√πng Thi·ªán V∆∞∆°ng, V·ªπ D·∫°, TP Hu·∫ø', hours:{0:[['06:00','21:00']]}, price_min:15000, price_max:20000, why:'S√°ng & t·ªëi', href:'#', tags:['c∆°m h·∫øn']},
  {city:'Hu·∫ø', dish:'comhen', name:'C∆°m h·∫øn B√© Li√™m', area:'Ph√∫ H·ªôi', address:'64 Nguy·ªÖn C√¥ng Tr·ª©, Ph√∫ H·ªôi, TP Hu·∫ø', hours:{0:[['06:00','21:00']]}, price_min:15000, price_max:15000, why:'C√≥ h·∫øn x√†o +30k/n·ª≠a b√°t', href:'#', tags:['c∆°m h·∫øn']},

  // ===== TP H·ªí CH√ç MINH =====
  {city:'H·ªì Ch√≠ Minh', dish:'comtam', name:'C∆°m T·∫•m M·ªôc', area:'Ph√∫ Nhu·∫≠n', address:'ƒê·∫∑ng VƒÉn Ng·ªØ, Ph√∫ Nhu·∫≠n, TP.HCM', hours:{0:[['07:00','21:00']],1:[['07:00','21:00']],2:[['07:00','21:00']],3:[['07:00','21:00']],4:[['07:00','21:00']],5:[['07:00','21:00']],6:[['07:00','21:00']]}, price_min:35000, price_max:65000, why:'S∆∞·ªùn b√¨ ch·∫£ chu·∫©n v·ªã', href:'#', tags:['c∆°m t·∫•m']},
  {city:'H·ªì Ch√≠ Minh', dish:'comtam', name:'C∆°m T·∫•m S√† B√¨ Ch∆∞·ªüng', area:'Qu·∫≠n 1 (nhi·ªÅu CN)', address:'Nguy·ªÖn Hu·ªá, Qu·∫≠n 1, TP.HCM', hours:{0:[['07:00','22:00']],1:[['07:00','22:00']],2:[['07:00','22:00']],3:[['07:00','22:00']],4:[['07:00','22:00']],5:[['07:00','22:00']],6:[['07:00','22:00']]}, price_min:45000, price_max:85000, why:'Bi·∫øn t·∫•u vui nh·ªôn, d·ªÖ ƒÉn', href:'#', tags:['c∆°m t·∫•m']},
  {city:'H·ªì Ch√≠ Minh', dish:'comtam', name:'C∆°m t·∫•m Ph√∫c L·ªôc Th·ªç', area:'Qu·∫≠n 10', address:'144 L√Ω Th∆∞·ªùng Ki·ªát, P.14, Q.10, TP.HCM', hours:{0:[['06:00','22:00']],1:[['06:00','22:00']],2:[['06:00','22:00']],3:[['06:00','22:00']],4:[['06:00','22:00']],5:[['06:00','22:00']],6:[['06:00','22:00']]}, price_min:30000, price_max:80000, why:'Nhi·ªÅu combo khuy·∫øn m√£i', href:'#', tags:['c∆°m t·∫•m']},

  {city:'H·ªì Ch√≠ Minh', dish:'banhmi', name:'B√°nh m√¨ Huynh Hoa', area:'Qu·∫≠n 1', address:'26 L√™ Th·ªã Ri√™ng, B·∫øn Th√†nh, Q.1, TP.HCM', hours:{0:[['13:00','23:00']],1:[['13:00','23:00']],2:[['13:00','23:00']],3:[['13:00','23:00']],4:[['13:00','23:00']],5:[['13:00','23:00']],6:[['13:00','23:00']]}, price_min:73000, price_max:73000, why:'Pate & ch·∫£ ƒë·∫ßy ƒë·∫∑n', href:'#', tags:['b√°nh m√¨']},
  {city:'H·ªì Ch√≠ Minh', dish:'banhmi', name:'B√°nh m√¨ Kim Dung', area:'Qu·∫≠n 10', address:'118A L√Ω Th∆∞·ªùng Ki·ªát, P.7, Q.10, TP.HCM', hours:{0:[['05:30','01:30']],1:[['05:30','01:30']],2:[['05:30','01:30']],3:[['05:30','01:30']],4:[['05:30','01:30']],5:[['05:30','01:30']],6:[['05:30','01:30']]}, price_min:55000, price_max:55000, why:'M·ªü g·∫ßn 24h', href:'#', tags:['b√°nh m√¨']},
  {city:'H·ªì Ch√≠ Minh', dish:'banhmi', name:'B√°nh m√¨ Ho√†ng Lam', area:'Ph√∫ Nhu·∫≠n', address:'168 Nguy·ªÖn Th∆∞·ª£ng Hi·ªÅn, Ph√∫ Nhu·∫≠n, TP.HCM', hours:{0:[['06:00','18:00']],1:[['06:00','18:00']],2:[['06:00','18:00']],3:[['06:00','18:00']],4:[['06:00','18:00']],5:[['06:00','18:00']],6:[['06:00','18:00']]}, price_min:37000, price_max:40000, why:'·ªî nh·ªè, v·ªã truy·ªÅn th·ªëng', href:'#', tags:['b√°nh m√¨']},

  {city:'H·ªì Ch√≠ Minh', dish:'phalau', name:'Ph√° l·∫•u b√≤ C√¢y Tr√¢m', area:'G√≤ V·∫•p', address:'208 C√¢y Tr√¢m, P.8, G√≤ V·∫•p, TP.HCM', hours:{0:[['15:00','21:00']],1:[['15:00','21:00']],2:[['15:00','21:00']],3:[['15:00','21:00']],4:[['15:00','21:00']],5:[['15:00','21:00']],6:[['15:00','21:00']]}, price_min:30000, price_max:60000, why:'C√≥ m√¨ & b√°nh m√¨ ph√° l·∫•u', href:'#', tags:['ph√° l·∫•u']},
  {city:'H·ªì Ch√≠ Minh', dish:'phalau', name:'Ph√° l·∫•u L√¨', area:'Qu·∫≠n 1', address:'17A Nguy·ªÖn Th·ªã Minh Khai, B·∫øn Ngh√©, Q.1, TP.HCM', hours:{0:[['11:30','21:00']],1:[['11:30','21:00']],2:[['11:30','21:00']],3:[['11:30','21:00']],4:[['11:30','21:00']],5:[['11:30','21:00']],6:[['11:30','21:00']]}, price_min:60000, price_max:120000, why:'N∆∞·ªõc ph√° l·∫•u s√°nh, v·ªã b√©o', href:'#', tags:['ph√° l·∫•u']},
  {city:'H·ªì Ch√≠ Minh', dish:'phalau', name:'Ph√° l·∫•u Ng·ªçc Th·∫Øm', area:'Qu·∫≠n 3', address:'642 Nguy·ªÖn ƒê√¨nh Chi·ªÉu, P.3, Q.3, TP.HCM', hours:{0:[['11:00','23:00']],1:[['11:00','23:00']],2:[['11:00','23:00']],3:[['11:00','23:00']],4:[['11:00','23:00']],5:[['11:00','23:00']],6:[['11:00','23:00']]}, price_min:30000, price_max:90000, why:'C√≥ ph√° l·∫•u tr·ª©ng mu·ªëi', href:'#', tags:['ph√° l·∫•u']},

  // ===== C·∫¶N TH∆† =====
  {city:'C·∫ßn Th∆°', dish:'laumam', name:'L·∫©u m·∫Øm C·∫ßn Th∆°', area:'Ninh Ki·ªÅu', address:'162/18 ƒê. Tr·∫ßn Ng·ªçc Qu·∫ø, Ninh Ki·ªÅu, C·∫ßn Th∆°', hours:{0:[['09:30','22:30']],1:[['09:30','22:30']],2:[['09:30','22:30']],3:[['09:30','22:30']],4:[['09:30','22:30']],5:[['09:30','22:30']],6:[['09:30','22:30']]}, price_min:0, price_max:0, why:'ƒê·∫∑c s·∫£n mi·ªÅn T√¢y, rau nhi·ªÅu', href:'#', tags:['l·∫©u m·∫Øm']},
  {city:'C·∫ßn Th∆°', dish:'laumam', name:'L·∫©u M·∫Øm Ki·ªÅu Trinh', area:'Ninh Ki·ªÅu', address:'26 ƒê. Tr·∫ßn Kh√°nh D∆∞, Ninh Ki·ªÅu, C·∫ßn Th∆°', hours:{0:[['11:00','21:00']],1:[['11:00','21:00']],2:[['11:00','21:00']],3:[['11:00','21:00']],4:[['11:00','21:00']],5:[['11:00','21:00']],6:[['11:00','21:00']]}, price_min:0, price_max:0, why:'N∆∞·ªõc m·∫Øm ƒë·∫≠m, h·∫£i s·∫£n t∆∞∆°i', href:'#', tags:['l·∫©u m·∫Øm']},
  {city:'C·∫ßn Th∆°', dish:'laumam', name:'L·∫©u M·∫Øm Qu√™ Mi', area:'Ninh Ki·ªÅu', address:'77 ƒê. Hu·ª≥nh C∆∞∆°ng, Ninh Ki·ªÅu, C·∫ßn Th∆°', hours:{0:[['10:00','22:00']],1:[['10:00','22:00']],2:[['10:00','22:00']],3:[['10:00','22:00']],4:[['10:00','22:00']],5:[['10:00','22:00']],6:[['10:00','22:00']]}, price_min:0, price_max:0, why:'Kh√¥ng gian gia ƒë√¨nh', href:'#', tags:['l·∫©u m·∫Øm']},

  {city:'C·∫ßn Th∆°', dish:'calocnuongtrui', name:'Qu√°n C√° L√≥c An', area:'Ninh Ki·ªÅu', address:'15 ƒê. Tr·∫ßn VƒÉn Ho√†i, Ninh Ki·ªÅu, C·∫ßn Th∆°', hours:{0:[['09:30','23:30']],1:[['09:30','23:30']],2:[['09:30','23:30']],3:[['09:30','23:30']],4:[['09:30','23:30']],5:[['09:30','23:30']],6:[['09:30','23:30']]}, price_min:0, price_max:0, why:'Menu ƒëa d·∫°ng, gi√° b√¨nh d√¢n', href:'#', tags:['c√° l√≥c n∆∞·ªõng trui']},
  {city:'C·∫ßn Th∆°', dish:'calocnuongtrui', name:'ƒê·ªìng Xanh', area:'Ninh Ki·ªÅu', address:'211 ƒê. Nguy·ªÖn VƒÉn Linh, Ninh Ki·ªÅu, C·∫ßn Th∆°', hours:{0:[['08:00','03:00']],1:[['08:00','03:00']],2:[['08:00','03:00']],3:[['08:00','03:00']],4:[['08:00','03:00']],5:[['08:00','03:00']],6:[['08:00','03:00']]}, price_min:39000, price_max:39000, why:'C√° theo c√¢n, m·ªü khuya', href:'#', tags:['c√° l√≥c n∆∞·ªõng trui']},
  {city:'C·∫ßn Th∆°', dish:'calocnuongtrui', name:'C√° l√≥c n∆∞·ªõng M·∫´n', area:'Ninh Ki·ªÅu', address:'184 ƒê. Hu·ª≥nh C∆∞∆°ng, Ninh Ki·ªÅu, C·∫ßn Th∆°', hours:{0:[['06:00','23:00']],1:[['06:00','23:00']],2:[['06:00','23:00']],3:[['06:00','23:00']],4:[['06:00','23:00']],5:[['06:00','23:00']],6:[['06:00','23:00']]}, price_min:0, price_max:0, why:'Rau/b√°nh tr√°ng k√®m s·∫µn', href:'#', tags:['c√° l√≥c n∆∞·ªõng trui']},

  {city:'C·∫ßn Th∆°', dish:'vitnauchao', name:'V·ªãt N·∫•u Chao C·∫©m T√∫', area:'Ninh Ki·ªÅu', address:'1 ƒê. L√Ω T·ª± Tr·ªçng, Ninh Ki·ªÅu, C·∫ßn Th∆°', hours:{0:[['09:00','22:00']],1:[['09:00','22:00']],2:[['09:00','22:00']],3:[['09:00','22:00']],4:[['09:00','22:00']],5:[['09:00','22:00']],6:[['09:00','22:00']]}, price_min:150000, price_max:200000, why:'L·∫©u v·ªãt chao ƒë·∫≠m, gi√° h·ª£p l√Ω', href:'#', tags:['v·ªãt n·∫•u chao']},
  {city:'C·∫ßn Th∆°', dish:'vitnauchao', name:'V·ªãt n·∫•u chao C√¥ Minh', area:'Ninh Ki·ªÅu', address:'1/1C ƒê. L√Ω T·ª± Tr·ªçng, Ninh Ki·ªÅu, C·∫ßn Th∆°', hours:{0:[['08:00','23:00']],1:[['08:00','23:00']],2:[['08:00','23:00']],3:[['08:00','23:00']],4:[['08:00','23:00']],5:[['08:00','23:00']],6:[['08:00','23:00']]}, price_min:0, price_max:0, why:'Rau & n∆∞·ªõc l·∫©u refill theo l∆∞·ª£t', href:'#', tags:['v·ªãt n·∫•u chao']},
  {city:'C·∫ßn Th∆°', dish:'vitnauchao', name:'V·ªãt N·∫•u Chao Th√†nh Giao', area:'Ninh Ki·ªÅu', address:'H·∫ªm 1/8 ƒê. L√Ω T·ª± Tr·ªçng, Ninh Ki·ªÅu, C·∫ßn Th∆°', hours:{0:[['08:00','23:00']],1:[['08:00','23:00']],2:[['08:00','23:00']],3:[['08:00','23:00']],4:[['08:00','23:00']],5:[['08:00','23:00']],6:[['08:00','23:00']]}, price_min:250000, price_max:1186000, why:'ƒêa d·∫°ng size cho nh√≥m', href:'#', tags:['v·ªãt n·∫•u chao']},
];

// Kh√≥a m√≥n hi·ªÉn th·ªã ƒë·∫πp
const DISH_LABELS = {
  pho:'Ph·ªü', buncha:'B√∫n ch·∫£', chaca:'Ch·∫£ c√°',
  nemcuabe:'Nem cua b·ªÉ', nemchua:'Nem chua', buncacay:'B√∫n c√° cay',
  miquang:'M√¨ Qu·∫£ng', banhtrangthitheo:'B√°nh tr√°ng th·ªãt heo', caolau:'Cao l·∫ßu',
  bunbo:'B√∫n b√≤ Hu·∫ø', che:'Ch√® cung ƒë√¨nh', comhen:'C∆°m h·∫øn',
  comtam:'C∆°m t·∫•m', banhmi:'B√°nh m√¨', phalau:'Ph√° l·∫•u',
  laumam:'L·∫©u m·∫Øm', calocnuongtrui:'C√° l√≥c n∆∞·ªõng trui', vitnauchao:'V·ªãt n·∫•u chao'
};

// ==================== UI builders ====================
function placeCards(title, places){
  return `
    <div><strong>${title}</strong></div>
    <div class="mini-grid">
      ${places.map(p=>`
        <div class="mini">
          <h4>${p.name}</h4>
          <p>üìç ${p.area}<br>üó∫Ô∏è ${p.address}<br>üïí ${p.hoursText}<br>üí∏ ${p.priceText}</p>
          <p style="margin-top:6px">${p.why || ''}</p>
          <div class="actions">
            <a class="btn" href="${p.href}" target="_blank" rel="noopener">Xem chi ti·∫øt</a>
          </div>
        </div>`).join('')}
    </div>
    <p class="small">üí° Tip: G√µ ‚Äúm√≥n + th√†nh ph·ªë + th·ªùi gian + ng√¢n s√°ch‚Äù. V√≠ d·ª•: ‚Äúb√∫n ch·∫£ Ho√†n Ki·∫øm tr∆∞a nay 40‚Äì50k‚Äù.</p>`;
}

// ==================== parsing ====================
function parseBudgetVND(text){
  const t = rmAcc(text).replace(/\s/g,'');
  const mRange = t.match(/(\d{2,4})-?(\d{2,4})k/);
  if(mRange) return {min:+mRange[1]*1000, max:+mRange[2]*1000};
  const mSingleK = t.match(/(?:~|‚âà|tam|khoang)?(\d{2,4})k/);
  if(mSingleK){ const v=+mSingleK[1]*1000; return {min:Math.max(0,v-20000), max:v+20000}; }
  const mUnder = t.match(/(duoi|<=|‚â§|<)(\d{2,4})k/);
  if(mUnder) return {min:0, max:+mUnder[2]*1000};
  const mAbove = t.match(/(tren|>=|‚â•|>)(\d{2,4})k/);
  if(mAbove) return {min:+mAbove[2]*1000, max:1e9};
  return null;
}
function parseTime(text, now=new Date()){
  const t = rmAcc(text);
  const today = now.getDay();
  let dow = today;
  if(t.includes('ngay mai')||t.includes('mai')) dow=(today+1)%7;
  let minuteOfDay = null;
  const m = t.match(/(\d{1,2})(?:h|:)(\d{0,2})?/);
  if(m){ minuteOfDay=(+m[1])*60 + (m[2]?+m[2]:0); }
  else if(t.includes('sang')) minuteOfDay=8*60;
  else if(t.includes('trua')) minuteOfDay=12*60;
  else if(t.includes('chieu')) minuteOfDay=17*60;
  else if(t.includes('toi')||t.includes('tois')) minuteOfDay=19*60;
  return {dow, minuteOfDay};
}
function parseCity(text){
  const t = rmAcc(text);
  if(/(ha noi|hanoi|hn)/.test(t)) return 'H√† N·ªôi';
  if(/(hai phong|haiphong|hp)/.test(t)) return 'H·∫£i Ph√≤ng';
  if(/(da nang|danang|dn)/.test(t)) return 'ƒê√† N·∫µng';
  if(/(hue|thuathienhue)/.test(t)) return 'Hu·∫ø';
  if(/(can tho|cantho|ct)/.test(t)) return 'C·∫ßn Th∆°';
  if(/(ho chi minh|tphcm|hcm|sai gon|saigon)/.test(t)) return 'H·ªì Ch√≠ Minh';
  return null;
}
function parseDish(text){
  const t = rmAcc(text);
  if(t.includes('pho')) return 'pho';
  if(t.includes('bun cha')||t.includes('buncha')) return 'buncha';
  if(t.includes('cha ca')||t.includes('chaca')) return 'chaca';
  if(t.includes('nem cua')||t.includes('nemcuabe')) return 'nemcuabe';
  if(t.includes('nem chua')||t.includes('nemchua')) return 'nemchua';
  if(t.includes('bun ca cay')) return 'buncacay';
  if(t.includes('mi quang')||t.includes('miquang')) return 'miquang';
  if(t.includes('banh trang thit heo')) return 'banhtrangthitheo';
  if(t.includes('cao lau')||t.includes('caolau')) return 'caolau';
  if(t.includes('bun bo')||t.includes('bunbo')) return 'bunbo';
  if(t.includes('che ' )|| t.endsWith('che')||t.includes('checungdinh')) return 'che';
  if(t.includes('com hen')||t.includes('comhen')) return 'comhen';
  if(t.includes('com tam')||t.includes('comtam')) return 'comtam';
  if(t.includes('banh mi')||t.includes('banhmi')) return 'banhmi';
  if(t.includes('pha lau')||t.includes('phalau')) return 'phalau';
  if(t.includes('lau mam')||t.includes('laumam')) return 'laumam';
  if(t.includes('ca loc nuong')||t.includes('nuong trui')) return 'calocnuongtrui';
  if(t.includes('vit nau chao')||t.includes('vitnauchao')) return 'vitnauchao';
  return null;
}
function parseArea(text){
  const known = ['hoan kiem','ho guom','pho co','dong da','hai ba trung','ba dinh','tay ho','cau giay','thanh xuan','hoang mai','long bien','ngo quyen','hai chau','son tra','vinh ninh','phu cat','ninh kieu','go vap','quan 1','quan 3','quan 10','phu nhuan'];
  const t = rmAcc(text);
  for(const k of known){ if(t.includes(k)) return k; }
  return null;
}

// ==================== matching ====================
function isOpenAt(place, dow, minuteOfDay){
  if(minuteOfDay==null) return true;
  const segs = place.hours?.[dow] || place.hours?.[0] || [];
  return segs.some(([from,to])=>{
    const [fh,fm]=from.split(':').map(Number), [th,tm]=to.split(':').map(Number);
    const f = fh*60+fm, e = th*60+tm;
    return minuteOfDay>=f && minuteOfDay<=e;
  });
}
function budgetOk(place, budget){
  if(!budget) return true;
  const lo = place.price_min||0, hi = place.price_max||1e9;
  return !(hi < budget.min || lo > budget.max);
}
function areaMatchScore(placeArea, want){
  if(!want) return 0;
  const a = rmAcc(placeArea||''), b = want;
  if(a.includes('hoan kiem') && (b.includes('ho guom')||b.includes('pho co'))) return 1;
  return a.includes(b) ? 1 : 0;
}
function formatPrice(p){
  if(!p) return 'Tham kh·∫£o t·∫°i qu√°n';
  if(p.price_min && p.price_max && p.price_min===p.price_max) return (p.price_min/1000|0)+'k';
  if(p.price_min && p.price_max) return (p.price_min/1000|0)+'‚Äì'+(p.price_max/1000|0)+'k';
  if(p.price_min) return 't·ª´ '+(p.price_min/1000|0)+'k';
  return 'Tham kh·∫£o';
}
function formatHours(h){
  const segs = (h && (h[new Date().getDay()]||h[0])) || [];
  if(!segs.length) return 'Gi·ªù tham kh·∫£o';
  return segs.map(([f,t])=>`${f}‚Äì${t}`).join(', ');
}
function searchPlaces(queryText, defaultCity='H√† N·ªôi'){
  const dish = parseDish(queryText);
  const area = parseArea(queryText);
  const budget = parseBudgetVND(queryText);
  const city = parseCity(queryText) || defaultCity;
  const {dow, minuteOfDay} = parseTime(queryText);

  const cand = PLACES.filter(p => p.city===city && (!dish || p.dish===dish))
    .map(p=>{
      let sc = 0;
      if(dish && p.dish===dish) sc += 3;
      sc += areaMatchScore(p.area, area);
      if(isOpenAt(p, dow, minuteOfDay)) sc += 1;
      if(budgetOk(p, budget)) sc += 1;
      return {place:p, score:sc};
    })
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0,3)
    .map(x=>x.place);

  return {city, dish, area, budget, when:{dow,minuteOfDay}, results:cand};
}

// ==================== main ====================
function buildTitle(dish, city){
  const dishText = DISH_LABELS[dish] || 'M√≥n ngon';
  return `${dishText} ·ªü ${city}: g·ª£i √Ω h·ª£p gu`;
}
function renderResults(res){
  if(!res.results.length){ addBubble('Ch∆∞a t√¨m th·∫•y qu√°n h·ª£p ti√™u ch√≠. B·∫°n th·ª≠ n√™u r√µ m√≥n/khu/gi·ªù/ng√¢n s√°ch h∆°n nh√©!', 'bot'); return; }
  const places = res.results.map(p=>({
    name:p.name,
    area:p.area || p.city,
    address:p.address || '',
    hoursText: formatHours(p.hours),
    priceText: formatPrice(p),
    why:p.why || '',
    href:p.href || '#'
  }));
  const title = buildTitle(res.dish, res.city);
  addBubble(placeCards(title, places), 'bot');
}

const history = [];
const SYSTEM_PROMPT = `B·∫°n l√† chatbot t∆∞ v·∫•n qu√°n ƒÉn ƒëa th√†nh ph·ªë (H√† N·ªôi, H·∫£i Ph√≤ng, ƒê√† N·∫µng, Hu·∫ø, C·∫ßn Th∆°, H·ªì Ch√≠ Minh).
- Tr·∫£ l·ªùi c·ª±c ng·∫Øn g·ªçn. M·ªói qu√°n: khu/ƒë·ªãa ch·ªâ, gi·ªù tham kh·∫£o, kho·∫£ng gi√°, ƒëi·ªÉm n·ªïi b·∫≠t, k√®m link n·∫øu c√≥.
- N·∫øu ng∆∞·ªùi d√πng ch·ªâ n√™u th√†nh ph·ªë/m√≥n chung chung: ƒë·ªÅ xu·∫•t 3 m√≥n ‚Äúsignature‚Äù c·ªßa th√†nh ph·ªë ƒë√≥.
- N·∫øu ng∆∞·ªùi d√πng n√™u m√≥n c·ª• th·ªÉ: g·ª£i √Ω ƒë√∫ng 3 qu√°n ti√™u bi·ªÉu theo dataset n·ªôi b·ªô.
- T√¥n tr·ªçng ng√¢n s√°ch/gi·ªù/khu khi c√≥, ∆∞u ti√™n qu√°n c√≤n m·ªü, gi√° n·∫±m trong kho·∫£ng.
- Kh√¥ng b·ªãa ƒë·ªãa ch·ªâ/gi·ªù/gi√° ngo√†i dataset. N·∫øu thi·∫øu th√¨ ghi ‚ÄúTham kh·∫£o t·∫°i qu√°n‚Äù.`;

const CLIENT_CONTEXT = `Ng·ªØ c·∫£nh ng∆∞·ªùi d√πng: c√≥ th·ªÉ ·ªü b·∫•t k·ª≥ th√†nh ph·ªë trong danh s√°ch; mu·ªën g·ª£i √Ω theo m√≥n/khu/gi·ªù/ng√¢n s√°ch. Tr·∫£ l·ªùi ng·∫Øn, m·ªói qu√°n c√≥ ƒë·ªãa ch·ªâ, gi·ªù, gi√°, ƒëi·ªÉm n·ªïi b·∫≠t.`;

async function ask(msg){
  const userText = msg.trim();
  if(!userText) return;
  addBubble(esc(userText).replace(/\n/g,'<br>'), 'user');

  // local first
  const local = searchPlaces(userText, 'H√† N·ªôi');
  if(local.results.length){ renderResults(local); return; }

  // fallback server (n·∫øu b·∫°n c√≥ back-end)
  const typingEl = addBubble('<span class="typing">ƒêang g√µ</span>', 'bot');
  btn.disabled = true; q.disabled = true;
  try{
    if (!history.some(h => h.role==='user' && h.parts?.[0]?.text?.startsWith('Ng·ªØ c·∫£nh ng∆∞·ªùi d√πng:'))) {
      history.push({ role:'user', parts:[{ text: CLIENT_CONTEXT }] });
      history.push({ role:'model', parts:[{ text: 'ƒê√£ nh·∫≠n ng·ªØ c·∫£nh.' }] });
    }
    const r = await fetch('/.netlify/functions/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        message: userText,
        history,
        temperature: 0.6,
        system: SYSTEM_PROMPT
      })
    });
    let reply = 'Xin l·ªói, m√¨nh ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi.';
    const ct = r.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      const data = await r.json().catch(()=>({}));
      reply = data.reply || data.error?.message || data.text || reply;
    } else reply = await r.text();
    typingEl.innerHTML = esc(reply).replace(/\n/g,'<br>');
    history.push({ role:'user',  parts:[{ text: userText }] });
    history.push({ role:'model', parts:[{ text: reply.replace(/<[^>]+>/g,'') }] });
  } catch(e){
    typingEl.parentElement.innerHTML = 'C√≥ l·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.';
  } finally {
    btn.disabled = false; q.disabled = false; q.focus();
  }
}

btn.addEventListener('click', ()=>{ if(q.value.trim()){ ask(q.value); q.value=''; }});
q.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btn.click(); }});

// ch√†o ƒë·∫ßu
addBubble('Xin ch√†o! B·∫°n mu·ªën ƒÉn <em>m√≥n g√¨</em>, ·ªü <em>th√†nh ph·ªë/khu n√†o</em> v√† <em>khung gi·ªù</em> n√†o? <br><span class="small">V√≠ d·ª•: ‚ÄúB√∫n c√° cay ·ªü H·∫£i Ph√≤ng, tr∆∞a nay, ~35k/b√°t‚Äù.</span>');
</script>
</body>
</html>
