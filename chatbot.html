<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chatbot t∆∞ v·∫•n qu√°n ƒÉn Vi·ªát Nam (HN/HP/ƒêN/Hu·∫ø/CT/HCM)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --bg:#faf9f7; --text:#141518; --muted:#6e7380; --border:#e6e6e8; --surface:#fff; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.6 'Inter',system-ui}
.container{max-width:920px;margin:0 auto;padding:24px 16px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.header{padding:16px;text-align:center;font-weight:700;font-size:20px}
.chat{padding:14px;max-height:66vh;overflow:auto;scroll-behavior:smooth}
.row{display:flex;gap:10px;margin:10px 0}
.bot .bubble{background:#f1f5f9}
.user{justify-content:flex-end}
.user .bubble{background:#1a5cff;color:#fff}
.bubble{padding:10px 12px;border-radius:12px;max-width:80%}
.input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
input[type="text"]{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font:500 16px/1 'Inter'}
button{padding:12px 16px;border:0;border-radius:10px;font-weight:700;background:#2eb872;color:#fff;cursor:pointer}
button:active{transform:scale(.98)}
.hint{color:#6e7380;font-size:14px;margin:4px 0 0}
.small{font-size:13px;color:#6e7380}
.mini-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px;margin-top:8px}
.mini{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
.mini h4{margin:0 0 6px;font-size:15px}
.mini p{margin:0;color:#6e7380;font-size:13px}
.btn{display:inline-block;background:#1a5cff;color:#fff;border-radius:999px;padding:8px 10px;font-weight:700;font-size:13px;border:0;cursor:pointer;margin-top:8px}
.btn.secondary{background:#e9edf5;color:#1a2a5c}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">ü§ñ Chatbot t∆∞ v·∫•n qu√°n ƒÉn (Multi-city)</div>
    <div id="chat" class="chat"></div>
    <div class="input">
      <input id="q" type="text" placeholder="B·∫°n mu·ªën ƒÉn g√¨? V√≠ d·ª•: 'B√∫n c√° cay ·ªü H·∫£i Ph√≤ng, tr∆∞a nay, ~35k/b√°t'"/>
      <button id="send">G·ª≠i</button>
    </div>
  </div>
  <p class="hint">G·ª£i √Ω: ‚ÄúM√¨ Qu·∫£ng ·ªü ƒê√† N·∫µng, t·ªëi nay, 30‚Äì50k‚Äù.</p>
</div>

<script>
const chat = document.getElementById('chat');
const q    = document.getElementById('q');
const btn  = document.getElementById('send');

// ===== helpers =====
function addBubble(html, who='bot'){
  const row = document.createElement('div');
  row.className = 'row ' + (who === 'user' ? 'user' : 'bot');
  row.innerHTML = `<div class="bubble">${html}</div>`;
  chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
  return row.querySelector('.bubble');
}
const esc = s => s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const rmAcc = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

// ===== say-once (ch·ªëng l·∫∑p) =====
let LAST_PROMPT = null;
function sayOnce(type, html){
  if (LAST_PROMPT === type) return;
  LAST_PROMPT = type;
  addBubble(html,'bot');
}
function clearPromptFlag(){ LAST_PROMPT = null; }

// ===== state =====
let STATE = { city:null, dish:null, area:null, budget:null, dow:null, minuteOfDay:null, askDishPending:false };
const resetState = () => { STATE = { city:null, dish:null, area:null, budget:null, dow:null, minuteOfDay:null, askDishPending:false }; clearPromptFlag(); };

// ===== dataset (t·ª´ PDF ƒë√£ r√∫t g·ªçn minh ho·∫°) =====
const PLACES = [
  // H√Ä N·ªòI
  {city:'H√† N·ªôi', dish:'pho', name:'Ph·ªü 10 L√Ω Qu·ªëc S∆∞', area:'H√†ng Tr·ªëng, Ho√†n Ki·∫øm', address:'10 P. L√Ω Qu·ªëc S∆∞, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['06:00','22:00']]}, price_min:70000, price_max:100000, why:'N∆∞·ªõc d√πng trong, v·ªã b√≤ chu·∫©n ph·ªë c·ªï', href:'#'},
  {city:'H√† N·ªôi', dish:'pho', name:'Ph·ªü g√† Nguy·ªát', area:'H√†ng Tr·ªëng, Ho√†n Ki·∫øm', address:'5B P. Ph·ªß Do√£n, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['06:30','13:00'],['16:30','00:30']]}, price_min:55000, price_max:120000, why:'Ph·ªü g√† ƒë·∫≠m ƒë√†, m·ªü t·ªëi khuya', href:'#'},
  {city:'H√† N·ªôi', dish:'pho', name:'Ph·ªü Kh√¥i H√≥i', area:'Ph·ªë c·ªï, Ho√†n Ki·∫øm', address:'50 P. H√†ng V·∫£i, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['06:00','21:00']]}, price_min:45000, price_max:75000, why:'Qu√°n ƒë·ªãa ph∆∞∆°ng gi√° m·ªÅm', href:'#'},
  {city:'H√† N·ªôi', dish:'buncha', name:'B√∫n ch·∫£ 74 H√†ng Qu·∫°t', area:'Ph·ªë c·ªï, Ho√†n Ki·∫øm', address:'74 P. H√†ng Qu·∫°t, Ho√†n Ki·∫øm, H√† N·ªôi', hours:{0:[['10:00','14:00']]}, price_min:40000, price_max:50000, why:'Th·ªãt n∆∞·ªõng th∆°m l·ª≠a than', href:'#'},
  {city:'H√† N·ªôi', dish:'buncha', name:'B√∫n Th·ªãt N∆∞·ªõng B√† H·∫±ng B√©o', area:'√î Ch·ª£ D·ª´a, ƒê·ªëng ƒêa', address:'60 P. √î Ch·ª£ D·ª´a, H√† N·ªôi', hours:{0:[['10:00','17:00']]}, price_min:40000, price_max:50000, why:'Th·ªãt n∆∞·ªõng ƒë·∫ßy ƒë·∫∑n', href:'#'},
  {city:'H√† N·ªôi', dish:'buncha', name:'B√∫n ch·∫£ H∆∞∆°ng Li√™n', area:'Hai B√† Tr∆∞ng', address:'24 L√™ VƒÉn H∆∞u, H√† N·ªôi', hours:{0:[['08:00','20:00']]}, price_min:60000, price_max:60000, why:'‚ÄúObama‚Äù ‚Äì nem cua b·ªÉ gi√≤n', href:'#'},
  {city:'H√† N·ªôi', dish:'chaca', name:'Ch·∫£ C√° H√†ng S∆°n', area:'Tr√†ng Ti·ªÅn, Ho√†n Ki·∫øm', address:'24 P. T√¥ng ƒê·∫£n, H√† N·ªôi', hours:{0:[['10:30','14:00'],['17:30','22:00']]}, price_min:465000, price_max:2095000, why:'Combo 1‚Äì5 ƒëa d·∫°ng', href:'#'},
  {city:'H√† N·ªôi', dish:'chaca', name:'Ch·∫£ C√° Phan', area:'Nguy·ªÖn Du, Hai B√† Tr∆∞ng', address:'14 Nguy·ªÖn B·ªânh Khi√™m, H√† N·ªôi', hours:{0:[['11:00','21:30']]}, price_min:100000, price_max:200000, why:'M·∫Øm t√¥m pha kh√©o', href:'#'},
  {city:'H√† N·ªôi', dish:'chaca', name:'Ch·∫£ c√° ThƒÉng Long', area:'C·ª≠a ƒê√¥ng, Ho√†n Ki·∫øm', address:'6B ƒê∆∞·ªùng Th√†nh, H√† N·ªôi', hours:{0:[['09:00','23:00']]}, price_min:176000, price_max:176000, why:'C√° d√†y th·ªãt, ch·∫£o n√≥ng', href:'#'},

  // H·∫¢I PH√íNG
  {city:'H·∫£i Ph√≤ng', dish:'nemcuabe', name:'Nem Cua B·ªÉ Thu·∫≠n Y·∫øn', area:'Ng√¥ Quy·ªÅn', address:'179 C·∫ßu ƒê·∫•t, H·∫£i Ph√≤ng', hours:{0:[['10:00','21:00']]}, price_min:35000, price_max:85000, why:'Nem gi√≤n, set h·ª£p l√Ω', href:'#'},
  {city:'H·∫£i Ph√≤ng', dish:'nemcuabe', name:'B√∫n ch·∫£ Nem Cua Tuy·∫øt Loan', area:'Ng√¥ Quy·ªÅn', address:'124 L·∫°ch Tray, H·∫£i Ph√≤ng', hours:{0:[['10:00','21:00']]}, price_min:30000, price_max:60000, why:'Nem cua b·ªÉ + b√∫n ch·∫£', href:'#'},
  {city:'H·∫£i Ph√≤ng', dish:'nemcuabe', name:'Nem Cua B·ªÉ Qu√°n Nga', area:'Ng√¥ Quy·ªÅn', address:'195 Tr·∫ßn Ph√∫, H·∫£i Ph√≤ng', hours:{0:[['10:00','21:00']]}, price_min:40000, price_max:80000, why:'Nem n√≥ng cu·ªën t·∫°i ch·ªó', href:'#'},
  {city:'H·∫£i Ph√≤ng', dish:'nemchua', name:'Nem chua An Th·ªç', area:'An L√£o', address:'An Th·ªç (ship to√†n qu·ªëc)', hours:{0:[['08:00','21:00']]}, price_min:0, price_max:0, why:'ƒê·∫∑t theo set 10‚Äì50 c√°i', href:'#'},
  {city:'H·∫£i Ph√≤ng', dish:'nemchua', name:'Nem Chua B√† C·ª•', area:'‚Äî', address:'H·∫£i Ph√≤ng', hours:{0:[['08:00','20:00']]}, price_min:10000, price_max:20000, why:'D√¢n d√£, d·ªÖ t√¨m', href:'#'},
  {city:'H·∫£i Ph√≤ng', dish:'buncacay', name:'B√∫n c√° cay 153 L√™ Lai', area:'L√™ Lai', address:'153 L√™ Lai, H·∫£i Ph√≤ng', hours:{0:[['06:00','12:30']]}, price_min:20000, price_max:30000, why:'C√° r√¥ gi√≤n/m·ªÅm', href:'#'},
  {city:'H·∫£i Ph√≤ng', dish:'buncacay', name:'B√∫n c√° cay C·∫≠u ƒêo√†nh', area:'Nhi·ªÅu c∆° s·ªü', address:'HP (tham kh·∫£o fanpage)', hours:{0:[['06:30','13:30'],['17:30','21:00']]}, price_min:35000, price_max:35000, why:'Th·∫≠p c·∫©m phong ph√∫', href:'#'},

  // ƒê√Ä N·∫¥NG
  {city:'ƒê√† N·∫µng', dish:'miquang', name:'M√¨ Qu·∫£ng B·ªát', area:'‚Äî', address:'ƒê√† N·∫µng', hours:{0:[['06:00','21:00']]}, price_min:40000, price_max:80000, why:'Topping ƒë·ªß v·ªã', href:'#'},
  {city:'ƒê√† N·∫µng', dish:'miquang', name:'M√¨ Qu·∫£ng B√† L·ªØ', area:'H·∫£i Ch√¢u', address:'24 Tr·∫ßn Cao V√¢n, ƒê√† N·∫µng', hours:{0:[['06:00','21:00']]}, price_min:30000, price_max:55000, why:'Truy·ªÅn th·ªëng', href:'#'},
  {city:'ƒê√† N·∫µng', dish:'banhtrangthitheo', name:'B√°nh tr√°ng cu·ªën th·ªãt heo B√† H∆∞·ªùng', area:'H·∫£i Ch√¢u', address:'460 2 Th√°ng 9, ƒê√† N·∫µng', hours:{0:[['06:00','22:00']]}, price_min:95000, price_max:95000, why:'Rau s·ªëng phong ph√∫', href:'#'},
  {city:'ƒê√† N·∫µng', dish:'banhtrangthitheo', name:'B√°nh tr√°ng th·ªãt heo B√† Thu', area:'Ng≈© H√†nh S∆°n', address:'103 ƒê·ªó B√°, ƒê√† N·∫µng', hours:{0:[['10:00','21:00']]}, price_min:0, price_max:0, why:'M·∫Øm n√™m ƒë·∫≠m', href:'#'},
  {city:'ƒê√† N·∫µng', dish:'caolau', name:'Cao l·∫ßu Ph·ªë H·ªôi', area:'H·∫£i Ch√¢u', address:'63 Phan ƒêƒÉng L∆∞u, ƒê√† N·∫µng', hours:{0:[['06:00','21:00']]}, price_min:0, price_max:0, why:'Chu·∫©n v·ªã H·ªôi An', href:'#'},
  {city:'ƒê√† N·∫µng', dish:'caolau', name:'Cao l·∫ßu Ph∆∞·ªõc', area:'S∆°n Tr√†', address:'18/3 Nguy·ªÖn Duy Hi·ªáu, ƒê√† N·∫µng', hours:{0:[['06:00','11:00']]}, price_min:0, price_max:0, why:'B√°n bu·ªïi s√°ng', href:'#'},

  // HU·∫æ
  {city:'Hu·∫ø', dish:'bunbo', name:'B√∫n B√≤ B√† Nga', area:'Ph√∫ C√°t', address:'5 Nguy·ªÖn Du, Hu·∫ø', hours:{0:[['06:00','20:30']]}, price_min:25000, price_max:45000, why:'ƒê·∫≠m v·ªã Hu·∫ø', href:'#'},
  {city:'Hu·∫ø', dish:'bunbo', name:'B√∫n b√≤ Hu·∫ø M·ªπ T√¢m', area:'Vƒ©nh Ninh', address:'3 Tr·∫ßn Cao V√¢n, Hu·∫ø', hours:{0:[['07:00','22:00']]}, price_min:30000, price_max:80000, why:'Topping ƒëa d·∫°ng', href:'#'},
  {city:'Hu·∫ø', dish:'che', name:'Ch√® C·∫ßm', area:'V·ªπ D·∫°', address:'10 Nguy·ªÖn Sinh Cung, Hu·∫ø', hours:{0:[['16:00','19:30']]}, price_min:15000, price_max:30000, why:'Ch√® cung ƒë√¨nh', href:'#'},
  {city:'Hu·∫ø', dish:'comhen', name:'C∆°m h·∫øn Hoa ƒê√¥ng', area:'‚Äî', address:'64 Ki·ªát 7 ∆Øng B√¨nh, Hu·∫ø', hours:{0:[['06:00','20:00']]}, price_min:20000, price_max:20000, why:'ƒê·∫∑c bi·ªát, r·∫ª', href:'#'},

  // C·∫¶N TH∆†
  {city:'C·∫ßn Th∆°', dish:'laumam', name:'L·∫©u m·∫Øm C·∫ßn Th∆°', area:'Ninh Ki·ªÅu', address:'162/18 Tr·∫ßn Ng·ªçc Qu·∫ø, C·∫ßn Th∆°', hours:{0:[['09:30','22:30']]}, price_min:0, price_max:0, why:'Rau ƒë·ªìng qu√™', href:'#'},
  {city:'C·∫ßn Th∆°', dish:'calocnuongtrui', name:'ƒê·ªìng Xanh', area:'Ninh Ki·ªÅu', address:'211 Nguy·ªÖn VƒÉn Linh, C·∫ßn Th∆°', hours:{0:[['08:00','03:00']]}, price_min:39000, price_max:39000, why:'M·ªü khuya', href:'#'},
  {city:'C·∫ßn Th∆°', dish:'vitnauchao', name:'V·ªãt N·∫•u Chao C·∫©m T√∫', area:'Ninh Ki·ªÅu', address:'1 L√Ω T·ª± Tr·ªçng, C·∫ßn Th∆°', hours:{0:[['09:00','22:00']]}, price_min:150000, price_max:200000, why:'ƒê·∫≠m v·ªã, h·ª£p l√Ω', href:'#'},

  // H·ªí CH√ç MINH
  {city:'H·ªì Ch√≠ Minh', dish:'comtam', name:'C∆°m t·∫•m Ba Ghi·ªÅn', area:'Ph√∫ Nhu·∫≠n', address:'84 ƒê·∫∑ng VƒÉn Ng·ªØ, TP.HCM', hours:{0:[['06:00','22:00']]}, price_min:40000, price_max:70000, why:'S∆∞·ªùn d√†y, c∆°m m·ªÅm', href:'#'},
  {city:'H·ªì Ch√≠ Minh', dish:'banhmi', name:'B√°nh m√¨ Huynh Hoa', area:'Qu·∫≠n 1', address:'26 L√™ Th·ªã Ri√™ng, TP.HCM', hours:{0:[['13:00','23:00']]}, price_min:73000, price_max:73000, why:'Pate & ch·∫£ ƒë·∫ßy', href:'#'},
  {city:'H·ªì Ch√≠ Minh', dish:'phalau', name:'Ph√° l·∫•u b√≤ C√¢y Tr√¢m', area:'G√≤ V·∫•p', address:'208 C√¢y Tr√¢m, TP.HCM', hours:{0:[['15:00','21:00']]}, price_min:30000, price_max:60000, why:'C√≥ m√¨/b√°nh m√¨ ph√° l·∫•u', href:'#'}
];

// Labels
const DISH_LABELS = {
  pho:'Ph·ªü', buncha:'B√∫n ch·∫£', chaca:'Ch·∫£ c√°',
  nemcuabe:'Nem cua b·ªÉ', nemchua:'Nem chua', buncacay:'B√∫n c√° cay',
  miquang:'M√¨ Qu·∫£ng', banhtrangthitheo:'B√°nh tr√°ng th·ªãt heo', caolau:'Cao l·∫ßu',
  bunbo:'B√∫n b√≤ Hu·∫ø', che:'Ch√®', comhen:'C∆°m h·∫øn',
  comtam:'C∆°m t·∫•m', banhmi:'B√°nh m√¨', phalau:'Ph√° l·∫•u',
  laumam:'L·∫©u m·∫Øm', calocnuongtrui:'C√° l√≥c n∆∞·ªõng trui', vitnauchao:'V·ªãt n·∫•u chao'
};

const CITY_SIGNATURES = {
  'H√† N·ªôi':['pho','buncha','chaca'],
  'H·∫£i Ph√≤ng':['buncacay','nemcuabe','nemchua'],
  'ƒê√† N·∫µng':['miquang','banhtrangthitheo','caolau'],
  'Hu·∫ø':['bunbo','che','comhen'],
  'C·∫ßn Th∆°':['laumam','calocnuongtrui','vitnauchao'],
  'H·ªì Ch√≠ Minh':['comtam','banhmi','phalau']
};

// ===== parsing =====
function parseBudgetVND(text){
  const t = rmAcc(text).replace(/\s/g,'');
  const mRange = t.match(/(\d{2,4})-?(\d{2,4})k/);
  if(mRange) return {min:+mRange[1]*1000, max:+mRange[2]*1000};
  return null;
}
function parseTime(text){
  const t = rmAcc(text);
  const today = new Date().getDay();
  let dow=today, minuteOfDay=null;
  const m = t.match(/(\d{1,2})(?:h|:)(\d{0,2})?/);
  if(m){ minuteOfDay=(+m[1])*60 + (m[2]?+m[2]:0); }
  else if(t.includes('sang')) minuteOfDay=8*60;
  else if(t.includes('trua')) minuteOfDay=12*60;
  else if(t.includes('chieu')) minuteOfDay=17*60;
  else if(t.includes('toi')) minuteOfDay=19*60;
  return {dow, minuteOfDay};
}
function parseCity(text){
  let t = rmAcc(text);
  // v√° l·ªói ch√≠nh t·∫£ ph·ªï bi·∫øn
  t = t.replace(/\bha loi\b/g,'ha noi');
  if(/ha noi|hanoi|hn/.test(t)) return 'H√† N·ªôi';
  if(/hai phong|haiphong|hp/.test(t)) return 'H·∫£i Ph√≤ng';
  if(/da nang|danang|dn/.test(t)) return 'ƒê√† N·∫µng';
  if(/hue/.test(t)) return 'Hu·∫ø';
  if(/can tho|cantho|ct/.test(t)) return 'C·∫ßn Th∆°';
  if(/ho chi minh|tphcm|hcm|sai gon|saigon/.test(t)) return 'H·ªì Ch√≠ Minh';
  return null;
}
function parseDish(text){
  const t = rmAcc(text);
  if(t.includes('pho')) return 'pho';
  if(t.includes('bun cha')) return 'buncha';
  if(t.includes('cha ca')) return 'chaca';
  if(t.includes('nem cua')) return 'nemcuabe';
  if(t.includes('nem chua')) return 'nemchua';
  if(t.includes('bun ca cay')) return 'buncacay';
  if(t.includes('mi quang')) return 'miquang';
  if(t.includes('banh trang thit heo')) return 'banhtrangthitheo';
  if(t.includes('cao lau')) return 'caolau';
  if(t.includes('bun bo')) return 'bunbo';
  if(/\bche\b/.test(t)) return 'che';
  if(t.includes('com hen')) return 'comhen';
  if(t.includes('com tam')) return 'comtam';
  if(t.includes('banh mi')) return 'banhmi';
  if(t.includes('pha lau')) return 'phalau';
  if(t.includes('lau mam')) return 'laumam';
  if(t.includes('ca loc nuong')||t.includes('nuong trui')) return 'calocnuongtrui';
  if(t.includes('vit nau chao')) return 'vitnauchao';
  return null;
}
function parseArea(text){
  const known=['hoan kiem','pho co','dong da','hai ba trung','ba dinh','tay ho','hai chau','son tra','vinh ninh','phu cat','ninh kieu','go vap','quan 1','quan 3','quan 10','phu nhuan'];
  const t=rmAcc(text); for(const k of known){ if(t.includes(k)) return k; } return null;
}

// hi·ªÉu ‚Äúch∆∞a/c√≥‚Äù
function saidNoDish(text){
  const t = rmAcc(text).trim();
  return /\b(chua|chua co|chua biet|chua nghi|chua quyet|khong|ko|k|khong biet|khong ro)\b/.test(t);
}
function saidYes(text){
  const t = rmAcc(text).trim();
  return /\b(roi|co|oke?|okela|da|da roi|chap nhan|co roi)\b/.test(t);
}

// ===== ranking / match =====
function isOpenAt(place,dow,minuteOfDay){
  if(minuteOfDay==null) return true;
  const segs = place.hours?.[dow] || place.hours?.[0] || [];
  return segs.some(([from,to])=>{
    const [fh,fm]=from.split(':').map(Number), [th,tm]=to.split(':').map(Number);
    const f=fh*60+fm, e=th*60+tm; return minuteOfDay>=f && minuteOfDay<=e;
  });
}
function budgetOk(place,budget){
  if(!budget) return true;
  const lo=place.price_min||0, hi=place.price_max||1e9;
  return !(hi<budget.min || lo>budget.max);
}
function formatPrice(p){
  if(!p) return 'Tham kh·∫£o t·∫°i qu√°n';
  if(p.price_min && p.price_max && p.price_min===p.price_max) return (p.price_min/1000|0)+'k';
  if(p.price_min && p.price_max) return (p.price_min/1000|0)+'‚Äì'+(p.price_max/1000|0)+'k';
  if(p.price_min) return 't·ª´ '+(p.price_min/1000|0)+'k';
  return 'Tham kh·∫£o';
}
function formatHours(h){
  const segs=(h&&(h[new Date().getDay()]||h[0]))||[];
  if(!segs.length) return 'Gi·ªù tham kh·∫£o';
  return segs.map(([f,t])=>`${f}‚Äì${t}`).join(', ');
}
function searchPlaces(city,dish,filtersText=''){
  const budget=parseBudgetVND(filtersText);
  const {dow,minuteOfDay}=parseTime(filtersText);
  return PLACES.filter(p=>(!city||p.city===city)&&(!dish||p.dish===dish))
    .map(p=>{let score=0; if(dish&&p.dish===dish)score+=3; if(isOpenAt(p,dow,minuteOfDay))score+=1; if(budgetOk(p,budget))score+=1; return {p,score};})
    .sort((a,b)=>b.score-a.score).slice(0,3).map(x=>x.p);
}

// ===== UI builders =====
function placeCards(title, places){
  return `
    <div><strong>${title}</strong></div>
    <div class="mini-grid">
      ${places.map(p=>`
        <div class="mini">
          <h4>${p.name}</h4>
          <p>üìç ${p.area}<br>üó∫Ô∏è ${p.address}<br>üïí ${formatHours(p.hours)}<br>üí∏ ${formatPrice(p)}</p>
          <p style="margin-top:6px">${p.why||''}</p>
        </div>`).join('')}
    </div>
    <p class="small">üí° Tip: G√µ ‚Äúm√≥n + th√†nh ph·ªë + th·ªùi gian + ng√¢n s√°ch‚Äù. V√≠ d·ª•: ‚Äúb√∫n ch·∫£ Ho√†n Ki·∫øm tr∆∞a nay 40‚Äì50k‚Äù.</p>`;
}
function dishSuggestCards(city){
  const dishes=CITY_SIGNATURES[city]||[];
  const picks=dishes.map(d=>({dish:d,sample:searchPlaces(city,d)[0]})).filter(x=>x.sample);
  const html=`
    <div><strong>M√≥n n·ªïi b·∫≠t ·ªü ${city}</strong></div>
    <div class="mini-grid">
      ${picks.map(x=>`
        <div class="mini">
          <h4>${DISH_LABELS[x.dish]}</h4>
          <p>V√≠ d·ª•: <b>${x.sample.name}</b> ‚Äî ${formatPrice(x.sample)}</p>
          <button class="btn" data-choose="${x.dish}">Ch·ªçn m√≥n n√†y</button>
        </div>`).join('')}
    </div>
    <p class="small">B·∫°n c√≥ th·ªÉ b·∫•m ch·ªçn ho·∫∑c g√µ m√≥n kh√°c tu·ª≥ th√≠ch.</p>`;
  const el=addBubble(html,'bot');
  el.querySelectorAll('[data-choose]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const d=b.getAttribute('data-choose');
      STATE.dish=d; STATE.askDishPending=false; clearPromptFlag();
      showResultsForCityDish(STATE.city,d);
    });
  });
  LAST_PROMPT='suggestions';
}
function showResultsForCityDish(city,dish,extras=''){
  const res=searchPlaces(city,dish,extras);
  if(!res.length){ addBubble('Ch∆∞a th·∫•y qu√°n kh·ªõp. B·∫°n th·ª≠ m√≥n kh√°c ho·∫∑c n·ªõi ng√¢n s√°ch nh√©.'); return; }
  addBubble(placeCards(`${DISH_LABELS[dish]} ·ªü ${city}: g·ª£i √Ω h·ª£p gu`,res));
  resetState();
}

// ===== conversation =====
function isGreeting(s){ return /(hi|hello|xin chao|chao|chao ban)/i.test(rmAcc(s)); }

function ask(msg){
  const userText = msg.trim();
  if(!userText) return;
  addBubble(esc(userText),'user');

  if(isGreeting(userText)){
    sayOnce('intro','Ch√†o b·∫°n üëã M√¨nh l√† chatbot g·ª£i √Ω qu√°n ƒÉn theo <b>m√≥n/khu/gi·ªù/ng√¢n s√°ch</b> t·∫°i HN, HP, ƒêN, Hu·∫ø, CT, HCM. B·∫°n ƒëang ·ªü <b>th√†nh ph·ªë/khu n√†o</b> v√† <b>ƒë√£ d·ª± ƒë·ªãnh ƒÉn m√≥n g√¨ ch∆∞a</b>?');
    return;
  }

  // fill slots
  const city = parseCity(userText);
  const dish = parseDish(userText);
  if(city && city!==STATE.city){ STATE.city=city; clearPromptFlag(); }
  if(dish){ STATE.dish=dish; STATE.askDishPending=false; clearPromptFlag(); }

  // N·∫øu ƒëang ch·ªù tr·∫£ l·ªùi v·ªÅ m√≥n
  if(STATE.askDishPending){
    if(dish){ showResultsForCityDish(STATE.city, STATE.dish, userText); return; }
    if(saidNoDish(userText)){ STATE.askDishPending=false; dishSuggestCards(STATE.city); return; }
    if(saidYes(userText)){ sayOnce('askWhich', 'B·∫°n ƒë·ªãnh ƒÉn <b>m√≥n n√†o</b>? (vd: b√∫n ch·∫£, ph·ªü, m√¨ qu·∫£ng...)'); return; }
    // n·∫øu m∆° h·ªì ‚Üí nh·∫Øc nh·∫π 1 l·∫ßn
    sayOnce('clarify','B·∫°n ƒë√£ c√≥ m√≥n d·ª± ƒë·ªãnh ch∆∞a? C√≥ th√¨ g√µ t√™n m√≥n; ch∆∞a th√¨ g√µ "ch∆∞a bi·∫øt" ƒë·ªÉ m√¨nh g·ª£i √Ω.');
    return;
  }

  // Khi ng∆∞·ªùi d√πng ƒë√£ n√≥i city nh∆∞ng ch∆∞a n√≥i m√≥n: h·ªèi 1 l·∫ßn r·ªìi ch·ªù
  if(STATE.city && !STATE.dish){
    STATE.askDishPending = true;
    sayOnce('askDish', `B·∫°n ƒëang ·ªü <b>${STATE.city}</b>. B·∫°n <b>ƒë√£ d·ª± ƒë·ªãnh ƒÉn m√≥n g√¨ ch∆∞a</b>? (C√≥: g√µ t√™n m√≥n ‚Ä¢ Ch∆∞a: g√µ "ch∆∞a bi·∫øt" ƒë·ªÉ m√¨nh g·ª£i √Ω)`);
    return;
  }

  // ƒê·ªß city + dish
  if(STATE.city && STATE.dish){
    showResultsForCityDish(STATE.city, STATE.dish, userText);
    return;
  }

  // Thi·∫øu c·∫£ hai
  if(!STATE.city && !STATE.dish){
    sayOnce('askCityDish','B·∫°n ƒëang ·ªü <b>th√†nh ph·ªë n√†o</b> (HN/HP/ƒêN/Hu·∫ø/CT/HCM) v√† <b>ƒë√£ d·ª± ƒë·ªãnh ƒÉn m√≥n g√¨ ch∆∞a</b>?');
    return;
  }

  // C√≥ dish nh∆∞ng ch∆∞a city
  if(!STATE.city && STATE.dish){
    sayOnce('askCity',`B·∫°n mu·ªën ƒÉn <b>${DISH_LABELS[STATE.dish]||STATE.dish}</b>, v·∫≠y b·∫°n ƒëang ·ªü <b>th√†nh ph·ªë n√†o</b>? (HN/HP/ƒêN/Hu·∫ø/CT/HCM)`);
  }
}

// events
btn.addEventListener('click', ()=>{ if(q.value.trim()){ ask(q.value); q.value=''; }});
q.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btn.click(); }});

// Kh√¥ng auto ch√†o ‚Äî bot l·∫Øng nghe tr∆∞·ªõc.
</script>
</body>
</html>
