<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tinh hoa hÆ°Æ¡ng vá»‹ Viá»‡t</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/pho.png?v=1" />
  <!-- SEO -->
  <meta name="description" content="KhÃ¡m phÃ¡ quÃ¡n Äƒn ngon 3 miá»n â€” Báº¯c, Trung, Nam. Review chÃ¢n thá»±c, giÃ¡ cáº£ rÃµ rÃ ng, gá»£i Ã½ gáº§n báº¡n." />
  <meta property="og:title" content="Ä‚n Ngon 3 Miá»n" />
  <meta property="og:description" content="Review quÃ¡n Äƒn kháº¯p Viá»‡t Nam. TÃ¬m kiáº¿m theo mÃ³n, Ä‘á»‹a Ä‘iá»ƒm, giÃ¡." />
  <meta property="og:image" content="images/Home/BG1.jpg" />
  <meta name="theme-color" content="#ffffff" />
  <!-- Fonts (VN-ready) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&family=Noto+Serif+Display:ital,wght@0,600;0,700;0,800;1,600;1,700&family=Kaushan+Script&display=swap" rel="stylesheet">
  <!-- CSS -->
  <link rel="stylesheet" href="css/styles.css" />

  <!-- ===== Top quÃ¡n Äƒn â€” nÃ¢ng cáº¥p giao diá»‡n & Ä‘Ã¡nh sá»‘ 1â€“3 ===== -->
  <style>
   :root{ --bg:#faf9f7; --text:#141518; --muted:#6e7380; --border:#e6e6e8; --surface:#fff; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.6 'Inter',system-ui}
.container{max-width:920px;margin:0 auto;padding:24px 16px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.header{padding:16px;text-align:center;font-weight:700;font-size:20px}
.chat{padding:14px;max-height:66vh;overflow:auto;scroll-behavior:smooth}
.row{display:flex;gap:10px;margin:10px 0}
.bot .bubble{background:#f1f5f9}
.user{justify-content:flex-end}
.user .bubble{background:#1a5cff;color:#fff}
.bubble{padding:10px 12px;border-radius:12px;max-width:80%}
.input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
input[type="text"]{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font:500 16px/1 'Inter'}
button{padding:12px 16px;border:0;border-radius:10px;font-weight:700;background:#2eb872;color:#fff;cursor:pointer}
button:active{transform:scale(.98)}
.hint{color:#6e7380;font-size:14px;margin:4px 0 0}
.small{font-size:13px;color:#6e7380}
.mini-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px;margin-top:8px}
.mini{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
.mini h4{margin:0 0 6px;font-size:15px}
.mini p{margin:0;color:#6e7380;font-size:13px}
.btn{display:inline-block;background:#1a5cff;color:#fff;border-radius:999px;padding:8px 10px;font-weight:700;font-size:13px;border:0;cursor:pointer;margin-top:8px}
.btn.secondary{background:#e9edf5;color:#1a2a5c}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chip{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:600}
.chip:hover{background:#f3f4f6}
.mini .actions{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
.btn.ghost{ background:#fff; color:#1a2a5c; border:1px solid #e5e7eb }
.btn.ghost:hover{ background:#f3f4f6 }

  </style>
</head>
<body>
  <a class="visually-hidden" href="#main">Bá» qua ná»™i dung</a>

  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="container header-inner">
      <div class="site-title">TINH HOA HÆ¯Æ NG Vá»Š VIá»†T</div>
      <nav class="primary" aria-label="ChÃ­nh">
        <a class="nav-link" href="/index.html" aria-current="page">Trang chá»§</a>
        <a class="nav-link" href="/chatbot.html">Chatbot TÆ° Váº¥n ThÃ´ng Minh</a>
        <a class="nav-link" href="/congdong.html">Má»Ÿ Rá»™ng</a>
        <a class="nav-link" href="/contactus.html">Vá» chÃºng tÃ´i</a>
      </nav>
    </div>
  </header>


  <!-- ===== Ná»™i dung Chatbot (giá»¯ nguyÃªn prompt/logic) ===== -->
  <main>
    <div class="container">
      <div class="card">
        <div class="header">Chatbot tÆ° váº¥n quÃ¡n Äƒn</div>
        <div id="chat" class="chat"></div>
        <div class="input">
          <input id="q" type="text" placeholder="Báº¡n muá»‘n Äƒn gÃ¬? VÃ­ dá»¥: 'BÃºn cÃ¡ cay á»Ÿ Háº£i PhÃ²ng, trÆ°a nay, ~35k/bÃ¡t'"/>
          <button id="send">Gá»­i</button>
        </div>
      </div>
      <p class="hint">Gá»£i Ã½: â€œMÃ¬ Quáº£ng á»Ÿ ÄÃ  Náºµng, tá»‘i nay, 30â€“50kâ€.</p>
    </div>
  </main>
  <!-- Footer -->
  <footer role="contentinfo">
    <div class="container">
      <div class="grid">
        <div>
          <strong style="font-family:'Noto Serif Display',serif">Ä‚n Ngon 3 Miá»n</strong>
          <p class="section-desc">Ná»n táº£ng review quÃ¡n Äƒn kháº¯p Viá»‡t Nam. Chia sáº» bá»Ÿi cá»™ng Ä‘á»“ng sÃ nh Äƒn.</p>
        </div>
        <div>
          <strong style="font-family:'Noto Serif Display',serif">LiÃªn káº¿t</strong>
          <p class="section-desc"><a href="#">Äiá»u khoáº£n</a> â€¢ <a href="#">Báº£o máº­t</a> â€¢ <a href="contactus.html">LiÃªn há»‡</a></p>
        </div>
        <div>
          <strong style="font-family:'Noto Serif Display',serif">Cáº­p nháº­t</strong>
          <p class="section-desc">Theo dÃµi chÃºng tÃ´i Ä‘á»ƒ nháº­n gá»£i Ã½ quÃ¡n ngon má»—i tuáº§n.</p>
        </div>
      </div>
      <p style="margin-top:12px;color:var(--muted)">Â© <span id="year"></span> AnNgon3Mien. All rights reserved.</p>
    </div>
  </footer>



<script>
const chat = document.getElementById('chat');
const q    = document.getElementById('q');
const btn  = document.getElementById('send');

// ===== helpers =====
function addBubble(html, who='bot'){
  const row = document.createElement('div');
  row.className = 'row ' + (who === 'user' ? 'user' : 'bot');
  row.innerHTML = `<div class="bubble">${html}</div>`;
  chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
  return row.querySelector('.bubble');
}

const esc   = s => s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const rmAcc = s =>
  s.normalize('NFD')
   .replace(/[\u0300-\u036f]/g, '')
   .replace(/Ä‘/g, 'd')
   .replace(/Ä/g, 'd')
   .toLowerCase();

   function norm(s){
  return rmAcc(String(s || ''));   // chuáº©n hoÃ¡ + lowercase + bá» dáº¥u
}

// ===== say-once (chá»‘ng láº·p) =====
let LAST = {type:null, count:0}; // nhá»› loáº¡i prompt gáº§n nháº¥t vÃ  sá»‘ láº§n láº·p
function sayOnce(type, html){
  if (LAST.type === type && LAST.count >= 1) return; // cÃ¹ng prompt -> nÃ³i tá»‘i Ä‘a 2 lÆ°á»£t
  if (LAST.type === type) LAST.count++; else { LAST.type = type; LAST.count = 0; }
  addBubble(html, 'bot');
}
function clearPromptFlag(){ LAST = {type:null, count:0}; }


// ===== state =====
let STATE = { city:null, dish:null, area:null, budget:null, dow:null, minuteOfDay:null, askDishPending:false };
let LAST_RESULTS = [];   // nhá»› 3 quÃ¡n vá»«a hiá»ƒn thá»‹ Ä‘á»ƒ hiá»ƒu â€œmÃ¬nh chá»n quÃ¡n Xâ€
const resetState = () => { STATE = { city:null, dish:null, area:null, budget:null, dow:null, minuteOfDay:null, askDishPending:false }; clearPromptFlag(); LAST_RESULTS = []; };


// ===== dataset (Ä‘Ã£ update) =====
const PLACES = [
  // HÃ€ Ná»˜I
  {city:'HÃ  Ná»™i', dish:'pho', name:'Phá»Ÿ 10 LÃ½ Quá»‘c SÆ°', area:'HÃ ng Trá»‘ng, HoÃ n Kiáº¿m', address:'10 P. LÃ½ Quá»‘c SÆ°, HoÃ n Kiáº¿m, HÃ  Ná»™i', hours:{0:[['06:00','22:00']]}, price_min:70000, price_max:100000, why:'NÆ°á»›c dÃ¹ng trong, vá»‹ bÃ² chuáº©n phá»‘ cá»•', href:'#'},
  {city:'HÃ  Ná»™i', dish:'pho', name:'Phá»Ÿ gÃ  Nguyá»‡t', area:'HÃ ng Trá»‘ng, HoÃ n Kiáº¿m', address:'5B P. Phá»§ DoÃ£n, HoÃ n Kiáº¿m, HÃ  Ná»™i', hours:{0:[['06:30','13:00'],['16:30','00:30']]}, price_min:55000, price_max:120000, why:'Phá»Ÿ gÃ  Ä‘áº­m Ä‘Ã , má»Ÿ tá»‘i khuya', href:'#'},
  {city:'HÃ  Ná»™i', dish:'pho', name:'Phá»Ÿ KhÃ´i HÃ³i', area:'Phá»‘ cá»•, HoÃ n Kiáº¿m', address:'50 P. HÃ ng Váº£i, HoÃ n Kiáº¿m, HÃ  Ná»™i', hours:{0:[['06:00','21:00']]}, price_min:45000, price_max:75000, why:'QuÃ¡n Ä‘á»‹a phÆ°Æ¡ng giÃ¡ má»m', href:'#'},
  {city:'HÃ  Ná»™i', dish:'buncha', name:'BÃºn cháº£ 74 HÃ ng Quáº¡t', area:'Phá»‘ cá»•, HoÃ n Kiáº¿m', address:'74 P. HÃ ng Quáº¡t, HoÃ n Kiáº¿m, HÃ  Ná»™i', hours:{0:[['10:00','14:00']]}, price_min:40000, price_max:50000, why:'Thá»‹t nÆ°á»›ng thÆ¡m lá»­a than', href:'#'},
  {city:'HÃ  Ná»™i', dish:'buncha', name:'BÃºn Thá»‹t NÆ°á»›ng BÃ  Háº±ng BÃ©o', area:'Ã” Chá»£ Dá»«a, Äá»‘ng Äa', address:'60 P. Ã” Chá»£ Dá»«a, HÃ  Ná»™i', hours:{0:[['10:00','17:00']]}, price_min:40000, price_max:50000, why:'Thá»‹t nÆ°á»›ng Ä‘áº§y Ä‘áº·n', href:'#'},
  {city:'HÃ  Ná»™i', dish:'buncha', name:'BÃºn cháº£ HÆ°Æ¡ng LiÃªn', area:'Hai BÃ  TrÆ°ng', address:'24 LÃª VÄƒn HÆ°u, HÃ  Ná»™i', hours:{0:[['08:00','20:00']]}, price_min:60000, price_max:60000, why:'â€œObamaâ€ â€“ nem cua bá»ƒ giÃ²n', href:'#'},
  {city:'HÃ  Ná»™i', dish:'chaca', name:'Cháº£ CÃ¡ HÃ ng SÆ¡n', area:'TrÃ ng Tiá»n, HoÃ n Kiáº¿m', address:'24 P. TÃ´ng Äáº£n, HÃ  Ná»™i', hours:{0:[['10:30','14:00'],['17:30','22:00']]}, price_min:465000, price_max:2095000, why:'Combo 1â€“5 Ä‘a dáº¡ng', href:'#'},
  {city:'HÃ  Ná»™i', dish:'chaca', name:'Cháº£ CÃ¡ Phan', area:'Nguyá»…n Du, Hai BÃ  TrÆ°ng', address:'14 Nguyá»…n Bá»‰nh KhiÃªm, HÃ  Ná»™i', hours:{0:[['11:00','21:30']]}, price_min:100000, price_max:200000, why:'Máº¯m tÃ´m pha khÃ©o', href:'#'},
  {city:'HÃ  Ná»™i', dish:'chaca', name:'Cháº£ cÃ¡ ThÄƒng Long', area:'Cá»­a ÄÃ´ng, HoÃ n Kiáº¿m', address:'6B ÄÆ°á»ng ThÃ nh, HÃ  Ná»™i', hours:{0:[['09:00','23:00']]}, price_min:176000, price_max:176000, why:'CÃ¡ dÃ y thá»‹t, cháº£o nÃ³ng', href:'#'},

  // Háº¢I PHÃ’NG
  {city:'Háº£i PhÃ²ng', dish:'nemcuabe', name:'Nem Cua Bá»ƒ Thuáº­n Yáº¿n', area:'NgÃ´ Quyá»n', address:'179 Cáº§u Äáº¥t, Háº£i PhÃ²ng', hours:{0:[['10:00','21:00']]}, price_min:35000, price_max:85000, why:'Nem giÃ²n, set há»£p lÃ½', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'nemcuabe', name:'BÃºn cháº£ Nem Cua Tuyáº¿t Loan', area:'NgÃ´ Quyá»n', address:'124 Láº¡ch Tray, Háº£i PhÃ²ng', hours:{0:[['10:00','21:00']]}, price_min:30000, price_max:60000, why:'Nem cua bá»ƒ + bÃºn cháº£', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'nemcuabe', name:'Nem Cua Bá»ƒ QuÃ¡n Nga', area:'NgÃ´ Quyá»n', address:'195 Tráº§n PhÃº, Háº£i PhÃ²ng', hours:{0:[['10:00','21:00']]}, price_min:40000, price_max:80000, why:'Nem nÃ³ng cuá»‘n táº¡i chá»—', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'nemchua',  name:'Nem chua An Thá»', area:'An LÃ£o', address:'An Thá» (ship toÃ n quá»‘c)', hours:{0:[['08:00','21:00']]}, price_min:0, price_max:0, why:'Äáº·t theo set 10â€“50 cÃ¡i', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'nemchua',  name:'Nem Chua BÃ  Cá»¥', area:'â€”', address:'Háº£i PhÃ²ng', hours:{0:[['08:00','20:00']]}, price_min:10000, price_max:20000, why:'DÃ¢n dÃ£, dá»… tÃ¬m', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'buncacay', name:'BÃºn cÃ¡ cay 153 LÃª Lai', area:'LÃª Lai', address:'153 LÃª Lai, Háº£i PhÃ²ng', hours:{0:[['06:00','12:30']]}, price_min:20000, price_max:30000, why:'CÃ¡ rÃ´ giÃ²n/má»m', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'buncacay', name:'BÃºn cÃ¡ cay Cáº­u ÄoÃ nh', area:'Nhiá»u cÆ¡ sá»Ÿ', address:'HP (tham kháº£o fanpage)', hours:{0:[['06:30','13:30'],['17:30','21:00']]}, price_min:35000, price_max:35000, why:'Tháº­p cáº©m phong phÃº', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'buncacay', name:'BÃºn cÃ¡ cay 66 LÃª Lá»£i', area:'Há»“ng BÃ ng', address:'66 LÃª Lá»£i, Háº£i PhÃ²ng', hours:{0:[['06:00','12:30']]}, price_min:30000, price_max:45000, why:'NÆ°á»›c dÃ¹ng cay ná»“ng, cÃ¡ giÃ²n', href:'#'},

  // ÄÃ€ Náº´NG
  {city:'ÄÃ  Náºµng', dish:'miquang', name:'MÃ¬ Quáº£ng Bá»‡t', area:'â€”', address:'ÄÃ  Náºµng', hours:{0:[['06:00','21:00']]}, price_min:40000, price_max:80000, why:'Topping Ä‘á»§ vá»‹', href:'#'},
  {city:'ÄÃ  Náºµng', dish:'miquang', name:'MÃ¬ Quáº£ng BÃ  Lá»¯', area:'Háº£i ChÃ¢u', address:'24 Tráº§n Cao VÃ¢n, ÄÃ  Náºµng', hours:{0:[['06:00','21:00']]}, price_min:30000, price_max:55000, why:'Truyá»n thá»‘ng', href:'#'},
  {city:'ÄÃ  Náºµng', dish:'miquang', name:'MÃ¬ Quáº£ng CÃ´ SÃ¡u', area:'ÄÃ  Náºµng', address:'ÄÃ  Náºµng', hours:{0:[['06:00','13:00']]}, price_min:30000, price_max:60000, why:'Sá»£i mÃ¬ dai, nÆ°á»›c nhÃ¢n Ä‘áº­m', href:'/mi-quang-co-sau.html'},
  {city:'ÄÃ  Náºµng', dish:'banhtrangthitheo', name:'BÃ¡nh trÃ¡ng cuá»‘n thá»‹t heo BÃ  HÆ°á»ng', area:'Háº£i ChÃ¢u', address:'460 2 ThÃ¡ng 9, ÄÃ  Náºµng', hours:{0:[['06:00','22:00']]}, price_min:95000, price_max:95000, why:'Rau sá»‘ng phong phÃº', href:'#'},
  {city:'ÄÃ  Náºµng', dish:'banhtrangthitheo', name:'BÃ¡nh trÃ¡ng CÆ¡m Äáº¡i Lá»™c', area:'ÄÃ  Náºµng', address:'ÄÃ  Náºµng', hours:{0:[['10:00','21:00']]}, price_min:0, price_max:0, why:'ÄÃºng cháº¥t Äáº¡i Lá»™c, máº¯m nÃªm chuáº©n', href:'/banh-trang-com-dai-loc.html'},
  {city:'ÄÃ  Náºµng', dish:'caolau', name:'Cao láº§u Phá»‘ Há»™i', area:'Háº£i ChÃ¢u', address:'63 Phan ÄÄƒng LÆ°u, ÄÃ  Náºµng', hours:{0:[['06:00','21:00']]}, price_min:0, price_max:0, why:'Chuáº©n vá»‹ Há»™i An', href:'#'},
  {city:'ÄÃ  Náºµng', dish:'caolau', name:'Cao láº§u PhÆ°á»›c', area:'SÆ¡n TrÃ ', address:'18/3 Nguyá»…n Duy Hiá»‡u, ÄÃ  Náºµng', hours:{0:[['06:00','11:00']]}, price_min:0, price_max:0, why:'BÃ¡n buá»•i sÃ¡ng', href:'#'},

  // HUáº¾
  {city:'Huáº¿', dish:'bunbo', name:'BÃºn BÃ² BÃ  Nga', area:'PhÃº CÃ¡t', address:'5 Nguyá»…n Du, Huáº¿', hours:{0:[['06:00','20:30']]}, price_min:25000, price_max:45000, why:'Äáº­m vá»‹ Huáº¿', href:'#'},
  {city:'Huáº¿', dish:'bunbo', name:'BÃºn bÃ² Huáº¿ Má»¹ TÃ¢m', area:'VÄ©nh Ninh', address:'3 Tráº§n Cao VÃ¢n, Huáº¿', hours:{0:[['07:00','22:00']]}, price_min:30000, price_max:80000, why:'Topping Ä‘a dáº¡ng', href:'#'},
  {city:'Huáº¿', dish:'bunbo', name:'BÃºn bÃ² O Liá»…u', area:'Huáº¿', address:'Huáº¿', hours:{0:[['06:00','21:00']]}, price_min:30000, price_max:60000, why:'NÆ°á»›c dÃ¹ng trong, cháº£ bÃ² ngon', href:'/bun-bo-o-lieu.html'},
  {city:'Huáº¿', dish:'che', name:'ChÃ¨ Cáº§m', area:'Vá»¹ Dáº¡', address:'10 Nguyá»…n Sinh Cung, Huáº¿', hours:{0:[['16:00','19:30']]}, price_min:15000, price_max:30000, why:'ChÃ¨ cung Ä‘Ã¬nh', href:'#'},
  {city:'Huáº¿', dish:'che', name:'ChÃ¨ Ã”ng Láº¡c', area:'Huáº¿', address:'Huáº¿', hours:{0:[['15:00','22:00']]}, price_min:10000, price_max:30000, why:'QuÃ¡n chÃ¨ ná»•i tiáº¿ng lÃ¢u nÄƒm', href:'/che-ong-lac.html'},
  {city:'Huáº¿', dish:'che', name:'ChÃ¨ Huáº¿ 20 mÃ³n', area:'Huáº¿', address:'Huáº¿', hours:{0:[['15:00','22:00']]}, price_min:10000, price_max:30000, why:'Menu 20 mÃ³n Ä‘áº·c sáº¯c', href:'/che-hue-20-mon.html'},
  {city:'Huáº¿', dish:'comhen', name:'CÆ¡m háº¿n Hoa ÄÃ´ng', area:'â€”', address:'64 Kiá»‡t 7 Æ¯ng BÃ¬nh, Huáº¿', hours:{0:[['06:00','20:00']]}, price_min:20000, price_max:20000, why:'Äáº·c biá»‡t, ráº»', href:'#'},
  {city:'Huáº¿', dish:'comhen', name:'CÆ¡m háº¿n BÃ© LiÃªm', area:'Huáº¿', address:'Huáº¿', hours:{0:[['06:00','20:00']]}, price_min:15000, price_max:25000, why:'Vá»‹ háº¿n Ä‘áº­m, máº¯m ruá»‘c thÆ¡m', href:'/com-hen-be-liem.html'},
  {city:'Huáº¿', dish:'comhen', name:'CÆ¡m háº¿n BÃ  Cam', area:'Huáº¿', address:'Huáº¿', hours:{0:[['06:00','20:00']]}, price_min:15000, price_max:25000, why:'Äáº­m cháº¥t dÃ¢n dÃ£ Huáº¿', href:'/com-hen-ba-cam.html'},

  // Cáº¦N THÆ 
  {city:'Cáº§n ThÆ¡', dish:'laumam', name:'Láº©u máº¯m Cáº§n ThÆ¡', area:'Ninh Kiá»u', address:'162/18 Tráº§n Ngá»c Quáº¿, Cáº§n ThÆ¡', hours:{0:[['09:30','22:30']]}, price_min:0, price_max:0, why:'Rau Ä‘á»“ng quÃª', href:'#'},
  {city:'Cáº§n ThÆ¡', dish:'laumam', name:'Láº©u máº¯m Kiá»u Trinh', area:'XuÃ¢n KhÃ¡nh, Ninh Kiá»u', address:'26 Tráº§n KhÃ¡nh DÆ°, Ninh Kiá»u, Cáº§n ThÆ¡', hours:{0:[['11:00','21:00']]}, price_min:200000, price_max:450000, why:'Äáº­m Ä‘Ã  chuáº©n vá»‹, rau phong phÃº', href:'/lau-mam-kieu-trinh.html'},
  {city:'Cáº§n ThÆ¡', dish:'laumam', name:'Láº©u máº¯m QuÃª Mi', area:'Thá»›i BÃ¬nh, Ninh Kiá»u', address:'77 Huá»³nh CÆ°Æ¡ng, Ninh Kiá»u, Cáº§n ThÆ¡', hours:{0:[['10:00','22:00']]}, price_min:250000, price_max:450000, why:'Máº¯m cÃ¡ linh/sáº·c lá»c ká»¹, vá»‹ cÃ¢n báº±ng', href:'/lau-mam-que-mi.html'},
  {city:'Cáº§n ThÆ¡', dish:'calocnuongtrui', name:'Äá»“ng Xanh', area:'Ninh Kiá»u', address:'211 Nguyá»…n VÄƒn Linh, Cáº§n ThÆ¡', hours:{0:[['08:00','03:00']]}, price_min:39000, price_max:39000, why:'Má»Ÿ khuya', href:'#'},
  {city:'Cáº§n ThÆ¡', dish:'vitnauchao', name:'Vá»‹t Náº¥u Chao Cáº©m TÃº', area:'Ninh Kiá»u', address:'1 LÃ½ Tá»± Trá»ng, Cáº§n ThÆ¡', hours:{0:[['09:00','22:00']]}, price_min:150000, price_max:200000, why:'Äáº­m vá»‹, há»£p lÃ½', href:'#'},

  // Há»’ CHÃ MINH
  {city:'Há»“ ChÃ­ Minh', dish:'comtam', name:'CÆ¡m táº¥m Ba Ghiá»n', area:'PhÃº Nhuáº­n', address:'84 Äáº·ng VÄƒn Ngá»¯, TP.HCM', hours:{0:[['06:00','22:00']]}, price_min:40000, price_max:70000, why:'SÆ°á»n dÃ y, cÆ¡m má»m', href:'#'},
  {city:'Há»“ ChÃ­ Minh', dish:'banhmi', name:'BÃ¡nh mÃ¬ Huynh Hoa', area:'Quáº­n 1', address:'26 LÃª Thá»‹ RiÃªng, TP.HCM', hours:{0:[['13:00','23:00']]}, price_min:73000, price_max:73000, why:'Pate & cháº£ Ä‘áº§y', href:'#'},
  {city:'Há»“ ChÃ­ Minh', dish:'phalau', name:'PhÃ¡ láº¥u bÃ² CÃ¢y TrÃ¢m', area:'GÃ² Váº¥p', address:'208 CÃ¢y TrÃ¢m, TP.HCM', hours:{0:[['15:00','21:00']]}, price_min:30000, price_max:60000, why:'CÃ³ mÃ¬/bÃ¡nh mÃ¬ phÃ¡ láº¥u', href:'#'}
];

const DISH_LABELS = { pho:'Phá»Ÿ', buncha:'BÃºn cháº£', chaca:'Cháº£ cÃ¡',
  nemcuabe:'Nem cua bá»ƒ', nemchua:'Nem chua', buncacay:'BÃºn cÃ¡ cay',
  miquang:'MÃ¬ Quáº£ng', banhtrangthitheo:'BÃ¡nh trÃ¡ng thá»‹t heo', caolau:'Cao láº§u',
  bunbo:'BÃºn bÃ² Huáº¿', che:'ChÃ¨', comhen:'CÆ¡m háº¿n',
  comtam:'CÆ¡m táº¥m', banhmi:'BÃ¡nh mÃ¬', phalau:'PhÃ¡ láº¥u',
  laumam:'Láº©u máº¯m', calocnuongtrui:'CÃ¡ lÃ³c nÆ°á»›ng trui', vitnauchao:'Vá»‹t náº¥u chao'
};

const CITY_SIGNATURES = {
  'HÃ  Ná»™i':['pho','buncha','chaca'],
  'Háº£i PhÃ²ng':['buncacay','nemcuabe','nemchua'],
  'ÄÃ  Náºµng':['miquang','banhtrangthitheo','caolau'],
  'Huáº¿':['bunbo','che','comhen'],
  'Cáº§n ThÆ¡':['laumam','calocnuongtrui','vitnauchao'],
  'Há»“ ChÃ­ Minh':['comtam','banhmi','phalau']
};

// ===== parsing =====
function detectIntent(raw){
  const t = rmAcc(raw).trim();

  // ChÃ o há»i / táº¡m biá»‡t
  if (/^(hi+|hello+|xin chao|chao+|yo|he+l+o+)$/.test(t)) return {type:'greet'};
  if (/^(bye|tam biet|see you|ngu ngon|hen gap)$/.test(t)) return {type:'bye'};

  // Giá»›i thiá»‡u báº£n thÃ¢n / há»i vá» bot
  if (/(toi|minh|tao)\s+(ten|la)\b/.test(t)) return {type:'intro'};
  if (/(may|ban|bot)\s+(la ai|ten gi|ai tao|an gi|lam gi)/.test(t)) return {type:'about'};

  // Xin gá»£i Ã½ chung (â€œÄ‘Ã³i quÃ¡â€, â€œtÆ° váº¥n mÃ³n Ä‘iâ€)
  if (/(doi qua|an gi|goi y|tu van|cho minh vai quan|keo di an)/.test(t)) return {type:'ask_suggest'};

  return {type:'normal'};
}

function parseBudgetVND(text){
  const t = norm(text).replace(/(vnd|dong|Ä‘)/g,'').replace(/\s/g,'');
  // 2 ngÆ°á»i / n ngÆ°á»i
  let people = 1;
  const pm = t.match(/(\d+)\s*(nguoi|ng)/); if (pm) people = Math.max(1, +pm[1]);

  // 40-60, 40â€“60, 40k-60k, 100-150
  let m = t.match(/(\d{2,4})k?[â€“-](\d{2,4})k?/);
  if (m) {
    const lo = +m[1]*1000, hi = +m[2]*1000;
    return {min: lo*people, max: hi*people, raw: `${m[1]}â€“${m[2]}k${people>1?`/~${people}p`:''}`};
  }
  // ~50k, táº§m70, 1xx
  m = t.match(/(~|tam|khoang)?(\d{2,3})(xx)?k?/);
  if (m){
    let v = +m[2];
    if (m[3]==='xx') v = v*10+0; // 1xx -> 100
    v *= 1000;
    const span = Math.round(v*0.2);
    return {min:(v-span)*people, max:(v+span)*people, raw:`~${Math.round(v/1000)}k${people>1?`/~${people}p`:''}`};
  }
  return null;
}



function placePriceSpan(p){
  const lo = p.price_min || 0, hi = p.price_max || (p.price_min || 0);
  return {lo, hi, mid: lo && hi ? Math.round((lo+hi)/2) : (lo || hi || 0)};
}
function budgetOverlap(place, budget){
  if(!budget) return 'unknown';
  const {lo,hi,mid} = placePriceSpan(place);
  if(!lo && !hi) return 'unknown';
  // khá»›p khi khoáº£ng giÃ¡ giao nhau
  const overlap = !(hi < budget.min || lo > budget.max);
  if (overlap) return 'fit';
  // â€œnearâ€ náº¿u mid náº±m trong Â±20% so vá»›i biÃªn gáº§n nháº¥t cá»§a budget
  const edge = (mid < budget.min) ? budget.min : budget.max;
  const diff = Math.abs(mid - edge);
  const near = diff <= edge * 0.2; // <=20%
  return near ? 'near' : 'off';
}


function parseTime(text){
  const t = rmAcc(text);
  const today = new Date().getDay();
  let dow=today, minuteOfDay=null;
  const m = t.match(/(\d{1,2})(?:h|:)(\d{0,2})?/);
  if(m){ minuteOfDay=(+m[1])*60 + (m[2]?+m[2]:0); }
  else if(t.includes('sang')) minuteOfDay=8*60;
  else if(t.includes('trua')) minuteOfDay=12*60;
  else if(t.includes('chieu')) minuteOfDay=17*60;
  else if(t.includes('toi')) minuteOfDay=19*60;
  return {dow, minuteOfDay};
}
// === City detection: alias + auto-match tá»« dataset ===
const KNOWN_CITIES = [...new Set(PLACES.map(p => p.city))];

// CÃ¡c alias/phá»• biáº¿n & viáº¿t táº¯t thá»§ cÃ´ng cho má»™t sá»‘ TP lá»›n
const CITY_ALIASES = [
  [/ha\s*noi|hanoi|\bhn\b/, 'HÃ  Ná»™i'],
  [/hai\s*phong|haiphong|\bhp\b/, 'Háº£i PhÃ²ng'],
  [/da\s*nang|danang|\bdn\b/, 'ÄÃ  Náºµng'],
  [/\bhue\b/, 'Huáº¿'],
  [/can\s*tho|cantho|\bct\b/, 'Cáº§n ThÆ¡'],
  [/ho\s*chi\s*minh|tp[\.\s]*hcm|tphcm|\bhcm\b|sai\s*gon|saigon|\bsg\b/, 'Há»“ ChÃ­ Minh'],
];

// Táº¡o tokens Ä‘á»™ng tá»« dataset (vÃ­ dá»¥ â€œhai phongâ€ => hp)
const CITY_TOKENS = KNOWN_CITIES.map(name => {
  const token = rmAcc(name).replace(/\s+/g, ' ').trim();          // "hai phong"
  const initials = token.split(' ').map(w => w[0]).join('');      // "hp"
  return { name, token, initials };
});

function parseCity(text){
  const t = norm(text);
  // â€œá»Ÿ hcmâ€, â€œÄ‘ang á»Ÿ hÃ  ná»™iâ€, â€œqua Ä‘Ã  náºµngâ€
  const cityHit = t.match(/\b(o|o|dang o|qua|tai)\s+([a-z\s\.]+)$/);
  const candidates = [
    [/ha\s*noi|hn|hanoi/, 'HÃ  Ná»™i'],
    [/hai\s*phong|hp|haiphong/, 'Háº£i PhÃ²ng'],
    [/da\s*nang|dn|danang/, 'ÄÃ  Náºµng'],
    [/\bhue\b/, 'Huáº¿'],
    [/can\s*tho|ct|cantho/, 'Cáº§n ThÆ¡'],
    [/ho\s*chi\s*minh|tp\.?\s*hcm|tphcm|hcm|sai\s*gon|sg/, 'Há»“ ChÃ­ Minh'],
  ];
  for (const [re, name] of candidates) if (re.test(t)) return name;
  if (cityHit){
    const tail = cityHit[2];
    for (const [re, name] of candidates) if (re.test(tail)) return name;
  }
  return null;
}


function parseDish(text){
  const t = rmAcc(text);
  if(t.includes('pho')) return 'pho';
  if(t.includes('bun cha')) return 'buncha';
  if(t.includes('cha ca')) return 'chaca';
  if(t.includes('nem cua')) return 'nemcuabe';
  if(t.includes('nem chua')) return 'nemchua';
  if(t.includes('bun ca cay')) return 'buncacay';
  if(t.includes('mi quang')) return 'miquang';
  if(t.includes('banh trang thit heo')) return 'banhtrangthitheo';
  if(t.includes('cao lau')) return 'caolau';
  if(t.includes('bun bo')) return 'bunbo';
  if(/\bche\b/.test(t)) return 'che';
  if(t.includes('com hen')) return 'comhen';
  if(t.includes('com tam')) return 'comtam';
  if(t.includes('banh mi')) return 'banhmi';
  if(t.includes('pha lau')) return 'phalau';
  if(t.includes('lau mam')) return 'laumam';
  if(t.includes('ca loc nuong')||t.includes('nuong trui')) return 'calocnuongtrui';
  if(t.includes('vit nau chao')) return 'vitnauchao';
  return null;
}
function saidNoDish(text){
  const t = rmAcc(text).trim();
  return /\b(chua|chua co|chua biet|chua nghi|chua quyet|khong|ko|k|khong biet|khong ro)\b/.test(t);
}
function saidYes(text){
  const t = rmAcc(text).trim();
  return /\b(roi|co|oke?|okela|da|da roi|chap nhan|co roi|di|ok)\b/.test(t);
}

// ===== matching =====
function isOpenAt(place,dow,minuteOfDay){
  const segs = place.hours?.[dow] || place.hours?.[0] || [];
  if (!segs.length) return null; // unknown
  if (minuteOfDay==null) return true;
  return segs.some(([f,t])=>{
    const [fh,fm]=f.split(':').map(Number), [th,tm]=t.split(':').map(Number);
    const S=fh*60+fm, E=th*60+tm; return minuteOfDay>=S && minuteOfDay<=E;
  });
}

function budgetOk(place,budget){
  if(!budget) return true;
  const lo=place.price_min||0, hi=place.price_max||1e9;
  return !(hi<budget.min || lo>budget.max);
}
function formatPrice(p){
  if(!p) return 'Tham kháº£o táº¡i quÃ¡n';
  if(p.price_min && p.price_max && p.price_min===p.price_max) return (p.price_min/1000|0)+'k';
  if(p.price_min && p.price_max) return (p.price_min/1000|0)+'â€“'+(p.price_max/1000|0)+'k';
  if(p.price_min) return 'tá»« '+(p.price_min/1000|0)+'k';
  return 'Tham kháº£o';
}
function formatHours(h){
  const segs=(h&&(h[new Date().getDay()]||h[0]))||[];
  if(!segs.length) return 'Giá» tham kháº£o';
  return segs.map(([f,t])=>`${f}â€“${t}`).join(', ');
}
function gmapUrl(place){
  // dÃ¹ng Directions API link Ä‘á»ƒ má»Ÿ app Google Maps tá»‘t hÆ¡n
  return 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(place.address);
}

function searchPlaces(city, dish, filtersText=''){
  const budget = parseBudgetVND(filtersText);
  const {dow, minuteOfDay} = parseTime(filtersText);

  const candidates = PLACES
    .filter(p => (!city || p.city === city) && (!dish || p.dish === dish))
    .map(p => {
      let score = 0;
      if (dish && p.dish === dish) score += 3;
      if (isOpenAt(p, dow, minuteOfDay)) score += 1;

      let fit = budgetOverlap(p, budget);
      if (fit === 'fit') score += 6;        // máº¡nh tay Æ°u tiÃªn Ä‘Ãºng ngÃ¢n sÃ¡ch
      else if (fit === 'near') score += 2;  // gáº§n ngÃ¢n sÃ¡ch
      else if (fit === 'unknown') score += 0;

      return {p, score, fit};
    })
    .sort((a,b)=> b.score - a.score);

  // tÃ¡ch 3 nhÃ³m
  const fits   = candidates.filter(x => x.fit === 'fit').map(x=>x.p);
  const nears  = candidates.filter(x => x.fit === 'near').map(x=>x.p);
  const others = candidates.filter(x => x.fit !== 'fit' && x.fit !== 'near').map(x=>x.p);

  return { fits: fits.slice(0,3), nears: nears.slice(0,3), others: others.slice(0,3), budget };
}


// ===== UI builders =====
function placeCards(title, places, fitMap={}){
  return `
    <div><strong>${title}</strong></div>
    <div class="mini-grid">
      ${places.map(p=>{
        const badge = fitMap[p.name] || '';
        return `
        <div class="mini">
          <h4>${p.name}</h4>
          <p>ğŸ“ ${p.area}<br>ğŸ—ºï¸ ${p.address}<br>ğŸ•’ ${formatHours(p.hours)}<br>ğŸ’¸ ${formatPrice(p)}</p>
          ${badge ? `<p style="margin-top:6px"><b>${badge}</b></p>` : `<p style="margin-top:6px">${p.why||''}</p>`}
          <div class="actions">
            <a class="btn ghost" href="${gmapUrl(p)}" target="_blank" rel="noopener">ğŸ“ Chá»‰ Ä‘Æ°á»ng</a>
          </div>
        </div>`}).join('')}
    </div>
    <p class="small">ğŸ’¡ Tip: GÃµ â€œmÃ³n + thÃ nh phá»‘ + thá»i gian + ngÃ¢n sÃ¡châ€. VÃ­ dá»¥: â€œbÃºn cháº£ HoÃ n Kiáº¿m trÆ°a nay 40â€“50kâ€.</p>`;
}




function cityChips(title='Báº¡n muá»‘n xem thÃ nh phá»‘ khÃ¡c?'){
  const cities=['HÃ  Ná»™i','Háº£i PhÃ²ng','ÄÃ  Náºµng','Huáº¿','Cáº§n ThÆ¡','Há»“ ChÃ­ Minh'];
  const el = addBubble(`
    <div><strong>${title}</strong></div>
    <div class="chips">
      ${cities.map(c=>`<span class="chip" data-city="${c}">${c}</span>`).join('')}
    </div>`);
  el.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      STATE.city = ch.getAttribute('data-city'); STATE.dish=null; STATE.askDishPending=true; clearPromptFlag();
      sayOnce('askDish', `Báº¡n Ä‘ang á»Ÿ <b>${STATE.city}</b>. Báº¡n <b>Ä‘Ã£ dá»± Ä‘á»‹nh Äƒn mÃ³n gÃ¬ chÆ°a</b>? (CÃ³: gÃµ tÃªn mÃ³n â€¢ ChÆ°a: gÃµ "chÆ°a biáº¿t" Ä‘á»ƒ mÃ¬nh gá»£i Ã½)`);
    });
  });
}
function dishSuggestCards(city){
  const dishes = CITY_SIGNATURES[city] || [];
  const picks = dishes.map(d => {
    const {fits, nears, others} = searchPlaces(city, d);
    const sample = (fits[0] || nears[0] || others[0]) || null;
    return { dish: d, sample };
  }).filter(x => x.sample);

  const html = `
    <div><strong>MÃ³n ná»•i báº­t á»Ÿ ${city}</strong></div>
    <div class="mini-grid">
      ${picks.map(x=>`
        <div class="mini">
          <h4>${DISH_LABELS[x.dish]}</h4>
          <p>VÃ­ dá»¥: <b>${x.sample.name}</b> â€” ${formatPrice(x.sample)}</p>
          <button class="btn" data-choose="${x.dish}">Chá»n mÃ³n nÃ y</button>
        </div>`).join('')}
    </div>
    <p class="small">Báº¡n cÃ³ thá»ƒ báº¥m chá»n hoáº·c gÃµ mÃ³n khÃ¡c tuá»³ thÃ­ch.</p>`;
  const el = addBubble(html,'bot');
  el.querySelectorAll('[data-choose]').forEach(b=>{
    const d=b.getAttribute('data-choose');
    b.addEventListener('click', ()=>{
      STATE.dish=d; STATE.askDishPending=false; clearPromptFlag();
      showResultsForCityDish(STATE.city,d);
    });
  });
  LAST_PROMPT='suggestions';
}

function offerNextActions(){
  addBubble('Náº¿u báº¡n Ä‘Ã£ chá»n quÃ¡n rá»“i, chÃºc báº¡n <b>Äƒn ngon miá»‡ng</b> ğŸ˜‹. Muá»‘n khÃ¡m phÃ¡ á»Ÿ thÃ nh phá»‘ khÃ¡c khÃ´ng?');
  cityChips('KhÃ¡m phÃ¡ thÃ nh phá»‘ khÃ¡c');
}
function showResultsForCityDish(city, dish, extras=''){
  const {fits, nears, others, budget} = searchPlaces(city, dish, extras);

  // map nhÃ£n
  const fitMap = {};
  fits.forEach(p => fitMap[p.name]  = 'âœ… Há»£p ngÃ¢n sÃ¡ch');
  nears.forEach(p => fitMap[p.name] = 'â†— HÆ¡i vÆ°á»£t má»™t chÃºt (â‰ˆÂ±20%)');

  if (budget && !fits.length) {
    // KhÃ´ng cÃ³ quÃ¡n Ä‘Ãºng ngÃ¢n sÃ¡ch
    const title = `${DISH_LABELS[dish]} á»Ÿ ${city}: gáº§n vá»›i táº§m giÃ¡ báº¡n Ä‘Æ°a`;
    const picks = (nears.length ? nears : others).slice(0,3);

    addBubble(
      `Tiáº¿c quÃ¡, mÃ¬nh <b>chÆ°a tÃ¬m Ä‘Æ°á»£c quÃ¡n Ä‘Ãºng táº§m ${budget.raw}</b> ğŸ˜¢. 
      NhÆ°ng Ä‘Ã¢y lÃ  vÃ i chá»— <b>gáº§n nháº¥t</b> (chÃªnh nháº¹ hoáº·c giÃ¡ phá»• biáº¿n hÆ¡n):`,
      'bot'
    );
    addBubble(placeCards(title, picks, fitMap));
    offerNextActions();
    LAST_RESULTS = picks;
    return;
  }

  const list = fits.length ? fits : (nears.length ? nears : others);
  if(!list.length){ addBubble('ChÆ°a tháº¥y quÃ¡n khá»›p. Báº¡n thá»­ mÃ³n khÃ¡c hoáº·c ná»›i ngÃ¢n sÃ¡ch nhÃ©.'); return; }

  LAST_RESULTS = list;
const title = `${DISH_LABELS[dish]} á»Ÿ ${city}${budget ? ` (lá»c theo ${budget.raw})` : ''}`;
  addBubble(placeCards(title, list, fitMap));
  offerNextActions();
}


// ===== hiá»ƒu ngÆ°á»i dÃ¹ng â€œchá»n quÃ¡n nÃ y/ok/Ä‘iâ€ =====
function tryDetectChosenPlace(text){
  const t = rmAcc(text);
  if(!LAST_RESULTS.length) return null;
  // tÃªn khá»›p má» + cÃ³ tá»« khoÃ¡ xÃ¡c nháº­n
  const positive = /(ok|oke?|chot|chot nhe|di|qua do|chac vay|chuan|chot quan|chon|toi chon|minh chon|co ve ok|on)/.test(t);
  for(const p of LAST_RESULTS){
    const name = rmAcc(p.name);
    if(positive || t.includes(name) || name.split(' ').some(w=>w.length>2 && t.includes(w))){
      return p;
    }
  }
  return null;
}

// ===== conversation =====
function detectIntent(raw){
  const t = norm(raw);

  // greeting/bye
  if (/^(hi+|hello+|xin chao|chao|yo|he+l+o+)$/.test(t)) return {type:'greet'};
  if (/^(bye|tam biet|see you|toitruoc|ngu ngon)$/.test(t)) return {type:'bye'};

  // giá»›i thiá»‡u báº£n thÃ¢n / trÃªu
  if (/(toi|minh|tao)\s+(ten|la)\b/.test(t)) return {type:'intro'};
  if (/(may|ban|bot)\s+(la ai|ten gi|an gi|lam gi|ai tao)/.test(t)) return {type:'about'};

  // xin gá»£i Ã½ chung kiá»ƒu â€œÄ‘Ã³i quÃ¡â€, â€œtÆ° váº¥n mÃ³n Ä‘iâ€
  if (/(doi qua|an gi|goi y|tu van|cho minh vai quan|keo di an)/.test(t)) return {type:'ask_suggest'};

  return {type:'normal'};
}


function replyNoData(){
  addBubble(
    'Ui, khu Ä‘Ã³ mÃ¬nh <b>chÆ°a cÃ³ dá»¯ liá»‡u</b> ğŸ˜…. Hiá»‡n mÃ¬nh â€œrÃ nhâ€ <b>HÃ  Ná»™i, Háº£i PhÃ²ng, ÄÃ  Náºµng, Huáº¿, Cáº§n ThÆ¡, TP.HCM</b> thÃ´i nha ğŸœ.',
    'bot'
  );
  cityChips('Chá»n thÃ nh phá»‘ gáº§n báº¡n nháº¥t:');
}



function ask(msg){
  const userText = msg.trim();
  if (!userText) return;

  // --- 1) Nháº­n diá»‡n small-talk & Ä‘iá»u hÆ°á»›ng sá»›m
  const intent = detectIntent(userText);
  if (intent.type !== 'normal') {
    addBubble(esc(userText),'user');
    const cityList = '<b>HÃ  Ná»™i, Háº£i PhÃ²ng, ÄÃ  Náºµng, Huáº¿, Cáº§n ThÆ¡, TP.HCM</b>';

    if (intent.type === 'greet') {
      return sayOnce('intro',
        'ChÃ o báº¡n ğŸ‘‹ MÃ¬nh chuyÃªn gá»£i Ã½ quÃ¡n theo <b>mÃ³n/khu/giá»/ngÃ¢n sÃ¡ch</b>. Báº¡n Ä‘ang á»Ÿ thÃ nh phá»‘ nÃ o Ä‘á»ƒ mÃ¬nh báº­t mode â€œthá»• Ä‘á»‹aâ€ nÃ¨?');
    }
    if (intent.type === 'bye') {
      return addBubble('Háº¹n báº¡n bá»¯a sau nha ğŸ‘‹ LÃºc Ä‘Ã³i cá»© gá»i mÃ¬nh!', 'bot');
    }
    if (intent.type === 'intro') {
      return addBubble('Ráº¥t vui Ä‘Æ°á»£c gáº·p báº¡n ğŸ˜Š Cho mÃ¬nh biáº¿t báº¡n Ä‘ang á»Ÿ Ä‘Ã¢u Ä‘á»ƒ giá»›i thiá»‡u Ä‘áº·c sáº£n quanh Ä‘Ã³ nhÃ©?', 'bot');
    }
    if (intent.type === 'about') {
      return addBubble(`MÃ¬nh lÃ  trá»£ lÃ½ Äƒn ngon ğŸœ â€“ hiá»‡n â€œrÃ nhâ€ ${cityList}. Cá»© nÃ³i <b>mÃ³n + thÃ nh phá»‘</b>, mÃ¬nh lá»c quÃ¡n há»£p giá» & tÃºi tiá»n cho báº¡n.`, 'bot');
    }
    if (intent.type === 'ask_suggest') {
      addBubble('Ok, báº­t radar Ä‘á»“ Äƒn ğŸ½ï¸. Báº¡n Ä‘ang á»Ÿ thÃ nh phá»‘ nÃ o Ä‘á»ƒ mÃ¬nh khoanh vÃ¹ng áº¡?','bot');
      return cityChips('Chá»n nhanh thÃ nh phá»‘ cá»§a báº¡n');
    }
  }

  // --- 2) Ghi láº¡i lá»i ngÆ°á»i dÃ¹ng
  addBubble(esc(userText),'user');

  // --- 3) NgÆ°á»i dÃ¹ng â€œchá»‘t quÃ¡nâ€
  const chosen = tryDetectChosenPlace(userText);
  if (chosen) {
    addBubble(`Tuyá»‡t! <b>${chosen.name}</b> lÃ  lá»±a chá»n á»•n Ä‘Ã³. ChÃºc báº¡n <b>Äƒn ngon miá»‡ng</b> ğŸ˜‹.`, 'bot');
    cityChips('Báº¡n muá»‘n mÃ¬nh gá»£i Ã½ á»Ÿ thÃ nh phá»‘ khÃ¡c khÃ´ng?');
    resetState();
    return;
  }

  // --- 4) PARSE: city + dish
  const prevCity = STATE.city;
  const city = parseCity(userText);
  const dish = parseDish(userText);

// Heuristic: ngÆ°á»i dÃ¹ng gÃµ 1 Ä‘á»‹a danh ngáº¯n khÃ´ng náº±m trong danh sÃ¡ch
const pure = norm(userText).replace(/[^a-z\s]/g,' ').trim();
const words = pure.split(/\s+/).filter(Boolean);
// khÃ´ng báº¯t Ä‘Æ°á»£c city & dish, chuá»—i ngáº¯n (1â€“3 tá»«) -> coi nhÆ° Ä‘á»‹a danh ngoÃ i vÃ¹ng dá»¯ liá»‡u
if (!city && !dish && words.length > 0 && words.length <= 3) {
  return replyNoData();
}


  // 4a) Nháº¯c tá»›i Ä‘á»‹a danh ngoÃ i vÃ¹ng dá»¯ liá»‡u â†’ má»i chá»n TP há»— trá»£
  if (!city && /\b(tinh|thanh|huyen|xa|thi tran|pho|o\s+[a-z]+)/.test(rmAcc(userText))) {
    return replyNoData(); // helper hiá»ƒn thá»‹ message + cityChips(...)
  }

  // 4b) Cáº­p nháº­t state
  if (city && city !== STATE.city) { STATE.city = city; clearPromptFlag(); }
  if (dish) { STATE.dish = dish; STATE.askDishPending = false; clearPromptFlag(); }

  // 4c) Äang há»i mÃ³n mÃ  user Ä‘á»•i city â†’ chuyá»ƒn máº¡ch khÃ©o
  if (STATE.askDishPending && city && city !== prevCity) {
    STATE.city = city;
    if (!dish) {
      return sayOnce('askDish', `Ok, chuyá»ƒn sang <b>${STATE.city}</b> nha. Báº¡n <b>Ä‘á»‹nh Äƒn mÃ³n gÃ¬</b>? (vd: phá»Ÿ, bÃºn cháº£, mÃ¬ quáº£ng...)`);
    }
    showResultsForCityDish(STATE.city, dish, userText);
    return;
  }

  // --- 5) FLOW há»™i thoáº¡i theo slot
  // 5a) Äang chá» ngÆ°á»i dÃ¹ng nÃ³i mÃ³n
  if (STATE.askDishPending) {
    if (dish) { showResultsForCityDish(STATE.city, STATE.dish, userText); return; }
    if (saidNoDish(userText)) { STATE.askDishPending = false; dishSuggestCards(STATE.city); return; }
    if (saidYes(userText)) { return sayOnce('askWhich','Báº¡n Ä‘á»‹nh Äƒn <b>mÃ³n nÃ o</b>? (vd: bÃºn cháº£, phá»Ÿ, mÃ¬ quáº£ng...)'); }
    return sayOnce('clarify','Báº¡n Ä‘Ã£ cÃ³ mÃ³n dá»± Ä‘á»‹nh chÆ°a? CÃ³ thÃ¬ gÃµ tÃªn mÃ³n; chÆ°a thÃ¬ gÃµ "chÆ°a biáº¿t" Ä‘á»ƒ mÃ¬nh gá»£i Ã½.');
  }

  // 5b) CÃ³ city nhÆ°ng chÆ°a dish â†’ há»i mÃ³n
  if (STATE.city && !STATE.dish) {
    STATE.askDishPending = true;
    return sayOnce('askDish', `Báº¡n Ä‘ang á»Ÿ <b>${STATE.city}</b>. Báº¡n <b>Ä‘Ã£ dá»± Ä‘á»‹nh Äƒn mÃ³n gÃ¬ chÆ°a</b>? (CÃ³: gÃµ tÃªn mÃ³n â€¢ ChÆ°a: gÃµ "chÆ°a biáº¿t" Ä‘á»ƒ mÃ¬nh gá»£i Ã½)`);
  }

  // 5c) Äá»§ city + dish â†’ show káº¿t quáº£ (lá»c giá»/ngÃ¢n sÃ¡ch)
  if (STATE.city && STATE.dish) {
    showResultsForCityDish(STATE.city, STATE.dish, userText);
    return;
  }

  // 5d) Thiáº¿u cáº£ hai â†’ há»i city & mÃ³n
  if (!STATE.city && !STATE.dish) {
    return sayOnce('askCityDish','Báº¡n Ä‘ang á»Ÿ <b>thÃ nh phá»‘ nÃ o</b> (HN/HP/ÄN/Huáº¿/CT/HCM) vÃ  <b>Ä‘Ã£ dá»± Ä‘á»‹nh Äƒn mÃ³n gÃ¬ chÆ°a</b>?');
  }

  // 5e) CÃ³ dish nhÆ°ng chÆ°a city
  if (!STATE.city && STATE.dish) {
    return sayOnce('askCity', `Báº¡n muá»‘n Äƒn <b>${DISH_LABELS[STATE.dish]||STATE.dish}</b>, váº­y báº¡n Ä‘ang á»Ÿ <b>thÃ nh phá»‘ nÃ o</b>? (HN/HP/ÄN/Huáº¿/CT/HCM)`);
  }
}


// events
btn.addEventListener('click', ()=>{ if(q.value.trim()){ ask(q.value); q.value=''; }});
q.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btn.click(); }});

// Bot khÃ´ng auto chÃ o â€” láº¯ng nghe trÆ°á»›c.
</script>
</body>
</html>












