<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tinh hoa hương vị Việt</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/pho.png?v=1" />
  <!-- SEO -->
  <meta name="description" content="Khám phá quán ăn ngon 3 miền — Bắc, Trung, Nam. Review chân thực, giá cả rõ ràng, gợi ý gần bạn." />
  <meta property="og:title" content="Ăn Ngon 3 Miền" />
  <meta property="og:description" content="Review quán ăn khắp Việt Nam. Tìm kiếm theo món, địa điểm, giá." />
  <meta property="og:image" content="images/Home/BG1.jpg" />
  <meta name="theme-color" content="#ffffff" />
  <!-- Fonts (VN-ready) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&family=Noto+Serif+Display:ital,wght@0,600;0,700;0,800;1,600;1,700&family=Kaushan+Script&display=swap" rel="stylesheet">
  <!-- CSS -->
  <link rel="stylesheet" href="css/styles.css" />

  <!-- ===== Top quán ăn — nâng cấp giao diện & đánh số 1–3 ===== -->
  <style>
   :root{ --bg:#faf9f7; --text:#141518; --muted:#6e7380; --border:#e6e6e8; --surface:#fff; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.6 'Inter',system-ui}
.container{max-width:920px;margin:0 auto;padding:24px 16px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.header{padding:16px;text-align:center;font-weight:700;font-size:20px}
.chat{padding:14px;max-height:66vh;overflow:auto;scroll-behavior:smooth}
.row{display:flex;gap:10px;margin:10px 0}
.bot .bubble{background:#f1f5f9}
.user{justify-content:flex-end}
.user .bubble{background:#1a5cff;color:#fff}
.bubble{padding:10px 12px;border-radius:12px;max-width:80%}
.input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
input[type="text"]{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font:500 16px/1 'Inter'}
button{padding:12px 16px;border:0;border-radius:10px;font-weight:700;background:#2eb872;color:#fff;cursor:pointer}
button:active{transform:scale(.98)}
.hint{color:#6e7380;font-size:14px;margin:4px 0 0}
.small{font-size:13px;color:#6e7380}
.mini-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px;margin-top:8px}
.mini{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
.mini h4{margin:0 0 6px;font-size:15px}
.mini p{margin:0;color:#6e7380;font-size:13px}
.btn{display:inline-block;background:#1a5cff;color:#fff;border-radius:999px;padding:8px 10px;font-weight:700;font-size:13px;border:0;cursor:pointer;margin-top:8px}
.btn.secondary{background:#e9edf5;color:#1a2a5c}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chip{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:600}
.chip:hover{background:#f3f4f6}
.mini .actions{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
.btn.ghost{ background:#fff; color:#1a2a5c; border:1px solid #e5e7eb }
.btn.ghost:hover{ background:#f3f4f6 }

  </style>
</head>
<body>
  <a class="visually-hidden" href="#main">Bỏ qua nội dung</a>

  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="container header-inner">
      <div class="site-title">TINH HOA HƯƠNG VỊ VIỆT</div>
      <nav class="primary" aria-label="Chính">
        <a class="nav-link" href="/index.html" aria-current="page">Trang chủ</a>
        <a class="nav-link" href="/chatbot.html">Chatbot Tư Vấn Thông Minh</a>
        <a class="nav-link" href="/congdong.html">Mở Rộng</a>
        <a class="nav-link" href="/contactus.html">Về chúng tôi</a>
      </nav>
    </div>
  </header>


  <!-- ===== Nội dung Chatbot (giữ nguyên prompt/logic) ===== -->
  <main>
    <div class="container">
      <div class="card">
        <div class="header">Chatbot tư vấn quán ăn</div>
        <div id="chat" class="chat"></div>
        <div class="input">
          <input id="q" type="text" placeholder="Bạn muốn ăn gì? Ví dụ: 'Bún cá cay ở Hải Phòng, trưa nay, ~35k/bát'"/>
          <button id="send">Gửi</button>
        </div>
      </div>
      <p class="hint">Gợi ý: “Mì Quảng ở Đà Nẵng, tối nay, 30–50k”.</p>
    </div>
  </main>
  <!-- Footer -->
  <footer role="contentinfo">
    <div class="container">
      <div class="grid">
        <div>
          <strong style="font-family:'Noto Serif Display',serif">Ăn Ngon 3 Miền</strong>
          <p class="section-desc">Nền tảng review quán ăn khắp Việt Nam. Chia sẻ bởi cộng đồng sành ăn.</p>
        </div>
        <div>
          <strong style="font-family:'Noto Serif Display',serif">Liên kết</strong>
          <p class="section-desc"><a href="#">Điều khoản</a> • <a href="#">Bảo mật</a> • <a href="contactus.html">Liên hệ</a></p>
        </div>
        <div>
          <strong style="font-family:'Noto Serif Display',serif">Cập nhật</strong>
          <p class="section-desc">Theo dõi chúng tôi để nhận gợi ý quán ngon mỗi tuần.</p>
        </div>
      </div>
      <p style="margin-top:12px;color:var(--muted)">© <span id="year"></span> AnNgon3Mien. All rights reserved.</p>
    </div>
  </footer>



<script>
const chat = document.getElementById('chat');
const q    = document.getElementById('q');
const btn  = document.getElementById('send');

// ===== helpers =====
function addBubble(html, who='bot'){
  const row = document.createElement('div');
  row.className = 'row ' + (who === 'user' ? 'user' : 'bot');
  row.innerHTML = `<div class="bubble">${html}</div>`;
  chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
  return row.querySelector('.bubble');
}

const esc   = s => s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const rmAcc = s =>
  s.normalize('NFD')
   .replace(/[\u0300-\u036f]/g, '')
   .replace(/đ/g, 'd')
   .replace(/Đ/g, 'd')
   .toLowerCase();

   function norm(s){
  return rmAcc(String(s || ''));   // chuẩn hoá + lowercase + bỏ dấu
}

// ===== say-once (chống lặp) =====
let LAST = {type:null, count:0}; // nhớ loại prompt gần nhất và số lần lặp
function sayOnce(type, html){
  if (LAST.type === type && LAST.count >= 1) return; // cùng prompt -> nói tối đa 2 lượt
  if (LAST.type === type) LAST.count++; else { LAST.type = type; LAST.count = 0; }
  addBubble(html, 'bot');
}
function clearPromptFlag(){ LAST = {type:null, count:0}; }


// ===== state =====
let STATE = { city:null, dish:null, area:null, budget:null, dow:null, minuteOfDay:null, askDishPending:false };
let LAST_RESULTS = [];   // nhớ 3 quán vừa hiển thị để hiểu “mình chọn quán X”
const resetState = () => { STATE = { city:null, dish:null, area:null, budget:null, dow:null, minuteOfDay:null, askDishPending:false }; clearPromptFlag(); LAST_RESULTS = []; };


// ===== dataset (đã update) =====
const PLACES = [
  // HÀ NỘI
  {city:'Hà Nội', dish:'pho', name:'Phở 10 Lý Quốc Sư', area:'Hàng Trống, Hoàn Kiếm', address:'10 P. Lý Quốc Sư, Hoàn Kiếm, Hà Nội', hours:{0:[['06:00','22:00']]}, price_min:70000, price_max:100000, why:'Nước dùng trong, vị bò chuẩn phố cổ', href:'#'},
  {city:'Hà Nội', dish:'pho', name:'Phở gà Nguyệt', area:'Hàng Trống, Hoàn Kiếm', address:'5B P. Phủ Doãn, Hoàn Kiếm, Hà Nội', hours:{0:[['06:30','13:00'],['16:30','00:30']]}, price_min:55000, price_max:120000, why:'Phở gà đậm đà, mở tối khuya', href:'#'},
  {city:'Hà Nội', dish:'pho', name:'Phở Khôi Hói', area:'Phố cổ, Hoàn Kiếm', address:'50 P. Hàng Vải, Hoàn Kiếm, Hà Nội', hours:{0:[['06:00','21:00']]}, price_min:45000, price_max:75000, why:'Quán địa phương giá mềm', href:'#'},
  {city:'Hà Nội', dish:'buncha', name:'Bún chả 74 Hàng Quạt', area:'Phố cổ, Hoàn Kiếm', address:'74 P. Hàng Quạt, Hoàn Kiếm, Hà Nội', hours:{0:[['10:00','14:00']]}, price_min:40000, price_max:50000, why:'Thịt nướng thơm lửa than', href:'#'},
  {city:'Hà Nội', dish:'buncha', name:'Bún Thịt Nướng Bà Hằng Béo', area:'Ô Chợ Dừa, Đống Đa', address:'60 P. Ô Chợ Dừa, Hà Nội', hours:{0:[['10:00','17:00']]}, price_min:40000, price_max:50000, why:'Thịt nướng đầy đặn', href:'#'},
  {city:'Hà Nội', dish:'buncha', name:'Bún chả Hương Liên', area:'Hai Bà Trưng', address:'24 Lê Văn Hưu, Hà Nội', hours:{0:[['08:00','20:00']]}, price_min:60000, price_max:60000, why:'“Obama” – nem cua bể giòn', href:'#'},
  {city:'Hà Nội', dish:'chaca', name:'Chả Cá Hàng Sơn', area:'Tràng Tiền, Hoàn Kiếm', address:'24 P. Tông Đản, Hà Nội', hours:{0:[['10:30','14:00'],['17:30','22:00']]}, price_min:465000, price_max:2095000, why:'Combo 1–5 đa dạng', href:'#'},
  {city:'Hà Nội', dish:'chaca', name:'Chả Cá Phan', area:'Nguyễn Du, Hai Bà Trưng', address:'14 Nguyễn Bỉnh Khiêm, Hà Nội', hours:{0:[['11:00','21:30']]}, price_min:100000, price_max:200000, why:'Mắm tôm pha khéo', href:'#'},
  {city:'Hà Nội', dish:'chaca', name:'Chả cá Thăng Long', area:'Cửa Đông, Hoàn Kiếm', address:'6B Đường Thành, Hà Nội', hours:{0:[['09:00','23:00']]}, price_min:176000, price_max:176000, why:'Cá dày thịt, chảo nóng', href:'#'},

  // HẢI PHÒNG
  {city:'Hải Phòng', dish:'nemcuabe', name:'Nem Cua Bể Thuận Yến', area:'Ngô Quyền', address:'179 Cầu Đất, Hải Phòng', hours:{0:[['10:00','21:00']]}, price_min:35000, price_max:85000, why:'Nem giòn, set hợp lý', href:'#'},
  {city:'Hải Phòng', dish:'nemcuabe', name:'Bún chả Nem Cua Tuyết Loan', area:'Ngô Quyền', address:'124 Lạch Tray, Hải Phòng', hours:{0:[['10:00','21:00']]}, price_min:30000, price_max:60000, why:'Nem cua bể + bún chả', href:'#'},
  {city:'Hải Phòng', dish:'nemcuabe', name:'Nem Cua Bể Quán Nga', area:'Ngô Quyền', address:'195 Trần Phú, Hải Phòng', hours:{0:[['10:00','21:00']]}, price_min:40000, price_max:80000, why:'Nem nóng cuốn tại chỗ', href:'#'},
  {city:'Hải Phòng', dish:'nemchua',  name:'Nem chua An Thọ', area:'An Lão', address:'An Thọ (ship toàn quốc)', hours:{0:[['08:00','21:00']]}, price_min:0, price_max:0, why:'Đặt theo set 10–50 cái', href:'#'},
  {city:'Hải Phòng', dish:'nemchua',  name:'Nem Chua Bà Cụ', area:'—', address:'Hải Phòng', hours:{0:[['08:00','20:00']]}, price_min:10000, price_max:20000, why:'Dân dã, dễ tìm', href:'#'},
  {city:'Hải Phòng', dish:'buncacay', name:'Bún cá cay 153 Lê Lai', area:'Lê Lai', address:'153 Lê Lai, Hải Phòng', hours:{0:[['06:00','12:30']]}, price_min:20000, price_max:30000, why:'Cá rô giòn/mềm', href:'#'},
  {city:'Hải Phòng', dish:'buncacay', name:'Bún cá cay Cậu Đoành', area:'Nhiều cơ sở', address:'HP (tham khảo fanpage)', hours:{0:[['06:30','13:30'],['17:30','21:00']]}, price_min:35000, price_max:35000, why:'Thập cẩm phong phú', href:'#'},
  {city:'Hải Phòng', dish:'buncacay', name:'Bún cá cay 66 Lê Lợi', area:'Hồng Bàng', address:'66 Lê Lợi, Hải Phòng', hours:{0:[['06:00','12:30']]}, price_min:30000, price_max:45000, why:'Nước dùng cay nồng, cá giòn', href:'#'},

  // ĐÀ NẴNG
  {city:'Đà Nẵng', dish:'miquang', name:'Mì Quảng Bệt', area:'—', address:'Đà Nẵng', hours:{0:[['06:00','21:00']]}, price_min:40000, price_max:80000, why:'Topping đủ vị', href:'#'},
  {city:'Đà Nẵng', dish:'miquang', name:'Mì Quảng Bà Lữ', area:'Hải Châu', address:'24 Trần Cao Vân, Đà Nẵng', hours:{0:[['06:00','21:00']]}, price_min:30000, price_max:55000, why:'Truyền thống', href:'#'},
  {city:'Đà Nẵng', dish:'miquang', name:'Mì Quảng Cô Sáu', area:'Đà Nẵng', address:'Đà Nẵng', hours:{0:[['06:00','13:00']]}, price_min:30000, price_max:60000, why:'Sợi mì dai, nước nhân đậm', href:'/mi-quang-co-sau.html'},
  {city:'Đà Nẵng', dish:'banhtrangthitheo', name:'Bánh tráng cuốn thịt heo Bà Hường', area:'Hải Châu', address:'460 2 Tháng 9, Đà Nẵng', hours:{0:[['06:00','22:00']]}, price_min:95000, price_max:95000, why:'Rau sống phong phú', href:'#'},
  {city:'Đà Nẵng', dish:'banhtrangthitheo', name:'Bánh tráng Cơm Đại Lộc', area:'Đà Nẵng', address:'Đà Nẵng', hours:{0:[['10:00','21:00']]}, price_min:0, price_max:0, why:'Đúng chất Đại Lộc, mắm nêm chuẩn', href:'/banh-trang-com-dai-loc.html'},
  {city:'Đà Nẵng', dish:'caolau', name:'Cao lầu Phố Hội', area:'Hải Châu', address:'63 Phan Đăng Lưu, Đà Nẵng', hours:{0:[['06:00','21:00']]}, price_min:0, price_max:0, why:'Chuẩn vị Hội An', href:'#'},
  {city:'Đà Nẵng', dish:'caolau', name:'Cao lầu Phước', area:'Sơn Trà', address:'18/3 Nguyễn Duy Hiệu, Đà Nẵng', hours:{0:[['06:00','11:00']]}, price_min:0, price_max:0, why:'Bán buổi sáng', href:'#'},

  // HUẾ
  {city:'Huế', dish:'bunbo', name:'Bún Bò Bà Nga', area:'Phú Cát', address:'5 Nguyễn Du, Huế', hours:{0:[['06:00','20:30']]}, price_min:25000, price_max:45000, why:'Đậm vị Huế', href:'#'},
  {city:'Huế', dish:'bunbo', name:'Bún bò Huế Mỹ Tâm', area:'Vĩnh Ninh', address:'3 Trần Cao Vân, Huế', hours:{0:[['07:00','22:00']]}, price_min:30000, price_max:80000, why:'Topping đa dạng', href:'#'},
  {city:'Huế', dish:'bunbo', name:'Bún bò O Liễu', area:'Huế', address:'Huế', hours:{0:[['06:00','21:00']]}, price_min:30000, price_max:60000, why:'Nước dùng trong, chả bò ngon', href:'/bun-bo-o-lieu.html'},
  {city:'Huế', dish:'che', name:'Chè Cầm', area:'Vỹ Dạ', address:'10 Nguyễn Sinh Cung, Huế', hours:{0:[['16:00','19:30']]}, price_min:15000, price_max:30000, why:'Chè cung đình', href:'#'},
  {city:'Huế', dish:'che', name:'Chè Ông Lạc', area:'Huế', address:'Huế', hours:{0:[['15:00','22:00']]}, price_min:10000, price_max:30000, why:'Quán chè nổi tiếng lâu năm', href:'/che-ong-lac.html'},
  {city:'Huế', dish:'che', name:'Chè Huế 20 món', area:'Huế', address:'Huế', hours:{0:[['15:00','22:00']]}, price_min:10000, price_max:30000, why:'Menu 20 món đặc sắc', href:'/che-hue-20-mon.html'},
  {city:'Huế', dish:'comhen', name:'Cơm hến Hoa Đông', area:'—', address:'64 Kiệt 7 Ưng Bình, Huế', hours:{0:[['06:00','20:00']]}, price_min:20000, price_max:20000, why:'Đặc biệt, rẻ', href:'#'},
  {city:'Huế', dish:'comhen', name:'Cơm hến Bé Liêm', area:'Huế', address:'Huế', hours:{0:[['06:00','20:00']]}, price_min:15000, price_max:25000, why:'Vị hến đậm, mắm ruốc thơm', href:'/com-hen-be-liem.html'},
  {city:'Huế', dish:'comhen', name:'Cơm hến Bà Cam', area:'Huế', address:'Huế', hours:{0:[['06:00','20:00']]}, price_min:15000, price_max:25000, why:'Đậm chất dân dã Huế', href:'/com-hen-ba-cam.html'},

  // CẦN THƠ
  {city:'Cần Thơ', dish:'laumam', name:'Lẩu mắm Cần Thơ', area:'Ninh Kiều', address:'162/18 Trần Ngọc Quế, Cần Thơ', hours:{0:[['09:30','22:30']]}, price_min:0, price_max:0, why:'Rau đồng quê', href:'#'},
  {city:'Cần Thơ', dish:'laumam', name:'Lẩu mắm Kiều Trinh', area:'Xuân Khánh, Ninh Kiều', address:'26 Trần Khánh Dư, Ninh Kiều, Cần Thơ', hours:{0:[['11:00','21:00']]}, price_min:200000, price_max:450000, why:'Đậm đà chuẩn vị, rau phong phú', href:'/lau-mam-kieu-trinh.html'},
  {city:'Cần Thơ', dish:'laumam', name:'Lẩu mắm Quê Mi', area:'Thới Bình, Ninh Kiều', address:'77 Huỳnh Cương, Ninh Kiều, Cần Thơ', hours:{0:[['10:00','22:00']]}, price_min:250000, price_max:450000, why:'Mắm cá linh/sặc lọc kỹ, vị cân bằng', href:'/lau-mam-que-mi.html'},
  {city:'Cần Thơ', dish:'calocnuongtrui', name:'Đồng Xanh', area:'Ninh Kiều', address:'211 Nguyễn Văn Linh, Cần Thơ', hours:{0:[['08:00','03:00']]}, price_min:39000, price_max:39000, why:'Mở khuya', href:'#'},
  {city:'Cần Thơ', dish:'vitnauchao', name:'Vịt Nấu Chao Cẩm Tú', area:'Ninh Kiều', address:'1 Lý Tự Trọng, Cần Thơ', hours:{0:[['09:00','22:00']]}, price_min:150000, price_max:200000, why:'Đậm vị, hợp lý', href:'#'},

  // HỒ CHÍ MINH
  {city:'Hồ Chí Minh', dish:'comtam', name:'Cơm tấm Ba Ghiền', area:'Phú Nhuận', address:'84 Đặng Văn Ngữ, TP.HCM', hours:{0:[['06:00','22:00']]}, price_min:40000, price_max:70000, why:'Sườn dày, cơm mềm', href:'#'},
  {city:'Hồ Chí Minh', dish:'banhmi', name:'Bánh mì Huynh Hoa', area:'Quận 1', address:'26 Lê Thị Riêng, TP.HCM', hours:{0:[['13:00','23:00']]}, price_min:73000, price_max:73000, why:'Pate & chả đầy', href:'#'},
  {city:'Hồ Chí Minh', dish:'phalau', name:'Phá lấu bò Cây Trâm', area:'Gò Vấp', address:'208 Cây Trâm, TP.HCM', hours:{0:[['15:00','21:00']]}, price_min:30000, price_max:60000, why:'Có mì/bánh mì phá lấu', href:'#'}
];

const DISH_LABELS = { pho:'Phở', buncha:'Bún chả', chaca:'Chả cá',
  nemcuabe:'Nem cua bể', nemchua:'Nem chua', buncacay:'Bún cá cay',
  miquang:'Mì Quảng', banhtrangthitheo:'Bánh tráng thịt heo', caolau:'Cao lầu',
  bunbo:'Bún bò Huế', che:'Chè', comhen:'Cơm hến',
  comtam:'Cơm tấm', banhmi:'Bánh mì', phalau:'Phá lấu',
  laumam:'Lẩu mắm', calocnuongtrui:'Cá lóc nướng trui', vitnauchao:'Vịt nấu chao'
};

const CITY_SIGNATURES = {
  'Hà Nội':['pho','buncha','chaca'],
  'Hải Phòng':['buncacay','nemcuabe','nemchua'],
  'Đà Nẵng':['miquang','banhtrangthitheo','caolau'],
  'Huế':['bunbo','che','comhen'],
  'Cần Thơ':['laumam','calocnuongtrui','vitnauchao'],
  'Hồ Chí Minh':['comtam','banhmi','phalau']
};

// ===== parsing =====
function detectIntent(raw){
  const t = rmAcc(raw).trim();

  // Chào hỏi / tạm biệt
  if (/^(hi+|hello+|xin chao|chao+|yo|he+l+o+)$/.test(t)) return {type:'greet'};
  if (/^(bye|tam biet|see you|ngu ngon|hen gap)$/.test(t)) return {type:'bye'};

  // Giới thiệu bản thân / hỏi về bot
  if (/(toi|minh|tao)\s+(ten|la)\b/.test(t)) return {type:'intro'};
  if (/(may|ban|bot)\s+(la ai|ten gi|ai tao|an gi|lam gi)/.test(t)) return {type:'about'};

  // Xin gợi ý chung (“đói quá”, “tư vấn món đi”)
  if (/(doi qua|an gi|goi y|tu van|cho minh vai quan|keo di an)/.test(t)) return {type:'ask_suggest'};

  return {type:'normal'};
}

function parseBudgetVND(text){
  const t = norm(text).replace(/(vnd|dong|đ)/g,'').replace(/\s/g,'');
  // 2 người / n người
  let people = 1;
  const pm = t.match(/(\d+)\s*(nguoi|ng)/); if (pm) people = Math.max(1, +pm[1]);

  // 40-60, 40–60, 40k-60k, 100-150
  let m = t.match(/(\d{2,4})k?[–-](\d{2,4})k?/);
  if (m) {
    const lo = +m[1]*1000, hi = +m[2]*1000;
    return {min: lo*people, max: hi*people, raw: `${m[1]}–${m[2]}k${people>1?`/~${people}p`:''}`};
  }
  // ~50k, tầm70, 1xx
  m = t.match(/(~|tam|khoang)?(\d{2,3})(xx)?k?/);
  if (m){
    let v = +m[2];
    if (m[3]==='xx') v = v*10+0; // 1xx -> 100
    v *= 1000;
    const span = Math.round(v*0.2);
    return {min:(v-span)*people, max:(v+span)*people, raw:`~${Math.round(v/1000)}k${people>1?`/~${people}p`:''}`};
  }
  return null;
}



function placePriceSpan(p){
  const lo = p.price_min || 0, hi = p.price_max || (p.price_min || 0);
  return {lo, hi, mid: lo && hi ? Math.round((lo+hi)/2) : (lo || hi || 0)};
}
function budgetOverlap(place, budget){
  if(!budget) return 'unknown';
  const {lo,hi,mid} = placePriceSpan(place);
  if(!lo && !hi) return 'unknown';
  // khớp khi khoảng giá giao nhau
  const overlap = !(hi < budget.min || lo > budget.max);
  if (overlap) return 'fit';
  // “near” nếu mid nằm trong ±20% so với biên gần nhất của budget
  const edge = (mid < budget.min) ? budget.min : budget.max;
  const diff = Math.abs(mid - edge);
  const near = diff <= edge * 0.2; // <=20%
  return near ? 'near' : 'off';
}


function parseTime(text){
  const t = rmAcc(text);
  const today = new Date().getDay();
  let dow=today, minuteOfDay=null;
  const m = t.match(/(\d{1,2})(?:h|:)(\d{0,2})?/);
  if(m){ minuteOfDay=(+m[1])*60 + (m[2]?+m[2]:0); }
  else if(t.includes('sang')) minuteOfDay=8*60;
  else if(t.includes('trua')) minuteOfDay=12*60;
  else if(t.includes('chieu')) minuteOfDay=17*60;
  else if(t.includes('toi')) minuteOfDay=19*60;
  return {dow, minuteOfDay};
}
// === City detection: alias + auto-match từ dataset ===
const KNOWN_CITIES = [...new Set(PLACES.map(p => p.city))];

// Các alias/phổ biến & viết tắt thủ công cho một số TP lớn
const CITY_ALIASES = [
  [/ha\s*noi|hanoi|\bhn\b/, 'Hà Nội'],
  [/hai\s*phong|haiphong|\bhp\b/, 'Hải Phòng'],
  [/da\s*nang|danang|\bdn\b/, 'Đà Nẵng'],
  [/\bhue\b/, 'Huế'],
  [/can\s*tho|cantho|\bct\b/, 'Cần Thơ'],
  [/ho\s*chi\s*minh|tp[\.\s]*hcm|tphcm|\bhcm\b|sai\s*gon|saigon|\bsg\b/, 'Hồ Chí Minh'],
];

// Tạo tokens động từ dataset (ví dụ “hai phong” => hp)
const CITY_TOKENS = KNOWN_CITIES.map(name => {
  const token = rmAcc(name).replace(/\s+/g, ' ').trim();          // "hai phong"
  const initials = token.split(' ').map(w => w[0]).join('');      // "hp"
  return { name, token, initials };
});

function parseCity(text){
  const t = norm(text);
  // “ở hcm”, “đang ở hà nội”, “qua đà nẵng”
  const cityHit = t.match(/\b(o|o|dang o|qua|tai)\s+([a-z\s\.]+)$/);
  const candidates = [
    [/ha\s*noi|hn|hanoi/, 'Hà Nội'],
    [/hai\s*phong|hp|haiphong/, 'Hải Phòng'],
    [/da\s*nang|dn|danang/, 'Đà Nẵng'],
    [/\bhue\b/, 'Huế'],
    [/can\s*tho|ct|cantho/, 'Cần Thơ'],
    [/ho\s*chi\s*minh|tp\.?\s*hcm|tphcm|hcm|sai\s*gon|sg/, 'Hồ Chí Minh'],
  ];
  for (const [re, name] of candidates) if (re.test(t)) return name;
  if (cityHit){
    const tail = cityHit[2];
    for (const [re, name] of candidates) if (re.test(tail)) return name;
  }
  return null;
}


function parseDish(text){
  const t = rmAcc(text);
  if(t.includes('pho')) return 'pho';
  if(t.includes('bun cha')) return 'buncha';
  if(t.includes('cha ca')) return 'chaca';
  if(t.includes('nem cua')) return 'nemcuabe';
  if(t.includes('nem chua')) return 'nemchua';
  if(t.includes('bun ca cay')) return 'buncacay';
  if(t.includes('mi quang')) return 'miquang';
  if(t.includes('banh trang thit heo')) return 'banhtrangthitheo';
  if(t.includes('cao lau')) return 'caolau';
  if(t.includes('bun bo')) return 'bunbo';
  if(/\bche\b/.test(t)) return 'che';
  if(t.includes('com hen')) return 'comhen';
  if(t.includes('com tam')) return 'comtam';
  if(t.includes('banh mi')) return 'banhmi';
  if(t.includes('pha lau')) return 'phalau';
  if(t.includes('lau mam')) return 'laumam';
  if(t.includes('ca loc nuong')||t.includes('nuong trui')) return 'calocnuongtrui';
  if(t.includes('vit nau chao')) return 'vitnauchao';
  return null;
}
function saidNoDish(text){
  const t = rmAcc(text).trim();
  return /\b(chua|chua co|chua biet|chua nghi|chua quyet|khong|ko|k|khong biet|khong ro)\b/.test(t);
}
function saidYes(text){
  const t = rmAcc(text).trim();
  return /\b(roi|co|oke?|okela|da|da roi|chap nhan|co roi|di|ok)\b/.test(t);
}

// ===== matching =====
function isOpenAt(place,dow,minuteOfDay){
  const segs = place.hours?.[dow] || place.hours?.[0] || [];
  if (!segs.length) return null; // unknown
  if (minuteOfDay==null) return true;
  return segs.some(([f,t])=>{
    const [fh,fm]=f.split(':').map(Number), [th,tm]=t.split(':').map(Number);
    const S=fh*60+fm, E=th*60+tm; return minuteOfDay>=S && minuteOfDay<=E;
  });
}

function budgetOk(place,budget){
  if(!budget) return true;
  const lo=place.price_min||0, hi=place.price_max||1e9;
  return !(hi<budget.min || lo>budget.max);
}
function formatPrice(p){
  if(!p) return 'Tham khảo tại quán';
  if(p.price_min && p.price_max && p.price_min===p.price_max) return (p.price_min/1000|0)+'k';
  if(p.price_min && p.price_max) return (p.price_min/1000|0)+'–'+(p.price_max/1000|0)+'k';
  if(p.price_min) return 'từ '+(p.price_min/1000|0)+'k';
  return 'Tham khảo';
}
function formatHours(h){
  const segs=(h&&(h[new Date().getDay()]||h[0]))||[];
  if(!segs.length) return 'Giờ tham khảo';
  return segs.map(([f,t])=>`${f}–${t}`).join(', ');
}
function gmapUrl(place){
  // dùng Directions API link để mở app Google Maps tốt hơn
  return 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(place.address);
}

function searchPlaces(city, dish, filtersText=''){
  const budget = parseBudgetVND(filtersText);
  const {dow, minuteOfDay} = parseTime(filtersText);

  const candidates = PLACES
    .filter(p => (!city || p.city === city) && (!dish || p.dish === dish))
    .map(p => {
      let score = 0;
      if (dish && p.dish === dish) score += 3;
      if (isOpenAt(p, dow, minuteOfDay)) score += 1;

      let fit = budgetOverlap(p, budget);
      if (fit === 'fit') score += 6;        // mạnh tay ưu tiên đúng ngân sách
      else if (fit === 'near') score += 2;  // gần ngân sách
      else if (fit === 'unknown') score += 0;

      return {p, score, fit};
    })
    .sort((a,b)=> b.score - a.score);

  // tách 3 nhóm
  const fits   = candidates.filter(x => x.fit === 'fit').map(x=>x.p);
  const nears  = candidates.filter(x => x.fit === 'near').map(x=>x.p);
  const others = candidates.filter(x => x.fit !== 'fit' && x.fit !== 'near').map(x=>x.p);

  return { fits: fits.slice(0,3), nears: nears.slice(0,3), others: others.slice(0,3), budget };
}


// ===== UI builders =====
function placeCards(title, places, fitMap={}){
  return `
    <div><strong>${title}</strong></div>
    <div class="mini-grid">
      ${places.map(p=>{
        const badge = fitMap[p.name] || '';
        return `
        <div class="mini">
          <h4>${p.name}</h4>
          <p>📍 ${p.area}<br>🗺️ ${p.address}<br>🕒 ${formatHours(p.hours)}<br>💸 ${formatPrice(p)}</p>
          ${badge ? `<p style="margin-top:6px"><b>${badge}</b></p>` : `<p style="margin-top:6px">${p.why||''}</p>`}
          <div class="actions">
            <a class="btn ghost" href="${gmapUrl(p)}" target="_blank" rel="noopener">📍 Chỉ đường</a>
          </div>
        </div>`}).join('')}
    </div>
    <p class="small">💡 Tip: Gõ “món + thành phố + thời gian + ngân sách”. Ví dụ: “bún chả Hoàn Kiếm trưa nay 40–50k”.</p>`;
}




function cityChips(title='Bạn muốn xem thành phố khác?'){
  const cities=['Hà Nội','Hải Phòng','Đà Nẵng','Huế','Cần Thơ','Hồ Chí Minh'];
  const el = addBubble(`
    <div><strong>${title}</strong></div>
    <div class="chips">
      ${cities.map(c=>`<span class="chip" data-city="${c}">${c}</span>`).join('')}
    </div>`);
  el.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      STATE.city = ch.getAttribute('data-city'); STATE.dish=null; STATE.askDishPending=true; clearPromptFlag();
      sayOnce('askDish', `Bạn đang ở <b>${STATE.city}</b>. Bạn <b>đã dự định ăn món gì chưa</b>? (Có: gõ tên món • Chưa: gõ "chưa biết" để mình gợi ý)`);
    });
  });
}
function dishSuggestCards(city){
  const dishes = CITY_SIGNATURES[city] || [];
  const picks = dishes.map(d => {
    const {fits, nears, others} = searchPlaces(city, d);
    const sample = (fits[0] || nears[0] || others[0]) || null;
    return { dish: d, sample };
  }).filter(x => x.sample);

  const html = `
    <div><strong>Món nổi bật ở ${city}</strong></div>
    <div class="mini-grid">
      ${picks.map(x=>`
        <div class="mini">
          <h4>${DISH_LABELS[x.dish]}</h4>
          <p>Ví dụ: <b>${x.sample.name}</b> — ${formatPrice(x.sample)}</p>
          <button class="btn" data-choose="${x.dish}">Chọn món này</button>
        </div>`).join('')}
    </div>
    <p class="small">Bạn có thể bấm chọn hoặc gõ món khác tuỳ thích.</p>`;
  const el = addBubble(html,'bot');
  el.querySelectorAll('[data-choose]').forEach(b=>{
    const d=b.getAttribute('data-choose');
    b.addEventListener('click', ()=>{
      STATE.dish=d; STATE.askDishPending=false; clearPromptFlag();
      showResultsForCityDish(STATE.city,d);
    });
  });
  LAST_PROMPT='suggestions';
}

function offerNextActions(){
  addBubble('Nếu bạn đã chọn quán rồi, chúc bạn <b>ăn ngon miệng</b> 😋. Muốn khám phá ở thành phố khác không?');
  cityChips('Khám phá thành phố khác');
}
function showResultsForCityDish(city, dish, extras=''){
  const {fits, nears, others, budget} = searchPlaces(city, dish, extras);

  // map nhãn
  const fitMap = {};
  fits.forEach(p => fitMap[p.name]  = '✅ Hợp ngân sách');
  nears.forEach(p => fitMap[p.name] = '↗ Hơi vượt một chút (≈±20%)');

  if (budget && !fits.length) {
    // Không có quán đúng ngân sách
    const title = `${DISH_LABELS[dish]} ở ${city}: gần với tầm giá bạn đưa`;
    const picks = (nears.length ? nears : others).slice(0,3);

    addBubble(
      `Tiếc quá, mình <b>chưa tìm được quán đúng tầm ${budget.raw}</b> 😢. 
      Nhưng đây là vài chỗ <b>gần nhất</b> (chênh nhẹ hoặc giá phổ biến hơn):`,
      'bot'
    );
    addBubble(placeCards(title, picks, fitMap));
    offerNextActions();
    LAST_RESULTS = picks;
    return;
  }

  const list = fits.length ? fits : (nears.length ? nears : others);
  if(!list.length){ addBubble('Chưa thấy quán khớp. Bạn thử món khác hoặc nới ngân sách nhé.'); return; }

  LAST_RESULTS = list;
const title = `${DISH_LABELS[dish]} ở ${city}${budget ? ` (lọc theo ${budget.raw})` : ''}`;
  addBubble(placeCards(title, list, fitMap));
  offerNextActions();
}


// ===== hiểu người dùng “chọn quán này/ok/đi” =====
function tryDetectChosenPlace(text){
  const t = rmAcc(text);
  if(!LAST_RESULTS.length) return null;
  // tên khớp mờ + có từ khoá xác nhận
  const positive = /(ok|oke?|chot|chot nhe|di|qua do|chac vay|chuan|chot quan|chon|toi chon|minh chon|co ve ok|on)/.test(t);
  for(const p of LAST_RESULTS){
    const name = rmAcc(p.name);
    if(positive || t.includes(name) || name.split(' ').some(w=>w.length>2 && t.includes(w))){
      return p;
    }
  }
  return null;
}

// ===== conversation =====
function detectIntent(raw){
  const t = norm(raw);

  // greeting/bye
  if (/^(hi+|hello+|xin chao|chao|yo|he+l+o+)$/.test(t)) return {type:'greet'};
  if (/^(bye|tam biet|see you|toitruoc|ngu ngon)$/.test(t)) return {type:'bye'};

  // giới thiệu bản thân / trêu
  if (/(toi|minh|tao)\s+(ten|la)\b/.test(t)) return {type:'intro'};
  if (/(may|ban|bot)\s+(la ai|ten gi|an gi|lam gi|ai tao)/.test(t)) return {type:'about'};

  // xin gợi ý chung kiểu “đói quá”, “tư vấn món đi”
  if (/(doi qua|an gi|goi y|tu van|cho minh vai quan|keo di an)/.test(t)) return {type:'ask_suggest'};

  return {type:'normal'};
}


function replyNoData(){
  addBubble(
    'Ui, khu đó mình <b>chưa có dữ liệu</b> 😅. Hiện mình “rành” <b>Hà Nội, Hải Phòng, Đà Nẵng, Huế, Cần Thơ, TP.HCM</b> thôi nha 🍜.',
    'bot'
  );
  cityChips('Chọn thành phố gần bạn nhất:');
}



function ask(msg){
  const userText = msg.trim();
  if (!userText) return;

  // --- 1) Nhận diện small-talk & điều hướng sớm
  const intent = detectIntent(userText);
  if (intent.type !== 'normal') {
    addBubble(esc(userText),'user');
    const cityList = '<b>Hà Nội, Hải Phòng, Đà Nẵng, Huế, Cần Thơ, TP.HCM</b>';

    if (intent.type === 'greet') {
      return sayOnce('intro',
        'Chào bạn 👋 Mình chuyên gợi ý quán theo <b>món/khu/giờ/ngân sách</b>. Bạn đang ở thành phố nào để mình bật mode “thổ địa” nè?');
    }
    if (intent.type === 'bye') {
      return addBubble('Hẹn bạn bữa sau nha 👋 Lúc đói cứ gọi mình!', 'bot');
    }
    if (intent.type === 'intro') {
      return addBubble('Rất vui được gặp bạn 😊 Cho mình biết bạn đang ở đâu để giới thiệu đặc sản quanh đó nhé?', 'bot');
    }
    if (intent.type === 'about') {
      return addBubble(`Mình là trợ lý ăn ngon 🍜 – hiện “rành” ${cityList}. Cứ nói <b>món + thành phố</b>, mình lọc quán hợp giờ & túi tiền cho bạn.`, 'bot');
    }
    if (intent.type === 'ask_suggest') {
      addBubble('Ok, bật radar đồ ăn 🍽️. Bạn đang ở thành phố nào để mình khoanh vùng ạ?','bot');
      return cityChips('Chọn nhanh thành phố của bạn');
    }
  }

  // --- 2) Ghi lại lời người dùng
  addBubble(esc(userText),'user');

  // --- 3) Người dùng “chốt quán”
  const chosen = tryDetectChosenPlace(userText);
  if (chosen) {
    addBubble(`Tuyệt! <b>${chosen.name}</b> là lựa chọn ổn đó. Chúc bạn <b>ăn ngon miệng</b> 😋.`, 'bot');
    cityChips('Bạn muốn mình gợi ý ở thành phố khác không?');
    resetState();
    return;
  }

  // --- 4) PARSE: city + dish
  const prevCity = STATE.city;
  const city = parseCity(userText);
  const dish = parseDish(userText);

// Heuristic: người dùng gõ 1 địa danh ngắn không nằm trong danh sách
const pure = norm(userText).replace(/[^a-z\s]/g,' ').trim();
const words = pure.split(/\s+/).filter(Boolean);
// không bắt được city & dish, chuỗi ngắn (1–3 từ) -> coi như địa danh ngoài vùng dữ liệu
if (!city && !dish && words.length > 0 && words.length <= 3) {
  return replyNoData();
}


  // 4a) Nhắc tới địa danh ngoài vùng dữ liệu → mời chọn TP hỗ trợ
  if (!city && /\b(tinh|thanh|huyen|xa|thi tran|pho|o\s+[a-z]+)/.test(rmAcc(userText))) {
    return replyNoData(); // helper hiển thị message + cityChips(...)
  }

  // 4b) Cập nhật state
  if (city && city !== STATE.city) { STATE.city = city; clearPromptFlag(); }
  if (dish) { STATE.dish = dish; STATE.askDishPending = false; clearPromptFlag(); }

  // 4c) Đang hỏi món mà user đổi city → chuyển mạch khéo
  if (STATE.askDishPending && city && city !== prevCity) {
    STATE.city = city;
    if (!dish) {
      return sayOnce('askDish', `Ok, chuyển sang <b>${STATE.city}</b> nha. Bạn <b>định ăn món gì</b>? (vd: phở, bún chả, mì quảng...)`);
    }
    showResultsForCityDish(STATE.city, dish, userText);
    return;
  }

  // --- 5) FLOW hội thoại theo slot
  // 5a) Đang chờ người dùng nói món
  if (STATE.askDishPending) {
    if (dish) { showResultsForCityDish(STATE.city, STATE.dish, userText); return; }
    if (saidNoDish(userText)) { STATE.askDishPending = false; dishSuggestCards(STATE.city); return; }
    if (saidYes(userText)) { return sayOnce('askWhich','Bạn định ăn <b>món nào</b>? (vd: bún chả, phở, mì quảng...)'); }
    return sayOnce('clarify','Bạn đã có món dự định chưa? Có thì gõ tên món; chưa thì gõ "chưa biết" để mình gợi ý.');
  }

  // 5b) Có city nhưng chưa dish → hỏi món
  if (STATE.city && !STATE.dish) {
    STATE.askDishPending = true;
    return sayOnce('askDish', `Bạn đang ở <b>${STATE.city}</b>. Bạn <b>đã dự định ăn món gì chưa</b>? (Có: gõ tên món • Chưa: gõ "chưa biết" để mình gợi ý)`);
  }

  // 5c) Đủ city + dish → show kết quả (lọc giờ/ngân sách)
  if (STATE.city && STATE.dish) {
    showResultsForCityDish(STATE.city, STATE.dish, userText);
    return;
  }

  // 5d) Thiếu cả hai → hỏi city & món
  if (!STATE.city && !STATE.dish) {
    return sayOnce('askCityDish','Bạn đang ở <b>thành phố nào</b> (HN/HP/ĐN/Huế/CT/HCM) và <b>đã dự định ăn món gì chưa</b>?');
  }

  // 5e) Có dish nhưng chưa city
  if (!STATE.city && STATE.dish) {
    return sayOnce('askCity', `Bạn muốn ăn <b>${DISH_LABELS[STATE.dish]||STATE.dish}</b>, vậy bạn đang ở <b>thành phố nào</b>? (HN/HP/ĐN/Huế/CT/HCM)`);
  }
}


// events
btn.addEventListener('click', ()=>{ if(q.value.trim()){ ask(q.value); q.value=''; }});
q.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btn.click(); }});

// Bot không auto chào — lắng nghe trước.
</script>
</body>
</html>












