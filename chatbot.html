<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chatbot tÆ° váº¥n quÃ¡n Äƒn Viá»‡t Nam (HN/HP/ÄN/Huáº¿/CT/HCM)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --bg:#faf9f7; --text:#141518; --muted:#6e7380; --border:#e6e6e8; --surface:#fff; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.6 'Inter',system-ui}
.container{max-width:920px;margin:0 auto;padding:24px 16px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.header{padding:16px;text-align:center;font-weight:700;font-size:20px}
.chat{padding:14px;max-height:66vh;overflow:auto;scroll-behavior:smooth}
.row{display:flex;gap:10px;margin:10px 0}
.bot .bubble{background:#f1f5f9}
.user{justify-content:flex-end}
.user .bubble{background:#1a5cff;color:#fff}
.bubble{padding:10px 12px;border-radius:12px;max-width:80%}
.input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
input[type="text"]{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font:500 16px/1 'Inter'}
button{padding:12px 16px;border:0;border-radius:10px;font-weight:700;background:#2eb872;color:#fff;cursor:pointer}
button:active{transform:scale(.98)}
.hint{color:#6e7380;font-size:14px;margin:4px 0 0}
.small{font-size:13px;color:#6e7380}
.mini-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px;margin-top:8px}
.mini{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
.mini h4{margin:0 0 6px;font-size:15px}
.mini p{margin:0;color:#6e7380;font-size:13px}
.btn{display:inline-block;background:#1a5cff;color:#fff;border-radius:999px;padding:8px 10px;font-weight:700;font-size:13px;border:0;cursor:pointer;margin-top:8px}
.btn.secondary{background:#e9edf5;color:#1a2a5c}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">ğŸ¤– Chatbot tÆ° váº¥n quÃ¡n Äƒn (Multi-city)</div>
    <div id="chat" class="chat"></div>
    <div class="input">
      <input id="q" type="text" placeholder="Báº¡n muá»‘n Äƒn gÃ¬? VÃ­ dá»¥: 'BÃºn cÃ¡ cay á»Ÿ Háº£i PhÃ²ng, trÆ°a nay, ~35k/bÃ¡t'"/>
      <button id="send">Gá»­i</button>
    </div>
  </div>
  <p class="hint">Gá»£i Ã½: â€œMÃ¬ Quáº£ng á»Ÿ ÄÃ  Náºµng, tá»‘i nay, 30â€“50kâ€.</p>
</div>

<script>
const chat = document.getElementById('chat');
const q    = document.getElementById('q');
const btn  = document.getElementById('send');

// ===== helpers =====
function addBubble(html, who='bot'){
  const row = document.createElement('div');
  row.className = 'row ' + (who === 'user' ? 'user' : 'bot');
  row.innerHTML = `<div class="bubble">${html}</div>`;
  chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
  return row.querySelector('.bubble');
}
const esc = s => s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const rmAcc = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

// ===== state (slot-filling) =====
let STATE = { city:null, dish:null, area:null, budget:null, dow:null, minuteOfDay:null, askDishPending:false };
const resetState = () => STATE = { city:null, dish:null, area:null, budget:null, dow:null, minuteOfDay:null, askDishPending:false };

// ===== dataset (rÃºt tá»« file PDF, giá»¯ nguyÃªn cÃ¡c thÃ nh phá»‘/mÃ³n trá»ng tÃ¢m) =====
const PLACES = [
  // ==== HÃ€ Ná»˜I
  {city:'HÃ  Ná»™i', dish:'pho', name:'Phá»Ÿ 10 LÃ½ Quá»‘c SÆ°', area:'HÃ ng Trá»‘ng, HoÃ n Kiáº¿m', address:'10 P. LÃ½ Quá»‘c SÆ°, HoÃ n Kiáº¿m, HÃ  Ná»™i', hours:{0:[['06:00','22:00']]}, price_min:70000, price_max:100000, why:'NÆ°á»›c dÃ¹ng trong, vá»‹ bÃ² chuáº©n phá»‘ cá»•', href:'#'},
  {city:'HÃ  Ná»™i', dish:'pho', name:'Phá»Ÿ gÃ  Nguyá»‡t', area:'HÃ ng Trá»‘ng, HoÃ n Kiáº¿m', address:'5B P. Phá»§ DoÃ£n, HoÃ n Kiáº¿m, HÃ  Ná»™i', hours:{0:[['06:30','13:00'],['16:30','00:30']]}, price_min:55000, price_max:120000, why:'Phá»Ÿ gÃ  Ä‘áº­m Ä‘Ã , má»Ÿ tá»‘i khuya', href:'#'},
  {city:'HÃ  Ná»™i', dish:'pho', name:'Phá»Ÿ KhÃ´i HÃ³i', area:'Phá»‘ cá»•, HoÃ n Kiáº¿m', address:'50 P. HÃ ng Váº£i, HoÃ n Kiáº¿m, HÃ  Ná»™i', hours:{0:[['06:00','21:00']]}, price_min:45000, price_max:75000, why:'QuÃ¡n Ä‘á»‹a phÆ°Æ¡ng giÃ¡ má»m', href:'#'},

  {city:'HÃ  Ná»™i', dish:'buncha', name:'BÃºn cháº£ 74 HÃ ng Quáº¡t', area:'Phá»‘ cá»•, HoÃ n Kiáº¿m', address:'74 P. HÃ ng Quáº¡t, HoÃ n Kiáº¿m, HÃ  Ná»™i', hours:{0:[['10:00','14:00']]}, price_min:40000, price_max:50000, why:'Thá»‹t nÆ°á»›ng thÆ¡m lá»­a than', href:'#'},
  {city:'HÃ  Ná»™i', dish:'buncha', name:'BÃºn Thá»‹t NÆ°á»›ng BÃ  Háº±ng BÃ©o', area:'Ã” Chá»£ Dá»«a, Äá»‘ng Äa', address:'60 P. Ã” Chá»£ Dá»«a, HÃ  Ná»™i', hours:{0:[['10:00','17:00']]}, price_min:40000, price_max:50000, why:'Thá»‹t nÆ°á»›ng Ä‘áº§y Ä‘áº·n', href:'#'},
  {city:'HÃ  Ná»™i', dish:'buncha', name:'BÃºn cháº£ HÆ°Æ¡ng LiÃªn', area:'Hai BÃ  TrÆ°ng', address:'24 LÃª VÄƒn HÆ°u, HÃ  Ná»™i', hours:{0:[['08:00','20:00']]}, price_min:60000, price_max:60000, why:'â€œObamaâ€ â€“ nem cua bá»ƒ giÃ²n', href:'#'},

  {city:'HÃ  Ná»™i', dish:'chaca', name:'Cháº£ CÃ¡ HÃ ng SÆ¡n', area:'TrÃ ng Tiá»n, HoÃ n Kiáº¿m', address:'24 P. TÃ´ng Äáº£n, HÃ  Ná»™i', hours:{0:[['10:30','14:00'],['17:30','22:00']]}, price_min:465000, price_max:2095000, why:'Combo 1â€“5 Ä‘a dáº¡ng', href:'#'},
  {city:'HÃ  Ná»™i', dish:'chaca', name:'Cháº£ CÃ¡ Phan', area:'Nguyá»…n Du, Hai BÃ  TrÆ°ng', address:'14 Nguyá»…n Bá»‰nh KhiÃªm, HÃ  Ná»™i', hours:{0:[['11:00','21:30']]}, price_min:100000, price_max:200000, why:'Máº¯m tÃ´m pha khÃ©o', href:'#'},
  {city:'HÃ  Ná»™i', dish:'chaca', name:'Cháº£ cÃ¡ ThÄƒng Long', area:'Cá»­a ÄÃ´ng, HoÃ n Kiáº¿m', address:'6B ÄÆ°á»ng ThÃ nh, HÃ  Ná»™i', hours:{0:[['09:00','23:00']]}, price_min:176000, price_max:176000, why:'CÃ¡ dÃ y thá»‹t, cháº£o nÃ³ng', href:'#'},

  // ==== Háº¢I PHÃ’NG
  {city:'Háº£i PhÃ²ng', dish:'nemcuabe', name:'Nem Cua Bá»ƒ Thuáº­n Yáº¿n', area:'NgÃ´ Quyá»n', address:'179 Cáº§u Äáº¥t, Háº£i PhÃ²ng', hours:{0:[['10:00','21:00']]}, price_min:35000, price_max:85000, why:'Nem giÃ²n, set há»£p lÃ½', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'nemcuabe', name:'BÃºn cháº£ Nem Cua Tuyáº¿t Loan', area:'NgÃ´ Quyá»n', address:'124 Láº¡ch Tray, Háº£i PhÃ²ng', hours:{0:[['10:00','21:00']]}, price_min:30000, price_max:60000, why:'Nem cua bá»ƒ + bÃºn cháº£', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'nemcuabe', name:'Nem Cua Bá»ƒ QuÃ¡n Nga', area:'NgÃ´ Quyá»n', address:'195 Tráº§n PhÃº, Háº£i PhÃ²ng', hours:{0:[['10:00','21:00']]}, price_min:40000, price_max:80000, why:'Nem nÃ³ng cuá»‘n táº¡i chá»—', href:'#'},

  {city:'Háº£i PhÃ²ng', dish:'nemchua', name:'Nem chua An Thá»', area:'An LÃ£o', address:'An Thá» (ship toÃ n quá»‘c)', hours:{0:[['08:00','21:00']]}, price_min:0, price_max:0, why:'Äáº·t theo set 10â€“50 cÃ¡i', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'nemchua', name:'Nem Chua BÃ  Cá»¥', area:'â€”', address:'Háº£i PhÃ²ng', hours:{0:[['08:00','20:00']]}, price_min:10000, price_max:20000, why:'DÃ¢n dÃ£, dá»… tÃ¬m', href:'#'},

  {city:'Háº£i PhÃ²ng', dish:'buncacay', name:'BÃºn cÃ¡ cay 153 LÃª Lai', area:'LÃª Lai', address:'153 LÃª Lai, Háº£i PhÃ²ng', hours:{0:[['06:00','12:30']]}, price_min:20000, price_max:30000, why:'CÃ¡ rÃ´ giÃ²n/má»m', href:'#'},
  {city:'Háº£i PhÃ²ng', dish:'buncacay', name:'BÃºn cÃ¡ cay Cáº­u ÄoÃ nh', area:'Nhiá»u cÆ¡ sá»Ÿ', address:'HP (tham kháº£o fanpage)', hours:{0:[['06:30','13:30'],['17:30','21:00']]}, price_min:35000, price_max:35000, why:'Tháº­p cáº©m phong phÃº', href:'#'},

  // ==== ÄÃ€ Náº´NG
  {city:'ÄÃ  Náºµng', dish:'miquang', name:'MÃ¬ Quáº£ng Bá»‡t', area:'â€”', address:'ÄÃ  Náºµng', hours:{0:[['06:00','21:00']]}, price_min:40000, price_max:80000, why:'Topping Ä‘á»§ vá»‹', href:'#'},
  {city:'ÄÃ  Náºµng', dish:'miquang', name:'MÃ¬ Quáº£ng BÃ  Lá»¯', area:'Háº£i ChÃ¢u', address:'24 Tráº§n Cao VÃ¢n, ÄÃ  Náºµng', hours:{0:[['06:00','21:00']]}, price_min:30000, price_max:55000, why:'Truyá»n thá»‘ng', href:'#'},
  {city:'ÄÃ  Náºµng', dish:'banhtrangthitheo', name:'BÃ¡nh trÃ¡ng cuá»‘n thá»‹t heo BÃ  HÆ°á»ng', area:'Háº£i ChÃ¢u', address:'460 2 ThÃ¡ng 9, ÄÃ  Náºµng', hours:{0:[['06:00','22:00']]}, price_min:95000, price_max:95000, why:'Rau sá»‘ng phong phÃº', href:'#'},
  {city:'ÄÃ  Náºµng', dish:'banhtrangthitheo', name:'BÃ¡nh trÃ¡ng thá»‹t heo BÃ  Thu', area:'NgÅ© HÃ nh SÆ¡n', address:'103 Äá»— BÃ¡, ÄÃ  Náºµng', hours:{0:[['10:00','21:00']]}, price_min:0, price_max:0, why:'Máº¯m nÃªm Ä‘áº­m', href:'#'},
  {city:'ÄÃ  Náºµng', dish:'caolau', name:'Cao láº§u Phá»‘ Há»™i', area:'Háº£i ChÃ¢u', address:'63 Phan ÄÄƒng LÆ°u, ÄÃ  Náºµng', hours:{0:[['06:00','21:00']]}, price_min:0, price_max:0, why:'Chuáº©n vá»‹ Há»™i An', href:'#'},
  {city:'ÄÃ  Náºµng', dish:'caolau', name:'Cao láº§u PhÆ°á»›c', area:'SÆ¡n TrÃ ', address:'18/3 Nguyá»…n Duy Hiá»‡u, ÄÃ  Náºµng', hours:{0:[['06:00','11:00']]}, price_min:0, price_max:0, why:'BÃ¡n buá»•i sÃ¡ng', href:'#'},

  // ==== HUáº¾
  {city:'Huáº¿', dish:'bunbo', name:'BÃºn BÃ² BÃ  Nga', area:'PhÃº CÃ¡t', address:'5 Nguyá»…n Du, Huáº¿', hours:{0:[['06:00','20:30']]}, price_min:25000, price_max:45000, why:'Äáº­m vá»‹ Huáº¿', href:'#'},
  {city:'Huáº¿', dish:'bunbo', name:'BÃºn bÃ² Huáº¿ Má»¹ TÃ¢m', area:'VÄ©nh Ninh', address:'3 Tráº§n Cao VÃ¢n, Huáº¿', hours:{0:[['07:00','22:00']]}, price_min:30000, price_max:80000, why:'Topping Ä‘a dáº¡ng', href:'#'},
  {city:'Huáº¿', dish:'che', name:'ChÃ¨ Cáº§m', area:'Vá»¹ Dáº¡', address:'10 Nguyá»…n Sinh Cung, Huáº¿', hours:{0:[['16:00','19:30']]}, price_min:15000, price_max:30000, why:'ChÃ¨ cung Ä‘Ã¬nh', href:'#'},
  {city:'Huáº¿', dish:'comhen', name:'CÆ¡m háº¿n Hoa ÄÃ´ng', area:'â€”', address:'64 Kiá»‡t 7 Æ¯ng BÃ¬nh, Huáº¿', hours:{0:[['06:00','20:00']]}, price_min:20000, price_max:20000, why:'Äáº·c biá»‡t, ráº»', href:'#'},

  // ==== Cáº¦N THÆ 
  {city:'Cáº§n ThÆ¡', dish:'laumam', name:'Láº©u máº¯m Cáº§n ThÆ¡', area:'Ninh Kiá»u', address:'162/18 Tráº§n Ngá»c Quáº¿, Cáº§n ThÆ¡', hours:{0:[['09:30','22:30']]}, price_min:0, price_max:0, why:'Rau Ä‘á»“ng quÃª', href:'#'},
  {city:'Cáº§n ThÆ¡', dish:'calocnuongtrui', name:'Äá»“ng Xanh', area:'Ninh Kiá»u', address:'211 Nguyá»…n VÄƒn Linh, Cáº§n ThÆ¡', hours:{0:[['08:00','03:00']]}, price_min:39000, price_max:39000, why:'Má»Ÿ khuya', href:'#'},
  {city:'Cáº§n ThÆ¡', dish:'vitnauchao', name:'Vá»‹t Náº¥u Chao Cáº©m TÃº', area:'Ninh Kiá»u', address:'1 LÃ½ Tá»± Trá»ng, Cáº§n ThÆ¡', hours:{0:[['09:00','22:00']]}, price_min:150000, price_max:200000, why:'Äáº­m vá»‹, há»£p lÃ½', href:'#'},

  // ==== Há»’ CHÃ MINH
  {city:'Há»“ ChÃ­ Minh', dish:'comtam', name:'CÆ¡m táº¥m Ba Ghiá»n', area:'PhÃº Nhuáº­n', address:'84 Äáº·ng VÄƒn Ngá»¯, TP.HCM', hours:{0:[['06:00','22:00']]}, price_min:40000, price_max:70000, why:'SÆ°á»n dÃ y, cÆ¡m má»m', href:'#'},
  {city:'Há»“ ChÃ­ Minh', dish:'banhmi', name:'BÃ¡nh mÃ¬ Huynh Hoa', area:'Quáº­n 1', address:'26 LÃª Thá»‹ RiÃªng, TP.HCM', hours:{0:[['13:00','23:00']]}, price_min:73000, price_max:73000, why:'Pate & cháº£ Ä‘áº§y', href:'#'},
  {city:'Há»“ ChÃ­ Minh', dish:'phalau', name:'PhÃ¡ láº¥u bÃ² CÃ¢y TrÃ¢m', area:'GÃ² Váº¥p', address:'208 CÃ¢y TrÃ¢m, TP.HCM', hours:{0:[['15:00','21:00']]}, price_min:30000, price_max:60000, why:'CÃ³ mÃ¬/bÃ¡nh mÃ¬ phÃ¡ láº¥u', href:'#'}
];

// tÃªn mÃ³n chuáº©n
const DISH_LABELS = {
  pho:'Phá»Ÿ', buncha:'BÃºn cháº£', chaca:'Cháº£ cÃ¡',
  nemcuabe:'Nem cua bá»ƒ', nemchua:'Nem chua', buncacay:'BÃºn cÃ¡ cay',
  miquang:'MÃ¬ Quáº£ng', banhtrangthitheo:'BÃ¡nh trÃ¡ng thá»‹t heo', caolau:'Cao láº§u',
  bunbo:'BÃºn bÃ² Huáº¿', che:'ChÃ¨', comhen:'CÆ¡m háº¿n',
  comtam:'CÆ¡m táº¥m', banhmi:'BÃ¡nh mÃ¬', phalau:'PhÃ¡ láº¥u',
  laumam:'Láº©u máº¯m', calocnuongtrui:'CÃ¡ lÃ³c nÆ°á»›ng trui', vitnauchao:'Vá»‹t náº¥u chao'
};

// ===== city signatures (Ä‘á»ƒ gá»£i Ã½ khi â€œchÆ°a biáº¿tâ€) =====
const CITY_SIGNATURES = {
  'HÃ  Ná»™i'      : ['pho','buncha','chaca'],
  'Háº£i PhÃ²ng'   : ['buncacay','nemcuabe','nemchua'],
  'ÄÃ  Náºµng'     : ['miquang','banhtrangthitheo','caolau'],
  'Huáº¿'         : ['bunbo','che','comhen'],
  'Cáº§n ThÆ¡'     : ['laumam','calocnuongtrui','vitnauchao'],
  'Há»“ ChÃ­ Minh' : ['comtam','banhmi','phalau']
};

// ===== parsing =====
function parseBudgetVND(text){
  const t = rmAcc(text).replace(/\s/g,'');
  const mRange = t.match(/(\d{2,4})-?(\d{2,4})k/);
  if(mRange) return {min:+mRange[1]*1000, max:+mRange[2]*1000};
  return null;
}
function parseTime(text){
  const t = rmAcc(text);
  const today = new Date().getDay();
  let dow=today, minuteOfDay=null;
  const m = t.match(/(\d{1,2})(?:h|:)(\d{0,2})?/);
  if(m){ minuteOfDay=(+m[1])*60 + (m[2]?+m[2]:0); }
  else if(t.includes('sang')) minuteOfDay=8*60;
  else if(t.includes('trua')) minuteOfDay=12*60;
  else if(t.includes('chieu')) minuteOfDay=17*60;
  else if(t.includes('toi')) minuteOfDay=19*60;
  return {dow, minuteOfDay};
}
function parseCity(text){
  const t = rmAcc(text);
  if(/ha noi|hanoi|hn/.test(t)) return 'HÃ  Ná»™i';
  if(/hai phong|haiphong|hp/.test(t)) return 'Háº£i PhÃ²ng';
  if(/da nang|danang|dn/.test(t)) return 'ÄÃ  Náºµng';
  if(/hue/.test(t)) return 'Huáº¿';
  if(/can tho|cantho|ct/.test(t)) return 'Cáº§n ThÆ¡';
  if(/ho chi minh|tphcm|hcm|sai gon|saigon/.test(t)) return 'Há»“ ChÃ­ Minh';
  return null;
}
function parseDish(text){
  const t = rmAcc(text);
  if(t.includes('pho')) return 'pho';
  if(t.includes('bun cha')) return 'buncha';
  if(t.includes('cha ca')) return 'chaca';
  if(t.includes('nem cua')) return 'nemcuabe';
  if(t.includes('nem chua')) return 'nemchua';
  if(t.includes('bun ca cay')) return 'buncacay';
  if(t.includes('mi quang')) return 'miquang';
  if(t.includes('banh trang thit heo')) return 'banhtrangthitheo';
  if(t.includes('cao lau')) return 'caolau';
  if(t.includes('bun bo')) return 'bunbo';
  if(t.includes('che')) return 'che';
  if(t.includes('com hen')) return 'comhen';
  if(t.includes('com tam')) return 'comtam';
  if(t.includes('banh mi')) return 'banhmi';
  if(t.includes('pha lau')) return 'phalau';
  if(t.includes('lau mam')) return 'laumam';
  if(t.includes('ca loc nuong')||t.includes('nuong trui')) return 'calocnuongtrui';
  if(t.includes('vit nau chao')) return 'vitnauchao';
  return null;
}
function parseArea(text){
  const known = ['hoan kiem','pho co','dong da','hai ba trung','ba dinh','tay ho','hai chau','son tra','vinh ninh','phu cat','ninh kieu','go vap','quan 1','quan 3','quan 10','phu nhuan'];
  const t = rmAcc(text);
  for(const k of known){ if(t.includes(k)) return k; }
  return null;
}
function isUnknownDish(text){
  const t = rmAcc(text);
  return /(chua biet|khong biet|k biet|ko biet|chua ro|goi y|tu van|mon nao cung duoc)/.test(t);
}

// ===== ranking / match =====
function isOpenAt(place, dow, minuteOfDay){
  if(minuteOfDay==null) return true;
  const segs = place.hours?.[dow] || place.hours?.[0] || [];
  return segs.some(([from,to])=>{
    const [fh,fm]=from.split(':').map(Number), [th,tm]=to.split(':').map(Number);
    const f = fh*60+fm, e = th*60+tm;
    return minuteOfDay>=f && minuteOfDay<=e;
  });
}
function budgetOk(place, budget){
  if(!budget) return true;
  const lo = place.price_min||0, hi = place.price_max||1e9;
  return !(hi < budget.min || lo > budget.max);
}
function formatPrice(p){
  if(!p) return 'Tham kháº£o táº¡i quÃ¡n';
  if(p.price_min && p.price_max && p.price_min===p.price_max) return (p.price_min/1000|0)+'k';
  if(p.price_min && p.price_max) return (p.price_min/1000|0)+'â€“'+(p.price_max/1000|0)+'k';
  if(p.price_min) return 'tá»« '+(p.price_min/1000|0)+'k';
  return 'Tham kháº£o';
}
function formatHours(h){
  const segs = (h && (h[new Date().getDay()]||h[0])) || [];
  if(!segs.length) return 'Giá» tham kháº£o';
  return segs.map(([f,t])=>`${f}â€“${t}`).join(', ');
}
function searchPlaces(city, dish, filtersText=''){
  const budget = parseBudgetVND(filtersText);
  const {dow, minuteOfDay} = parseTime(filtersText);
  return PLACES.filter(p => (!city || p.city===city) && (!dish || p.dish===dish))
    .map(p=>{
      let score = 0;
      if(dish && p.dish===dish) score += 3;
      if(isOpenAt(p, dow, minuteOfDay)) score += 1;
      if(budgetOk(p, budget)) score += 1;
      return {p, score};
    })
    .sort((a,b)=>b.score-a.score)
    .slice(0,3)
    .map(x=>x.p);
}

// ===== UI builders =====
function placeCards(title, places){
  return `
    <div><strong>${title}</strong></div>
    <div class="mini-grid">
      ${places.map(p=>`
        <div class="mini">
          <h4>${p.name}</h4>
          <p>ğŸ“ ${p.area}<br>ğŸ—ºï¸ ${p.address}<br>ğŸ•’ ${formatHours(p.hours)}<br>ğŸ’¸ ${formatPrice(p)}</p>
          <p style="margin-top:6px">${p.why||''}</p>
        </div>`).join('')}
    </div>
    <p class="small">ğŸ’¡ Tip: GÃµ â€œmÃ³n + thÃ nh phá»‘ + thá»i gian + ngÃ¢n sÃ¡châ€. VÃ­ dá»¥: â€œbÃºn cháº£ HoÃ n Kiáº¿m trÆ°a nay 40â€“50kâ€.</p>`;
}
function dishSuggestCards(city){
  const dishes = CITY_SIGNATURES[city] || [];
  const picks = dishes.map(d=>{
    const one = searchPlaces(city, d)[0];
    return {dish:d, sample:one};
  }).filter(x=>x.sample);
  const html = `
    <div><strong>MÃ³n ná»•i báº­t á»Ÿ ${city}</strong></div>
    <div class="mini-grid">
      ${picks.map(x=>`
        <div class="mini">
          <h4>${DISH_LABELS[x.dish]}</h4>
          <p>VÃ­ dá»¥: <b>${x.sample.name}</b> â€” ${formatPrice(x.sample)}</p>
          <button class="btn" data-choose="${x.dish}">Chá»n mÃ³n nÃ y</button>
        </div>`).join('')}
    </div>
    <p class="small">Báº¡n cÃ³ thá»ƒ báº¥m chá»n hoáº·c gÃµ mÃ³n khÃ¡c tuá»³ thÃ­ch.</p>`;
  const el = addBubble(html,'bot');
  // attach handlers
  el.querySelectorAll('[data-choose]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const d = b.getAttribute('data-choose');
      STATE.dish = d; STATE.askDishPending=false;
      showResultsForCityDish(STATE.city, d);
    });
  });
  return el;
}
function showResultsForCityDish(city, dish, extras=''){
  const res = searchPlaces(city, dish, extras);
  if(!res.length){ addBubble('ChÆ°a tháº¥y quÃ¡n khá»›p. Báº¡n thá»­ mÃ³n khÃ¡c hoáº·c ná»›i ngÃ¢n sÃ¡ch nhÃ©.'); return; }
  addBubble( placeCards(`${DISH_LABELS[dish]} á»Ÿ ${city}: gá»£i Ã½ há»£p gu`, res) );
  resetState();
}

// ===== conversation (listen-first + há»i "Ä‘Ã£ dá»± Ä‘á»‹nh chÆ°a?") =====
function isGreeting(s){ return /(hi|hello|xin chao|chao|chao ban)/i.test(rmAcc(s)); }

function ask(msg){
  const userText = msg.trim();
  if(!userText) return;
  addBubble(esc(userText),'user');

  // greeting -> giá»›i thiá»‡u ngáº¯n + há»i tá»•ng quÃ¡t
  if(isGreeting(userText)){
    addBubble('ChÃ o báº¡n ğŸ‘‹ MÃ¬nh lÃ  chatbot gá»£i Ã½ quÃ¡n Äƒn theo <b>mÃ³n/khu/giá»/ngÃ¢n sÃ¡ch</b> táº¡i HN, HP, ÄN, Huáº¿, CT, HCM. Báº¡n Ä‘ang á»Ÿ <b>thÃ nh phá»‘/khu nÃ o</b> vÃ  <b>Ä‘Ã£ dá»± Ä‘á»‹nh Äƒn mÃ³n gÃ¬ chÆ°a</b>?');
    return;
  }

  // parse & fill slots
  const detectedCity = parseCity(userText);
  const detectedDish = parseDish(userText);
  if(detectedCity) STATE.city = detectedCity;
  if(detectedDish) { STATE.dish = detectedDish; STATE.askDishPending=false; }

  // Náº¿u Ä‘ang chá» tráº£ lá»i cÃ¢u "Ä‘Ã£ dá»± Ä‘á»‹nh mÃ³n gÃ¬ chÆ°a?"
  if(STATE.askDishPending){
    if(detectedDish){
      showResultsForCityDish(STATE.city, STATE.dish, userText);
      return;
    }
    if(isUnknownDish(userText)){
      STATE.askDishPending = false;
      dishSuggestCards(STATE.city);
      return;
    }
    addBubble('Báº¡n Ä‘Ã£ cÃ³ mÃ³n dá»± Ä‘á»‹nh chÆ°a? Náº¿u <b>cÃ³</b> hÃ£y gÃµ tÃªn mÃ³n (vd: bÃºn cháº£). Náº¿u <b>chÆ°a</b>, gÃµ "chÆ°a biáº¿t" Ä‘á»ƒ mÃ¬nh gá»£i Ã½ mÃ³n Ä‘áº·c trÆ°ng.', 'bot');
    return;
  }

  // náº¿u cÃ³ city nhÆ°ng chÆ°a dish -> Há»I trÆ°á»›c: Ä‘Ã£ dá»± Ä‘á»‹nh mÃ³n gÃ¬ chÆ°a?
  if(STATE.city && !STATE.dish){
    STATE.askDishPending = true;
    addBubble(`Báº¡n Ä‘ang á»Ÿ <b>${STATE.city}</b>. Báº¡n <b>Ä‘Ã£ dá»± Ä‘á»‹nh Äƒn mÃ³n gÃ¬ chÆ°a</b>? (CÃ³: gÃµ tÃªn mÃ³n â€¢ ChÆ°a: gÃµ "chÆ°a biáº¿t" Ä‘á»ƒ mÃ¬nh gá»£i Ã½)`);
    return;
  }

  // náº¿u Ä‘á»§ city + dish -> show quÃ¡n
  if(STATE.city && STATE.dish){
    showResultsForCityDish(STATE.city, STATE.dish, userText);
    return;
  }

  // thiáº¿u cáº£ hai -> há»i gá»n
  if(!STATE.city && !STATE.dish){
    addBubble('Báº¡n Ä‘ang á»Ÿ <b>thÃ nh phá»‘ nÃ o</b> (HN/HP/ÄN/Huáº¿/CT/HCM) vÃ  <b>Ä‘Ã£ dá»± Ä‘á»‹nh Äƒn mÃ³n gÃ¬ chÆ°a</b>?');
    return;
  }

  // cÃ³ dish nhÆ°ng chÆ°a city
  if(!STATE.city && STATE.dish){
    addBubble(`Báº¡n muá»‘n Äƒn <b>${DISH_LABELS[STATE.dish]||STATE.dish}</b>, váº­y báº¡n Ä‘ang á»Ÿ <b>thÃ nh phá»‘ nÃ o</b>? (HN/HP/ÄN/Huáº¿/CT/HCM)`);
    return;
  }
}

// ===== events =====
btn.addEventListener('click', ()=>{ if(q.value.trim()){ ask(q.value); q.value=''; }});
q.addEventListener('keydown', e=>{ if(e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); btn.click(); }});

// âŒ KhÃ´ng auto chÃ o khi má»Ÿ â€” bot chá»‰ láº¯ng nghe.
</script>
</body>
</html>
